<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Report Studio v9.2 - ç·šæ¢ä¿®å¾©ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --surface: #1e293b; --surface2: #334155; --border: #475569; --text: #e2e8f0; --success: #10b981; --danger: #ef4444; --guide: #0ea5e9; }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        
        /* Header & Layout */
        .header { height: 60px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; z-index: 200; }
        .title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; color: white; }
        .toolbar { display: flex; gap: 8px; }
        .main-layout { flex: 1; display: flex; overflow: hidden; }
        .left-panel, .right-panel { width: 300px; background: var(--surface); display: flex; flex-direction: column; z-index: 100; border-color: var(--border); }
        .left-panel { border-right: 1px solid var(--border); }
        .right-panel { border-left: 1px solid var(--border); }

        /* Tabs */
        .tab-nav { display: flex; background: var(--surface2); border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px 0; text-align: center; cursor: pointer; color: #94a3b8; font-size: 13px; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: white; background: rgba(99,102,241,0.1); border-bottom-color: var(--primary); }
        .tab-content { flex: 1; overflow-y: auto; padding: 16px; display: none; }
        .tab-content.active { display: block; }

        /* Components */
        .btn { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 13px; background: var(--surface2); color: var(--text); display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition:0.2s; }
        .btn:hover { background: #475569; }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-danger { background: var(--danger); color: white; border: none; }
        .btn-block { width: 100%; }
        .form-group { margin-bottom: 12px; }
        .form-label { font-size: 12px; color: #94a3b8; margin-bottom: 4px; display: block; }
        .form-control { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 13px; }

        /* Canvas */
        .center-panel { flex: 1; background: #0f172a; display: flex; justify-content: center; overflow: auto; padding: 40px; position: relative; }
        .canvas { background-color: white; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform-origin: top center; background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
        
        .canvas-element { 
            position: absolute; cursor: move; display: flex; align-items: center; box-sizing: border-box; overflow: hidden; 
            -webkit-print-color-adjust: exact; print-color-adjust: exact; /* å¼·åˆ¶åˆ—å°èƒŒæ™¯è‰² */
        }
        .canvas-element:hover { outline: 1px dashed var(--primary); }
        .canvas-element.selected { outline: 2px solid var(--primary); }
        .canvas-element-value { width: 100%; pointer-events: none; overflow: hidden; white-space: nowrap; }

        .resize-handle { position: absolute; width: 8px; height: 8px; background: white; border: 1px solid var(--primary); border-radius: 50%; display: none; }
        .selected .resize-handle { display: block; }
        .rh-se { bottom: -4px; right: -4px; cursor: se-resize; }

        /* Helpers */
        .guide-line { position: absolute; background: var(--guide); pointer-events: none; z-index: 9999; display: none; }
        .guide-x { width: 100%; height: 1px; border-top: 1px dashed var(--guide); }
        .guide-y { height: 100%; width: 1px; border-left: 1px dashed var(--guide); }
        
        .floating-toolbar { position: absolute; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 4px; display: none; gap: 4px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .floating-toolbar.show { display: flex; }

        .table-element { display: block !important; border: none !important; }
        .drop-zone { transition: 0.2s; }
        #splitLine { position: absolute; left: 0; width: 100%; border-top: 2px dashed var(--danger); z-index: 9000; display: none; cursor: ns-resize; }
        #splitLine::after { content: "åˆ†çµ„/åˆ†é ç·š"; position: absolute; right: 0; top: -20px; background: var(--danger); color: white; padding: 2px 5px; font-size: 10px; border-radius: 3px; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; }
        .modal { background: var(--surface); padding: 20px; border-radius: 8px; width: 300px; border: 1px solid var(--border); }

        #print-container { display: none; }
        @media print {
            @page { margin: 0; }
            body * { visibility: hidden; }
            #print-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; visibility: visible; }
            #print-container * { visibility: visible; }
            .print-page { page-break-after: always; position: relative; overflow: hidden; background: white; }
            .print-element { position: absolute; display: flex; align-items: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title"><span class="material-symbols-outlined">auto_fix_high</span> Pro Report v9.2</div>
        <div class="toolbar">
            <button class="btn" onclick="undo()" title="Ctrl+Z">â†© å¾©åŸ</button>
            <button class="btn" onclick="saveProject()">ğŸ’¾ å­˜æª”</button>
            <button class="btn" onclick="loadProject()">ğŸ“‚ è®€æª”</button>
            <input type="file" id="f-proj" hidden accept=".prs" onchange="readProject(this)">
            <div style="width:1px;background:var(--border);height:20px;margin:0 5px"></div>
            <button class="btn btn-primary" onclick="printDoc()">ğŸ–¨ åˆ—å° / PDF</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="left-panel">
            <div class="tab-nav">
                <div class="tab-btn active" onclick="swTab(this, 't1')">å…ƒä»¶</div>
                <div class="tab-btn" onclick="swTab(this, 't2')">è³‡æ–™/åº•åœ–</div>
                <div class="tab-btn" onclick="swTab(this, 't3')">ç¯„ä¾‹</div>
            </div>
            
            <div id="t1" class="tab-content active">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:15px">
                    <button class="btn" onclick="addEl('text','æ–‡å­—æ¨™ç±¤')"><span class="material-symbols-outlined">text_fields</span> æ–‡å­—</button>
                    <button class="btn" onclick="addEl('title','æ¨™é¡Œ',null,null,200,30,20,'bold')"><span class="material-symbols-outlined">title</span> æ¨™é¡Œ</button>
                    <!-- ä¿®æ­£ï¼šçŸ©å½¢ã€æ©«ç·šã€ç›´ç·šå…¨éƒ¨æ”¹ç”¨ Border (æ›´ç©©å®š) -->
                    <button class="btn" onclick="addEl('text','',50,50,100,100,12,'normal','transparent','2px solid #000000')"><span class="material-symbols-outlined">check_box_outline_blank</span> çŸ©å½¢</button>
                    <button class="btn" onclick="addEl('text','',50,50,200,0,12,'normal','transparent','2px solid #000000')"><span class="material-symbols-outlined">horizontal_rule</span> æ©«ç·š</button>
                    <button class="btn" onclick="addEl('text','',50,50,0,200,12,'normal','transparent','2px solid #000000')"><span class="material-symbols-outlined">vertical_shades</span> ç›´ç·š</button>
                    <button class="btn" onclick="addEl('qrcode','QR',50,50,50,50)"><span class="material-symbols-outlined">qr_code</span> QR Code</button>
                </div>
                <button class="btn btn-block" onclick="el('modal-tbl').style.display='flex'"><span class="material-symbols-outlined">table_chart</span> æ’å…¥è¡¨æ ¼</button>
            </div>
            
            <div id="t2" class="tab-content">
                <div style="border-bottom:1px solid var(--border);padding-bottom:15px;margin-bottom:15px">
                    <label class="form-label" style="color:var(--primary);font-weight:bold">ğŸ“„ PDF åº•åœ–æåœ–</label>
                    <button class="btn btn-block" onclick="el('f-pdf').click()"><span class="material-symbols-outlined">upload_file</span> ä¸Šå‚³ PDF</button>
                    <input type="file" id="f-pdf" hidden accept=".pdf" onchange="loadPdfBg(this)">
                    <div id="bg-ctrl" style="display:none;margin-top:10px">
                        <label class="form-label">é€æ˜åº¦</label>
                        <input type="range" min="0" max="100" value="0" class="form-control" oninput="updBgOp(this.value)">
                        <button class="btn btn-danger btn-block btn-sm" style="margin-top:5px" onclick="clrBg()">æ¸…é™¤åº•åœ–</button>
                    </div>
                </div>
                <label class="form-label" style="color:var(--success);font-weight:bold">ğŸ“Š è³‡æ–™ä¾†æº</label>
                <button class="btn btn-block" onclick="el('f-csv').click()">åŒ¯å…¥ CSV/JSON</button>
                <input type="file" id="f-csv" hidden onchange="loadData(this)">
                <div id="field-list" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:5px"></div>
            </div>
            
            <div id="t3" class="tab-content">
                <button class="btn btn-block" style="margin-bottom:8px" onclick="loadDemo('invoice')">ğŸ§¾ ä¸‰è¯å¼ç™¼ç¥¨ (Group)</button>
                <button class="btn btn-block" style="margin-bottom:8px" onclick="loadDemo('label')">ğŸ·ï¸ æ¨™ç±¤è²¼ç´™ (Grid)</button>
                <button class="btn btn-block" onclick="loadDemo('ship')">ğŸšš å‡ºè²¨å–® (Group)</button>
            </div>
        </div>

        <div class="center-panel" id="canvas-wrap">
            <div class="canvas" id="canvas">
                <div id="splitLine"></div>
                <div id="guideX" class="guide-line guide-x"></div>
                <div id="guideY" class="guide-line guide-y"></div>
            </div>
            <div class="floating-toolbar" id="floatBar">
                <button class="btn btn-sm" onclick="dupEl()" title="è¤‡è£½"><span class="material-symbols-outlined">content_copy</span></button>
                <button class="btn btn-sm" onclick="zOrder(1)" title="ç§»è‡³æœ€ä¸Šå±¤ (Bring to Front)"><span class="material-symbols-outlined">flip_to_front</span></button>
                <button class="btn btn-sm" onclick="zOrder(-1)" title="ç§»è‡³æœ€ä¸‹å±¤ (Send to Back)"><span class="material-symbols-outlined">flip_to_back</span></button>
                <button class="btn btn-sm btn-danger" onclick="delEl()" title="åˆªé™¤"><span class="material-symbols-outlined">delete</span></button>
            </div>
        </div>

        <div class="right-panel">
            <div style="padding:10px;border-bottom:1px solid var(--border);font-weight:bold">å±¬æ€§è¨­å®š</div>
            <div id="props" style="padding:15px"></div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-tbl">
        <div class="modal">
            <h3>æ’å…¥è¡¨æ ¼</h3>
            <div class="form-group" style="margin-top:15px"><label>æ¬„ä½æ•¸é‡</label><input type="number" id="tbl-cols" value="4" class="form-control"></div>
            <div style="display:flex;gap:10px;margin-top:20px">
                <button class="btn btn-block" onclick="el('modal-tbl').style.display='none'">å–æ¶ˆ</button>
                <button class="btn btn-primary btn-block" onclick="addTable()">æ’å…¥</button>
            </div>
        </div>
    </div>
    
    <div id="print-container"></div>

    <script>
        const el = id => document.getElementById(id);
        const state = { 
            els: [], data: [], fields: [], sel: null, 
            cfg: { size: 'a4', orient: 'portrait', w: 210, h: 297, mode: 'single', splitY: 150, offX:0, offY:0, gC:2, gR:4, gX:5, gY:5 },
            bgUrl: null 
        };
        const history = [];

        window.onload = () => {
            initCanvas();
            renderProps();
            saveState();
            
            document.addEventListener('keydown', e => {
                if((e.ctrlKey||e.metaKey)&&e.key==='z') { e.preventDefault(); undo(); }
                if(e.key==='Delete'&&state.sel) delEl();
                if(state.sel && ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                    const i = state.els.find(x=>x.id===state.sel);
                    if(i) {
                        const d = e.shiftKey?10:1;
                        if(e.key.includes('Left')) i.x-=d; if(e.key.includes('Right')) i.x+=d;
                        if(e.key.includes('Up')) i.y-=d; if(e.key.includes('Down')) i.y+=d;
                        render(); renderProps(i);
                    }
                }
            });
        };

        function initCanvas() {
            updCanvasSz();
            el('canvas-wrap').onmousedown = e => {
                if(e.target.id==='canvas-wrap'||e.target.id==='canvas') { state.sel=null; render(); }
            };
            const spl = el('splitLine');
            spl.onmousedown = e => {
                e.preventDefault(); const sy=e.clientY, st=state.cfg.splitY;
                const mv=ev=>{ state.cfg.splitY=Math.max(0,st+(ev.clientY-sy)); spl.style.top=state.cfg.splitY+'px'; };
                const up=()=>{ document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',up); };
                document.addEventListener('mousemove',mv); document.addEventListener('mouseup',up);
            };
        }
        function updCanvasSz() {
            const m = {'a4':[210,297], 'a5':[148,210], 'receipt80':[80,297]};
            let [w,h] = m[state.cfg.size] || [state.cfg.w, state.cfg.h];
            if(state.cfg.orient==='landscape' && state.cfg.size!=='receipt80') [w,h]=[h,w];
            state.cfg.w=w; state.cfg.h=h;
            el('canvas').style.width=w+'mm'; el('canvas').style.height=(state.cfg.size==='receipt80'?'auto':h+'mm');
            el('canvas').style.minHeight=(state.cfg.size==='receipt80'?'150mm':'0');
        }

        // --- History ---
        function saveState() {
            if(history.length>20) history.shift();
            history.push(JSON.stringify({els:state.els, cfg:state.cfg}));
        }
        function undo() {
            if(history.length>1) {
                history.pop(); const p=JSON.parse(history[history.length-1]);
                state.els=p.els; state.cfg=p.cfg; state.sel=null;
                render(); renderProps(); updCanvasSz();
            }
        }

        // --- Core Logic ---
        function addEl(type, txt, x=20, y=20, w=100, h=30, fs=12, fw='normal', bg='transparent', br='none') {
            const id = Math.random().toString(36).substr(2,9);
            const item = { id, type, txt, x, y, w, h, fs, fw, bg, br, color:'#000000', align:'left' };
            if(type==='field') item.field=txt;
            state.els.push(item); state.sel=id; render(); saveState();
        }

        function render() {
            const c = el('canvas');
            const spl = el('splitLine');
            const gx = el('guideX'), gy = el('guideY');
            c.innerHTML=''; c.appendChild(spl); c.appendChild(gx); c.appendChild(gy);
            
            spl.style.display = state.cfg.mode==='group'?'block':'none';
            spl.style.top = state.cfg.splitY+'px';

            state.els.forEach((item, idx) => {
                if(item.type==='table') renderTable(item, idx);
                else renderItem(item, idx);
            });

            const bar = el('floatBar');
            if(state.sel) {
                const s = state.els.find(x=>x.id===state.sel);
                if(s) {
                    bar.style.display='flex';
                    bar.style.top = (s.y + state.cfg.offY - 50) + 'px';
                    bar.style.left = (s.x + state.cfg.offX) + 'px';
                    renderProps(s); return;
                }
            }
            bar.style.display='none'; renderProps(null);
        }

        function renderItem(item, idx) {
            const d = document.createElement('div');
            d.className = 'canvas-element ' + (state.sel===item.id?'selected':'');
            d.style.left = (item.x+state.cfg.offX)+'px'; d.style.top = (item.y+state.cfg.offY)+'px';
            d.style.width = item.w+'px'; d.style.height = item.h+'px';
            d.style.zIndex = idx+1; 
            d.style.background = item.bg; d.style.border = item.br;
            if(item.br==='none' && state.sel===item.id) d.style.border='1px dashed #ccc';
            
            d.style.color = item.color; d.style.fontSize = item.fs+'px'; d.style.fontWeight = item.fw;
            const txt = item.type==='field' ? `[${item.txt}]` : item.txt;
            d.innerHTML = `<div class="canvas-element-value" style="text-align:${item.align}">${txt}</div>`;
            
            if(state.sel===item.id) {
                const rh = document.createElement('div'); rh.className='resize-handle rh-se';
                rh.onmousedown = e => { e.stopPropagation(); drag(e, item, 'resize'); };
                d.appendChild(rh);
            }
            d.onmousedown = e => { e.stopPropagation(); state.sel=item.id; render(); drag(e, item, 'move'); };
            el('canvas').appendChild(d);
        }

        function renderTable(item, idx) {
            const tw = item.colW.reduce((a,b)=>a+b,0);
            const th = item.headH + item.rowH;
            const d = document.createElement('div');
            d.className = 'canvas-element table-element ' + (state.sel===item.id?'selected':'');
            d.style.left=(item.x+state.cfg.offX)+'px'; d.style.top=(item.y+state.cfg.offY)+'px';
            d.style.width=tw+'px'; d.style.height=th+'px'; d.style.zIndex=idx+1;

            let h = `<div style="display:flex;height:${item.headH}px">`;
            item.cols.forEach((c,i)=> h+=`<div style="width:${item.colW[i]}px;border:1px solid #000000;background:#eee;padding:2px;font-size:12px;overflow:hidden">${c}</div>`);
            h += `</div><div style="display:flex;height:${item.rowH}px">`;
            item.fields.forEach((f,i)=> h+=`<div class="drop-zone" data-id="${item.id}" data-idx="${i}" style="width:${item.colW[i]}px;border:1px solid #ccc;padding:2px;font-size:12px;background:rgba(255,255,255,0.8)">[${f||''}]</div>`);
            h += `</div>`;
            d.innerHTML = h;

            d.onmousedown = e => { e.stopPropagation(); state.sel=item.id; render(); drag(e, item, 'move'); };
            d.querySelectorAll('.drop-zone').forEach(z => {
                z.ondragover=e=>e.preventDefault();
                z.ondrop=e=>{
                    e.preventDefault(); e.stopPropagation();
                    const f=e.dataTransfer.getData('f');
                    if(f) { item.fields[z.dataset.idx]=f; render(); saveState(); }
                }
            });
            el('canvas').appendChild(d);
        }

        // --- Drag & Snap ---
        function drag(e, item, mode) {
            const sx=e.clientX, sy=e.clientY, ox=item.x, oy=item.y, ow=item.w, oh=item.h;
            const gx=el('guideX'), gy=el('guideY');
            
            const mv = ev => {
                const dx=ev.clientX-sx, dy=ev.clientY-sy;
                if(mode==='move') {
                    let nx=ox+dx, ny=oy+dy;
                    let snapX=null, snapY=null;
                    state.els.forEach(o => {
                        if(o.id===item.id) return;
                        if(Math.abs(nx-o.x)<5) { nx=o.x; snapY=o.x; }
                        else if(Math.abs(nx-(o.x+o.w))<5) { nx=o.x+o.w; snapY=o.x+o.w; }
                        if(Math.abs(ny-o.y)<5) { ny=o.y; snapX=o.y; }
                        else if(Math.abs(ny-(o.y+o.h))<5) { ny=o.y+o.h; snapX=o.y+o.h; }
                    });
                    item.x=nx; item.y=ny;
                    gx.style.display=snapX!==null?'block':'none'; if(snapX) gx.style.top=(snapX+state.cfg.offY)+'px';
                    gy.style.display=snapY!==null?'block':'none'; if(snapY) gy.style.left=(snapY+state.cfg.offX)+'px';
                } else {
                    item.w=Math.max(0,ow+dx); item.h=Math.max(0,oh+dy);
                }
                render();
            };
            const up = () => {
                document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',up);
                gx.style.display='none'; gy.style.display='none'; saveState();
            };
            document.addEventListener('mousemove',mv); document.addEventListener('mouseup',up);
        }

        // --- Props ---
        function renderProps(item) {
            const p = el('props');
            if(!item) {
                p.innerHTML=`
                <div class="form-group"><label class="form-label">ç´™å¼µ</label><select class="form-control" onchange="state.cfg.size=this.value;updCanvasSz();saveState()"><option value="a4">A4</option><option value="receipt80">80mm</option></select></div>
                <div class="form-group"><label class="form-label">æ–¹å‘</label><select class="form-control" onchange="state.cfg.orient=this.value;updCanvasSz();saveState()"><option value="portrait">ç›´å‘</option><option value="landscape">æ©«å‘</option></select></div>
                <div class="form-group"><label class="form-label">æ¨¡å¼</label><select class="form-control" onchange="state.cfg.mode=this.value;render();saveState()"><option value="single">å–®é </option><option value="group">æ¸…å–®(Group)</option><option value="grid">æ¨™ç±¤(Grid)</option></select></div>
                ${state.cfg.mode==='grid'?`<div style="padding:10px;background:#f0f9ff;border-radius:4px;margin-bottom:10px">
                    <label class="form-label">Grid (æ¬„ x åˆ—)</label><div style="display:flex;gap:5px"><input class="form-control" type="number" value="${state.cfg.gC}" onchange="state.cfg.gC=+this.value;saveState()"><input class="form-control" type="number" value="${state.cfg.gR}" onchange="state.cfg.gR=+this.value;saveState()"></div>
                    <label class="form-label">é–“è· X/Y</label><div style="display:flex;gap:5px"><input class="form-control" type="number" value="${state.cfg.gX}" onchange="state.cfg.gX=+this.value;saveState()"><input class="form-control" type="number" value="${state.cfg.gY}" onchange="state.cfg.gY=+this.value;saveState()"></div>
                </div>`:''}
                <div class="form-group"><label class="form-label">å…¨åŸŸåç§» X/Y</label><div style="display:flex;gap:5px"><input class="form-control" type="number" value="${state.cfg.offX}" onchange="state.cfg.offX=+this.value;render();saveState()"><input class="form-control" type="number" value="${state.cfg.offY}" onchange="state.cfg.offY=+this.value;render();saveState()"></div></div>`;
                return;
            }
            if(item.type!=='table') {
                p.innerHTML=`
                <div class="form-group"><label class="form-label">å…§å®¹</label><input class="form-control" value="${item.txt}" oninput="upd('${item.id}','txt',this.value)"></div>
                <div class="form-group"><label class="form-label">å­—é«”</label><input type="number" class="form-control" value="${item.fs}" oninput="upd('${item.id}','fs',+this.value)"></div>
                <div class="form-group"><label class="form-label">æ–‡å­—é¡è‰²</label><input type="color" class="form-control" value="${item.color}" oninput="upd('${item.id}','color',this.value)"></div>
                <div class="form-group"><label class="form-label">èƒŒæ™¯è‰²</label><input type="color" class="form-control" value="${item.bg==='transparent'?'#ffffff':item.bg}" oninput="upd('${item.id}','bg',this.value)"></div>
                <div class="form-group"><label class="form-label">å°é½Š</label><select class="form-control" onchange="upd('${item.id}','align',this.value)"><option value="left" ${item.align=='left'?'selected':''}>å·¦</option><option value="center" ${item.align=='center'?'selected':''}>ä¸­</option><option value="right" ${item.align=='right'?'selected':''}>å³</option></select></div>
                <div class="form-group"><label class="form-label">X / Y</label><div style="display:flex;gap:5px"><input type="number" class="form-control" value="${item.x}" onchange="upd('${item.id}','x',+this.value)"><input type="number" class="form-control" value="${item.y}" onchange="upd('${item.id}','y',+this.value)"></div></div>
                <div class="form-group"><label class="form-label">å¯¬ / é«˜</label><div style="display:flex;gap:5px"><input type="number" class="form-control" value="${item.w}" onchange="upd('${item.id}','w',+this.value)"><input type="number" class="form-control" value="${item.h}" onchange="upd('${item.id}','h',+this.value)"></div></div>
                `;
            } else {
                p.innerHTML=`<div>è¡¨æ ¼è¨­å®š</div>`;
                item.cols.forEach((c,i)=> p.innerHTML+=`<div style="margin-top:5px"><input class="form-control" value="${c}" oninput="updTbl('${item.id}',${i},this.value)"></div>`);
            }
        }
        window.upd=(id,k,v)=>{ state.els.find(x=>x.id===id)[k]=v; render(); };
        window.updTbl=(id,i,v)=>{ state.els.find(x=>x.id===id).cols[i]=v; render(); };

        // --- Functions ---
        function zOrder(d) {
            const i=state.els.findIndex(x=>x.id===state.sel);
            if(i<0)return;
            const el=state.els.splice(i,1)[0];
            d===1?state.els.push(el):state.els.unshift(el);
            render(); saveState();
        }
        function dupEl() {
            const o=state.els.find(x=>x.id===state.sel);
            if(o) { const n=JSON.parse(JSON.stringify(o)); n.id=Math.random().toString(36); n.x+=10; n.y+=10; state.els.push(n); state.sel=n.id; render(); saveState(); }
        }
        function delEl() { state.els=state.els.filter(x=>x.id!==state.sel); state.sel=null; render(); saveState(); }
        function swTab(b,t) { document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active')); b.classList.add('active'); el(t).classList.add('active'); }
        
        function addTable() {
            const n=+el('tbl-cols').value;
            const item={ id:Math.random().toString(), type:'table', x:20, y:60, w:0, h:0, cols:Array(n).fill('').map((_,i)=>'H'+(i+1)), fields:Array(n).fill(''), colW:Array(n).fill(60), headH:30, rowH:30 };
            state.els.push(item); state.cfg.mode='group'; state.sel=item.id;
            el('modal-tbl').style.display='none'; render(); saveState();
        }

        // --- PDF BG ---
        async function loadPdfBg(i) {
            const f=i.files[0]; if(!f)return;
            const buf=await f.arrayBuffer();
            const pdf=await pdfjsLib.getDocument(buf).promise;
            const page=await pdf.getPage(1);
            const vp=page.getViewport({scale:2.0});
            const c=document.createElement('canvas'); c.width=vp.width; c.height=vp.height;
            await page.render({canvasContext:c.getContext('2d'), viewport:vp}).promise;
            state.bgUrl=c.toDataURL();
            updBgOp(50); el('bg-ctrl').style.display='block';
        }
        function updBgOp(v) {
            if(!state.bgUrl)return;
            const a=v/100, ov=`linear-gradient(rgba(255,255,255,${a}),rgba(255,255,255,${a}))`;
            el('canvas').style.backgroundImage=`${ov}, url(${state.bgUrl})`;
            el('canvas').style.backgroundSize='100% 100%';
        }
        function clrBg() { state.bgUrl=null; el('canvas').style.backgroundImage='linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px)'; el('canvas').style.backgroundSize='20px 20px'; el('bg-ctrl').style.display='none'; el('f-pdf').value=''; }

        // --- Data & File ---
        function loadData(i) {
            const f=i.files[0], r=new FileReader();
            r.onload=e=>{
                const rows=e.target.result.trim().split('\n'), h=rows[0].split(',').map(s=>s.trim());
                state.data=rows.slice(1).map(x=>{ const v=x.split(','); return h.reduce((a,k,j)=>({...a,[k]:v[j]?.trim()}),{}); });
                state.fields=h; renderFields(); alert(`å·²è¼‰å…¥ ${state.data.length} ç­†`);
            };
            r.readAsText(f);
        }
        function renderFields() {
            const d=el('field-list'); d.innerHTML='';
            state.fields.forEach(f=>{
                const b=document.createElement('div'); b.innerText=f; b.style.cssText='padding:5px;border:1px solid #ccc;cursor:grab;background:#fff;border-radius:4px;font-size:12px'; b.draggable=true;
                b.ondragstart=e=>{e.dataTransfer.setData('type','field');e.dataTransfer.setData('f',f);};
                d.appendChild(b);
            });
        }
        el('canvas-wrap').ondragover=e=>e.preventDefault();
        el('canvas-wrap').ondrop=e=>{
            e.preventDefault(); const t=e.dataTransfer.getData('type');
            if(t==='field') {
                const f=e.dataTransfer.getData('f'), r=el('canvas').getBoundingClientRect();
                addEl('field', f, e.clientX-r.left-state.cfg.offX, e.clientY-r.top-state.cfg.offY);
            }
        };

        // --- Save/Load Project ---
        function saveProject() {
            const b=new Blob([JSON.stringify({v:'9.2', ...state})],{type:'application/json'});
            const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`project-${Date.now()}.prs`; a.click();
        }
        function loadProject() { el('f-proj').click(); }
        function readProject(i) {
            const f=i.files[0], r=new FileReader();
            r.onload=e=>{
                try { const p=JSON.parse(e.target.result); state.els=p.els; state.cfg=p.cfg; state.data=p.data||[]; state.fields=p.fields||[]; render(); renderProps(); renderFields(); alert('å·²è¼‰å…¥'); } catch(err){alert('æ ¼å¼éŒ¯èª¤');}
            };
            r.readAsText(f);
        }

        // --- Demo ---
        function loadDemo(t) {
            if(!confirm('è¦†è“‹ï¼Ÿ')) return; state.els=[];
            if(t==='invoice') {
                state.cfg.mode='group'; state.cfg.splitY=160;
                addEl('text','',20,110,700,0,12,'normal','transparent','2px solid #000000');
                addEl('title','é›»å­ç™¼ç¥¨',250,40,300,30,24,'bold');
                addEl('text','æ—¥æœŸ: 2025-01-01',500,80,200,20);
                const tb={id:'t1',type:'table',x:40,y:170,cols:['å“å','æ•¸é‡','å–®åƒ¹','é‡‘é¡'],fields:['å“å','æ•¸é‡','å–®åƒ¹','é‡‘é¡'],colW:[250,80,100,100],headH:30,rowH:30};
                state.els.push(tb); state.data=[{å“å:'A',æ•¸é‡:'1',å–®åƒ¹:'10',é‡‘é¡:'10'},{å“å:'B',æ•¸é‡:'2',å–®åƒ¹:'20',é‡‘é¡:'40'}];
            } else if(t==='label') {
                state.cfg.mode='grid'; state.cfg.gC=2; state.cfg.gR=4;
                addEl('text','',10,10,300,180,12,'normal','transparent','2px solid #000000');
                addEl('field','å“å',50,50,200,30,20,'bold');
                state.data=[{å“å:'å•†å“A'},{å“å:'å•†å“B'}];
            } else if(t==='ship') {
                state.cfg.mode='group'; state.cfg.splitY=140;
                addEl('title','å‡ºè²¨å–®',20,20,200,40);
                addEl('field','å®¢æˆ¶',20,80,200,20);
                state.els.push({id:'t2',type:'table',x:20,y:150,cols:['å“å','æ•¸é‡'],fields:['å“å','æ•¸é‡'],colW:[200,80],headH:30,rowH:30});
                state.data=[{å®¢æˆ¶:'C1',å“å:'P1',æ•¸é‡:'1'}];
            }
            state.fields=Object.keys(state.data[0]); renderFields(); render(); saveState();
            swTab(document.querySelector('.tab-btn:nth-child(2)'),'t2');
        }

        // --- Print ---
        function printDoc() {
            const c=el('print-container'); c.innerHTML='';
            const css=document.createElement('style');
            css.innerHTML=`@media print{@page{margin:0} body{visibility:hidden} #print-container{visibility:visible;position:absolute;left:0;top:0} .p-pg{page-break-after:always;position:relative;height:${state.cfg.h}mm;width:${state.cfg.w}mm;overflow:hidden} .p-el{position:absolute;display:flex;align-items:center;overflow:hidden}}`;
            c.appendChild(css);

            const dt = state.data.length ? state.data : [{}];
            
            if(state.cfg.mode === 'single') {
                dt.forEach(d => {
                    const pg = document.createElement('div'); pg.className = 'p-pg';
                    state.els.forEach(e => pg.appendChild(mkEl(e, d)));
                    c.appendChild(pg);
                });
            } else if(state.cfg.mode === 'grid') {
                const {gC,gR,gX,gY} = state.cfg;
                let pg = document.createElement('div'); pg.className='p-pg';
                let idx = 0;
                let maxW=0, maxH=0; state.els.forEach(e=>{maxW=Math.max(maxW,e.x+e.w); maxH=Math.max(maxH,e.y+e.h);});
                
                dt.forEach(d => {
                    if(idx >= gC*gR) { c.appendChild(pg); pg=document.createElement('div'); pg.className='p-pg'; idx=0; }
                    const col=idx%gC, row=Math.floor(idx/gC);
                    const ox = col*(maxW+gX)+20, oy = row*(maxH+gY)+20;
                    state.els.forEach(e => {
                        const el = mkEl(e, d);
                        el.style.left = (e.x+ox+state.cfg.offX)+'px';
                        el.style.top = (e.y+oy+state.cfg.offY)+'px';
                        pg.appendChild(el);
                    });
                    idx++;
                });
                c.appendChild(pg);
            } else {
                const pg = document.createElement('div'); pg.className = 'p-pg';
                state.els.filter(e=>e.y<state.cfg.splitY).forEach(e=>pg.appendChild(mkEl(e, dt[0])));
                
                let cy = state.cfg.splitY;
                const tbl = state.els.find(e=>e.type==='table');
                
                if(tbl) {
                    const th = mkTbl(tbl, null, true);
                    th.style.top=cy+'px'; th.style.left=(tbl.x+state.cfg.offX)+'px';
                    pg.appendChild(th); cy+=tbl.headH;
                    
                    dt.forEach(d => {
                        const tr = mkTbl(tbl, d, false);
                        tr.style.top=cy+'px'; tr.style.left=(tbl.x+state.cfg.offX)+'px';
                        pg.appendChild(tr); cy+=tbl.rowH;
                        
                        if(cy > (state.cfg.h*3.78)-50) {
                            c.appendChild(pg);
                            const nPg = document.createElement('div'); nPg.className='p-pg';
                            state.els.filter(e=>e.y<state.cfg.splitY).forEach(e=>nPg.appendChild(mkEl(e, dt[0])));
                            cy = state.cfg.splitY;
                            const nth = mkTbl(tbl, null, true);
                            nth.style.top=cy+'px'; nth.style.left=(tbl.x+state.cfg.offX)+'px';
                            nPg.appendChild(nth); cy+=tbl.headH;
                            pg=nPg; 
                        }
                    });
                }
                c.appendChild(pg);
            }
            setTimeout(() => window.print(), 500);
        }

        function mkEl(item, data) {
            const d=document.createElement('div'); d.className='p-el';
            d.style.left=(item.x+state.cfg.offX)+'px'; d.style.top=(item.y+state.cfg.offY)+'px';
            d.style.width=item.w+'px'; d.style.height=item.h+'px';
            d.style.fontSize=item.fs+'px'; d.style.fontWeight=item.fw;
            d.style.background=item.bg; d.style.border=item.br; d.style.color=item.color;
            d.style.justifyContent = item.align==='center'?'center':(item.align==='right'?'flex-end':'flex-start');
            if(item.type==='qrcode') {
                 d.innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${data[item.txt]||'TEST'}" style="width:100%;height:100%">`;
            } else if(item.type!=='table') {
                d.innerText = item.type==='field' ? (data[item.txt]||'') : item.txt;
            }
            return d;
        }

        function mkTbl(item, data, isH) {
            const r=document.createElement('div'); r.className='p-el';
            r.style.width=item.colW.reduce((a,b)=>a+b,0)+'px';
            r.style.height=(isH?item.headH:item.rowH)+'px';
            item.cols.forEach((c,i)=>{
                const cell=document.createElement('div');
                cell.style.width=item.colW[i]+'px'; cell.style.height='100%';
                cell.style.border='1px solid #000'; cell.style.fontSize='12px'; cell.style.padding='2px';
                cell.innerText=isH?c:(data[item.fields[i]]||'');
                r.appendChild(cell);
            });
            return r;
        }
    </script>
</body>
</html>
