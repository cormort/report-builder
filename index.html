<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Report Studio v4.3 - æ™ºæ…§æ’ç‰ˆè¨ˆç®—</title>
    <style>
        :root {
            --primary: #2186c4; --primary-hover: #1a6a9e;
            --bg: #f0f2f5; --surface: #ffffff;
            --text: #333; --border: #dcdfe6;
            --success: #67c23a; --danger: #f56c6c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout */
        .header { background: #2b3a42; color: white; padding: 0 20px; height: 60px; display: flex; justify-content: space-between; align-items: center; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .panel { background: var(--surface); display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .left-panel { width: 280px; padding: 15px; overflow-y: auto; }
        .center-panel { flex: 1; background: #525659; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow: auto; }
        .right-panel { width: 320px; padding: 15px; overflow-y: auto; border-left: 1px solid var(--border); }
        .panel-title { font-size: 14px; font-weight: 700; color: #606266; margin-bottom: 12px; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        
        /* Upload & List */
        .upload-area { border: 2px dashed var(--border); padding: 15px; text-align: center; cursor: pointer; color: #909399; font-size: 13px; margin-bottom: 10px; }
        .upload-area:hover { border-color: var(--primary); background: #ecf5ff; }
        .field-item { padding: 6px 10px; background: #f4f4f5; border: 1px solid #e9e9eb; margin-bottom: 5px; cursor: grab; font-size: 12px; }
        
        .tpl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .btn-tpl { padding: 8px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 12px; text-align: center; border-radius: 4px; transition: 0.2s; }
        .btn-tpl:hover { border-color: var(--primary); color: var(--primary); background: #f0f9eb; font-weight: bold; }

        /* Canvas */
        .canvas-wrapper { box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: 0.3s; margin: auto; }
        .canvas {
            background: white; position: relative; overflow: hidden;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px; transform-origin: top center;
        }
        .canvas-element {
            position: absolute; cursor: move; display: flex; align-items: center; overflow: hidden;
            border: 1px dashed #ccc; box-sizing: border-box;
        }
        .canvas-element.selected { border: 2px solid var(--primary); z-index: 100; background: rgba(33, 150, 243, 0.05); }
        .canvas-element-value { pointer-events: none; width: 100%; padding: 2px; }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: var(--primary); cursor: nwse-resize; display: none; }
        .canvas-element.selected .resize-handle { display: block; }
        
        #splitLine { position: absolute; left: 0; width: 100%; height: 0; border-top: 2px dashed #f56c6c; z-index: 90; cursor: ns-resize; display: none; }

        /* Controls */
        .form-group { margin-bottom: 10px; }
        .form-label { font-size: 12px; color: #666; display: block; margin-bottom: 3px; }
        .form-control { width: 100%; padding: 5px; border: 1px solid var(--border); font-size: 13px; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; color: white; background: #666; display: inline-flex; align-items: center; gap: 5px; justify-content: center; }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--success); } .btn-danger { background: var(--danger); }
        .btn-block { width: 100%; }

        #print-container { display: none; }
        @media print {
            @page { margin: 0; }
            body * { visibility: hidden; }
            #print-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; visibility: visible; z-index: 9999; }
            #print-container * { visibility: visible; }
            .print-page { position: relative; margin: 0 auto; background: white; page-break-after: always; break-after: page; overflow: hidden; }
            .print-element { position: absolute; display: flex; align-items: center; padding: 2px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="font-weight: bold;">ğŸ“Š Pro Report Studio v4.3</div>
        <div><button class="btn btn-success" id="printBtn">ğŸ–¨ï¸ åˆ—å° / åŒ¯å‡º PDF</button></div>
    </div>

    <div class="main-layout">
        <!-- LEFT PANEL -->
        <div class="panel left-panel">
            <div class="panel-title">1. æ•¸æ“šæº</div>
            <div class="upload-area" id="uploadArea">ğŸ“‚ ä¸Šå‚³ CSV / JSON<input type="file" id="fileInput" hidden></div>
            <div id="fileInfo" style="font-size:12px; color:#67c23a; margin-bottom:10px;"></div>
            
            <div class="panel-title">2. å¿«é€Ÿæ¨¡ç‰ˆ</div>
            <div class="tpl-grid">
                <div class="btn-tpl" onclick="tpl('labels')">ğŸ·ï¸ æ¨™ç±¤è²¼ç´™ (ç¤ºç¯„)</div>
                <div class="btn-tpl" onclick="tpl('tw_b2b')">ğŸ‡¹ğŸ‡¼ ä¸‰è¯å¼ç™¼ç¥¨</div>
                <div class="btn-tpl" onclick="tpl('tw_einvoice')">ğŸ§¾ é›»å­ç™¼ç¥¨</div>
                <div class="btn-tpl" onclick="tpl('table')">ğŸ“‘ é€šç”¨å ±è¡¨</div>
            </div>

            <div class="panel-title">3. å¯ç”¨æ¬„ä½</div>
            <div id="fieldList" style="min-height: 100px;"></div>
        </div>

        <!-- CENTER CANVAS -->
        <div class="panel center-panel">
            <div style="margin-bottom:10px; display:flex; gap:10px;">
                <button class="btn" style="background:white; color:#333" id="addTextBtn">â• æ–‡å­—</button>
                <button class="btn" style="background:white; color:#333" id="addTitleBtn">ğŸ“Œ æ¨™é¡Œ</button>
                <button class="btn" style="background:white; color:#333" id="addBoxBtn">â¬œ å¤–æ¡†</button>
            </div>
            <div class="canvas-wrapper">
                <div class="canvas" id="canvas" style="width:210mm; height:297mm;">
                    <div id="splitLine" style="top: 150px;"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT SETTINGS -->
        <div class="panel right-panel">
            <div class="panel-title">ğŸ“„ ç‰ˆé¢èˆ‡ç´™å¼µ</div>
            <div class="form-group">
                <label class="form-label">ç´™å¼µå¤§å°</label>
                <select class="form-control" id="pageSizeSelect">
                    <option value="a4">A4 (210 x 297 mm)</option>
                    <option value="a5">A5 (148 x 210 mm)</option>
                    <option value="letter">Letter (216 x 279 mm)</option>
                    <option value="receipt80">80mm æ”¶æ“š (å·ç´™)</option>
                    <option value="custom">è‡ªè¨‚å°ºå¯¸</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">æ–¹å‘</label>
                <select class="form-control" id="orientationSelect">
                    <option value="portrait">ç›´å‘ (Portrait)</option>
                    <option value="landscape">æ©«å‘ (Landscape)</option>
                </select>
            </div>

            <div class="panel-title" style="margin-top:10px">ğŸ–¨ï¸ åˆ—å°æ¨¡å¼</div>
            <div class="form-group">
                <label class="form-label">æ’åˆ—æ–¹å¼</label>
                <select class="form-control" id="reportMode">
                    <option value="single">å–®é å–®ç­† (æ¯ç­†ä¸€é )</option>
                    <option value="group">åˆ†çµ„åˆ—è¡¨ (Master-Detail)</option>
                    <option value="grid">ä¸€é å¤šå¼µ (æµ·å ±/æ¨™ç±¤)</option>
                </select>
            </div>

            <!-- Settings: Grid/Poster Mode -->
            <div id="gridSettings" style="display:none; background:#ecf5ff; padding:8px; border-radius:4px;">
                <div style="font-size:12px; color:#409eff; margin-bottom:8px; line-height:1.4;">
                    ğŸ’¡ è«‹å…ˆè¨­è¨ˆã€Œå–®å¼µã€æ¨™ç±¤çš„å…§å®¹<br>å†é»æ“Šä¸‹æ–¹æŒ‰éˆ•è‡ªå‹•è¨ˆç®—æ’ç‰ˆ
                </div>
                <button class="btn btn-primary btn-block" style="margin-bottom:10px;" onclick="autoCalcGrid()">âœ¨ è‡ªå‹•è¨ˆç®—æœ€å¤§å¼µæ•¸</button>
                
                <div class="form-group"><label class="form-label">æ©«å‘å¹¾æ¬„ (Columns)</label><input type="number" class="form-control" id="gridCols" value="2"></div>
                <div class="form-group"><label class="form-label">ç›´å‘å¹¾åˆ— (Rows)</label><input type="number" class="form-control" id="gridRows" value="4"></div>
                <div class="form-group"><label class="form-label">æ°´å¹³é–“è· (px)</label><input type="number" class="form-control" id="gridGapX" value="10"></div>
                <div class="form-group"><label class="form-label">å‚ç›´é–“è· (px)</label><input type="number" class="form-control" id="gridGapY" value="10"></div>
            </div>

            <!-- Settings: Table Mode -->
            <div id="groupSettings" style="display:none; background:#f0f9eb; padding:8px; border-radius:4px;">
                <div class="form-group"><label class="form-label">åˆ†çµ„æ¬„ä½</label><select class="form-control" id="groupFieldSelect"></select></div>
                <div class="form-group"><label class="form-label">åˆ†éš”ç·š Y (px)</label><input type="number" class="form-control" id="splitYInput" value="150"></div>
                <div class="form-group"><label class="form-label">è¡Œé«˜ (px)</label><input type="number" class="form-control" id="rowHeightInput" value="30"></div>
            </div>

            <div class="panel-title" style="margin-top:20px">âœ¨ å…ƒç´ å±¬æ€§</div>
            <div id="propPanel" style="font-size:12px; color:#999; text-align:center; padding:10px;">é¸æ“‡å…ƒç´ ä»¥ç·¨è¼¯</div>
        </div>
    </div>

    <div id="print-container"></div>

        <script>
        // ==========================================
        // 1. å…¨å±€ç‹€æ…‹ (State Management)
        // ==========================================
        const state = {
            fields: [],          // CSV æ¬„ä½åç¨±
            elements: [],        // ç•«å¸ƒä¸Šçš„æ‰€æœ‰å…ƒç´ ç‰©ä»¶
            data: [],            // CSV æ•¸æ“šå…§å®¹
            selectedElement: null, // ç•¶å‰é¸ä¸­çš„å…ƒç´ 
            config: {
                pageSize: 'a4',
                orientation: 'portrait',
                widthMm: 210,
                heightMm: 297,
                mode: 'single',  // 'single'(å–®é ), 'group'(åˆ—è¡¨), 'grid'(æ¨™ç±¤)
                groupField: '',  // åˆ†çµ„ä¾æ“šæ¬„ä½
                splitY: 150,     // åˆ—è¡¨æ¨¡å¼çš„åˆ†éš”ç·šä½ç½®
                rowHeight: 30,   // åˆ—è¡¨æ¨¡å¼çš„è¡Œé«˜
                gridCols: 2,     // æ¨™ç±¤æ¨¡å¼ï¼šæ©«å‘æ¬„æ•¸
                gridRows: 4,     // æ¨™ç±¤æ¨¡å¼ï¼šç›´å‘åˆ—æ•¸
                gridGapX: 10,    // æ¨™ç±¤æ¨¡å¼ï¼šæ°´å¹³é–“è·
                gridGapY: 10     // æ¨™ç±¤æ¨¡å¼ï¼šå‚ç›´é–“è·
            }
        };
    
        // DOM å…ƒç´ ç·©å­˜
        const els = {
            canvas: document.getElementById('canvas'),
            fieldList: document.getElementById('fieldList'),
            propPanel: document.getElementById('propPanel'),
            splitLine: document.getElementById('splitLine'),
            modeSelect: document.getElementById('reportMode'),
            sizeSelect: document.getElementById('pageSizeSelect'),
            orientSelect: document.getElementById('orientationSelect')
        };
    
        // åˆå§‹åŒ–
        initCanvas();
        initDrag();
    
        // ==========================================
        // 2. ç•«å¸ƒèˆ‡ç‰ˆé¢è¨­å®š (Canvas & Layout)
        // ==========================================
        function initCanvas() {
            updateCanvasSize();
            // ç›£è½ç´™å¼µå¤§å°è®ŠåŒ–
            els.sizeSelect.onchange = (e) => {
                state.config.pageSize = e.target.value;
                updateCanvasSize();
            };
            // ç›£è½æ–¹å‘è®ŠåŒ–
            els.orientSelect.onchange = (e) => {
                state.config.orientation = e.target.value;
                updateCanvasSize();
            };
        }
    
        function updateCanvasSize() {
            const sizeMap = {
                'a4': [210, 297],
                'a5': [148, 210],
                'letter': [216, 279],
                'receipt80': [80, 297] // é«˜åº¦åƒ…ç‚ºç¤ºæ„
            };
    
            let [w, h] = sizeMap[state.config.pageSize] || [210, 297];
    
            // å¦‚æœæ˜¯æ©«å‘ï¼Œä¸”ä¸æ˜¯æ”¶æ“šæ¨¡å¼ï¼Œå‰‡äº¤æ›é•·å¯¬
            if (state.config.orientation === 'landscape' && state.config.pageSize !== 'receipt80') {
                [w, h] = [h, w];
            }
    
            state.config.widthMm = w;
            state.config.heightMm = h;
    
            els.canvas.style.width = w + 'mm';
            els.canvas.style.height = h + 'mm';
    
            // æ”¶æ“šæ¨¡å¼ç‰¹æ®Šè™•ç† (ç„¡é™é•·)
            if (state.config.pageSize === 'receipt80') {
                els.canvas.style.height = 'auto';
                els.canvas.style.minHeight = '150mm';
                els.canvas.style.borderBottom = '3px jagged #ccc';
            } else {
                els.canvas.style.borderBottom = 'none';
            }
        }
    
        // ==========================================
        // 3. è‡ªå‹•æ’ç‰ˆè¨ˆç®— (Auto Grid Calculation)
        // ==========================================
        window.autoCalcGrid = () => {
            if (state.elements.length === 0) {
                alert('ç•«å¸ƒæ˜¯ç©ºçš„ï¼è«‹å…ˆè¨­è¨ˆä¸€å€‹æ¨™ç±¤çš„å…§å®¹ï¼ˆä¾‹å¦‚æ‹‰å…¥æ–‡å­—æˆ–æ¬„ä½ï¼‰ï¼Œç³»çµ±æ‰èƒ½è¨ˆç®—å°ºå¯¸ã€‚');
                return;
            }
    
            // 1. è¨ˆç®—å…§å®¹é‚Šç•Œ (Bounding Box)
            let maxX = 0, maxY = 0;
            state.elements.forEach(el => {
                maxX = Math.max(maxX, el.x + el.width);
                maxY = Math.max(maxY, el.y + el.height);
            });
    
            // 2. å–å¾—ç´™å¼µå¤§å° (è½‰æ›ç‚º PX, 1mm ç´„ç­‰æ–¼ 3.78px)
            const MM_TO_PX = 3.78;
            const paperW = state.config.widthMm * MM_TO_PX;
            const paperH = state.config.heightMm * MM_TO_PX;
    
            // 3. è¨­å®šå®‰å…¨é‚Šè· (ä¾‹å¦‚ 5mm)
            const margin = 5 * MM_TO_PX;
            const usableW = paperW - (margin * 2);
            const usableH = paperH - (margin * 2);
    
            // 4. å–å¾—ç›®å‰è¨­å®šçš„é–“è·
            const gapX = state.config.gridGapX;
            const gapY = state.config.gridGapY;
    
            // 5. è¨ˆç®—å…¬å¼
            // è‹¥å¯¬åº¦ç‚º Wï¼Œé–“è·ç‚º Gï¼Œæ•¸é‡ç‚º N
            // N * W + (N-1) * G <= UsableWidth
            // N * (W + G) - G <= UsableWidth
            // N <= (UsableWidth + G) / (W + G)
            const itemW = maxX;
            const itemH = maxY;
            
            const cols = Math.floor((usableW + gapX) / (itemW + gapX));
            const rows = Math.floor((usableH + gapY) / (itemH + gapY));
    
            if (cols < 1 || rows < 1) {
                alert(`âš ï¸ å…§å®¹å°ºå¯¸ (${Math.round(itemW)}x${Math.round(itemH)}px) å¤ªå¤§ï¼Œç„¡æ³•æ”¾å…¥ç•¶å‰ç´™å¼µï¼`);
                return;
            }
    
            // 6. æ‡‰ç”¨è¨­å®š
            state.config.gridCols = cols;
            state.config.gridRows = rows;
            document.getElementById('gridCols').value = cols;
            document.getElementById('gridRows').value = rows;
    
            alert(`âœ… è¨ˆç®—å®Œæˆï¼\nå–®å€‹å…§å®¹ï¼š${Math.round(itemW)} x ${Math.round(itemH)} px\næ’ç‰ˆçµæœï¼š${cols} æ¬„ x ${rows} åˆ—\nå–®é å¼µæ•¸ï¼š${cols * rows} å¼µ`);
        };
    
        // ==========================================
        // 4. å¿«é€Ÿç¯„æœ¬ (Templates)
        // ==========================================
        window.tpl = (type) => {
            if (!confirm('é€™å°‡æ¸…é™¤ç•¶å‰ç•«å¸ƒï¼Œç¢ºå®šå—ï¼Ÿ')) return;
            
            // æ¸…é™¤ç•«å¸ƒ
            state.elements = [];
            els.canvas.innerHTML = '<div id="splitLine"></div>';
    
            if (type === 'labels') {
                setPage('a4', 'portrait', 'grid');
                // æ¨¡æ“¬æ¨™ç±¤æ¡†
                addElement('text', '', 0, 0, 300, 180, 12, 'normal', 'transparent', '2px solid #ccc');
                addElement('title', 'ç”¢å“æ¨™ç±¤', 10, 10, 150, 30, 16, 'bold');
                addElement('text', 'å“å:', 10, 50, 50, 25, 12, 'bold');
                if(state.fields.length > 0) {
                    addElement('field', state.fields[0], 70, 50, 200, 25, 12, 'normal', '#eee');
                } else {
                    addElement('text', '[å“å]', 70, 50, 200, 25, 12, 'normal', '#eee');
                }
            } 
            else if (type === 'tw_b2b') {
                setPage('a4', 'portrait', 'group');
                addElement('title', 'é›»å­è¨ˆç®—æ©Ÿçµ±ä¸€ç™¼ç¥¨', 250, 30, 300, 30, 22, 'bold');
                addElement('text', 'è²·å—äººï¼š', 40, 90, 60, 25, 12, 'bold');
                addElement('field', 'Buyer', 100, 90, 200, 25, 12, 'normal', '#eee', '1px solid #999');
                
                // è¨­å®šè¡¨æ ¼ç·š
                state.config.splitY = 140;
                const headers = ['å“å', 'æ•¸é‡', 'å–®åƒ¹', 'é‡‘é¡', 'å‚™è¨»'];
                headers.forEach((h, i) => {
                    addElement('text', h, 40 + i * 100, 115, 100, 25, 12, 'bold', '#f0f0f0', '1px solid #333');
                });
                updateSplitLine();
            } 
            else if (type === 'tw_einvoice') {
                setPage('receipt80', 'portrait', 'group');
                addElement('title', 'é›»å­ç™¼ç¥¨è­‰æ˜è¯', 30, 20, 200, 30, 18, 'bold');
                addElement('text', '112å¹´ 11-12æœˆ', 50, 50, 150, 25, 16, 'bold');
                state.config.splitY = 150;
                updateSplitLine();
            } 
            else if (type === 'table') {
                setPage('a4', 'portrait', 'group');
                addElement('title', 'å ±è¡¨', 20, 20, 200, 40, 24, 'bold');
                state.config.splitY = 80;
                updateSplitLine();
            }
        };
    
        function setPage(size, orient, mode) {
            els.sizeSelect.value = state.config.pageSize = size;
            els.orientSelect.value = state.config.orientation = orient;
            els.modeSelect.value = state.config.mode = mode;
            updateCanvasSize();
            updateSettingsUI();
        }
    
        // ==========================================
        // 5. è¨­å®šé¢æ¿é‚è¼¯ (Settings UI)
        // ==========================================
        els.modeSelect.onchange = (e) => {
            state.config.mode = e.target.value;
            updateSettingsUI();
        };
    
        function updateSettingsUI() {
            const m = state.config.mode;
            document.getElementById('groupSettings').style.display = m === 'group' ? 'block' : 'none';
            document.getElementById('gridSettings').style.display = m === 'grid' ? 'block' : 'none';
            els.splitLine.style.display = m === 'group' ? 'block' : 'none';
        }
    
        // ç¶å®šæ‰€æœ‰ input äº‹ä»¶
        ['gridCols', 'gridRows', 'gridGapX', 'gridGapY'].forEach(id => {
            document.getElementById(id).onchange = (e) => state.config[id] = parseInt(e.target.value);
        });
        document.getElementById('splitYInput').onchange = (e) => {
            state.config.splitY = +e.target.value;
            updateSplitLine();
        };
        document.getElementById('rowHeightInput').onchange = (e) => state.config.rowHeight = +e.target.value;
    
    
        // ==========================================
        // 6. å…ƒç´ æ“ä½œ (Add / Render / Edit)
        // ==========================================
        document.getElementById('addTextBtn').onclick = () => addElement('text', 'æ–‡å­—', 20, 20);
        document.getElementById('addTitleBtn').onclick = () => addElement('title', 'æ¨™é¡Œ', 20, 20, 150, 40, 20, 'bold');
        document.getElementById('addBoxBtn').onclick = () => addElement('text', '', 50, 50, 100, 100, 12, 'normal', 'transparent', '2px solid #333');
    
        function addElement(type, content, x, y, w = 120, h = 30, fs = 14, fw = 'normal', bg = 'transparent', border = '1px dashed #ccc') {
            const el = {
                id: 'el-' + Math.random().toString(36).substr(2, 9),
                type: type,
                content: content,
                x: x,
                y: y,
                width: w,
                height: h,
                fontSize: fs,
                fontWeight: fw,
                backgroundColor: bg,
                border: border,
                fieldName: type === 'field' ? content : null
            };
            state.elements.push(el);
            renderEl(el);
            return el;
        }
    
        function renderEl(el) {
            const div = document.createElement('div');
            div.id = el.id;
            div.className = 'canvas-element';
            updateElStyle(div, el);
    
            div.innerHTML = `
                <div class="canvas-element-value">${el.type === 'field' ? `[${el.content}]` : el.content}</div>
                <div class="resize-handle"></div>
            `;
    
            // æ»‘é¼ æ‹–æ›³é‚è¼¯
            div.onmousedown = (e) => {
                if (e.target.classList.contains('resize-handle')) return;
                e.stopPropagation();
                selectEl(el);
    
                const startX = e.clientX;
                const startY = e.clientY;
                const origX = el.x;
                const origY = el.y;
    
                const onMove = (ev) => {
                    el.x = origX + (ev.clientX - startX);
                    el.y = origY + (ev.clientY - startY);
                    updateElStyle(div, el);
                };
    
                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                };
    
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            };
    
            // ç¸®æ”¾æ‰‹æŸ„é‚è¼¯
            const handle = div.querySelector('.resize-handle');
            handle.onmousedown = (e) => {
                e.stopPropagation();
                const startX = e.clientX;
                const startY = e.clientY;
                const origW = el.width;
                const origH = el.height;
    
                const onResize = (ev) => {
                    el.width = Math.max(10, origW + (ev.clientX - startX));
                    el.height = Math.max(10, origH + (ev.clientY - startY));
                    updateElStyle(div, el);
                    renderProps(el);
                };
    
                const onUp = () => {
                    document.removeEventListener('mousemove', onResize);
                    document.removeEventListener('mouseup', onUp);
                };
    
                document.addEventListener('mousemove', onResize);
                document.addEventListener('mouseup', onUp);
            };
    
            els.canvas.appendChild(div);
        }
    
        function updateElStyle(div, el) {
            div.style.left = el.x + 'px';
            div.style.top = el.y + 'px';
            div.style.width = el.width + 'px';
            div.style.height = el.height + 'px';
            div.style.fontSize = el.fontSize + 'px';
            div.style.fontWeight = el.fontWeight;
            div.style.background = el.backgroundColor;
            div.style.border = el.border;
        }
    
        function selectEl(el) {
            state.selectedElement = el;
            document.querySelectorAll('.canvas-element').forEach(d => d.classList.remove('selected'));
            document.getElementById(el.id).classList.add('selected');
            renderProps(el);
        }
    
        function renderProps(el) {
            els.propPanel.innerHTML = `
                <div class="form-group">
                    <label class="form-label">å…§å®¹</label>
                    <input class="form-control" value="${el.content}" oninput="setProp('${el.id}','content',this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">å­—é«”å¤§å°</label>
                    <input type="number" class="form-control" value="${el.fontSize}" oninput="setProp('${el.id}','fontSize',this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">èƒŒæ™¯è‰²</label>
                    <input type="color" style="width:100%" value="${el.backgroundColor==='transparent'?'#ffffff':el.backgroundColor}" oninput="setProp('${el.id}','backgroundColor',this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">é‚Šæ¡†</label>
                    <select class="form-control" onchange="setProp('${el.id}','border',this.value)">
                        <option value="none" ${el.border==='none'?'selected':''}>ç„¡</option>
                        <option value="1px solid #000" ${el.border.includes('solid') && !el.border.includes('2px')?'selected':''}>å¯¦ç·š</option>
                        <option value="1px dashed #000" ${el.border.includes('dashed')?'selected':''}>è™›ç·š</option>
                        <option value="2px solid #000" ${el.border.includes('2px')?'selected':''}>ç²—æ¡†</option>
                    </select>
                </div>
                <button class="btn btn-danger btn-block" onclick="delEl('${el.id}')">åˆªé™¤å…ƒç´ </button>
            `;
        }
    
        window.setProp = (id, key, val) => {
            const el = state.elements.find(e => e.id === id);
            if (el) {
                el[key] = val;
                const div = document.getElementById(id);
                updateElStyle(div, el);
                if (key === 'content') {
                    div.querySelector('.canvas-element-value').innerText = el.type === 'field' ? `[${val}]` : val;
                }
            }
        };
    
        window.delEl = (id) => {
            state.elements = state.elements.filter(e => e.id !== id);
            document.getElementById(id).remove();
            els.propPanel.innerHTML = '<div style="text-align:center; padding:10px; color:#999">å·²åˆªé™¤</div>';
        };
    
        // ==========================================
        // 7. æª”æ¡ˆè™•ç†èˆ‡æ‹–æ›³ (File & Drag)
        // ==========================================
        document.getElementById('uploadArea').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                state.data = file.name.endsWith('.json') ? JSON.parse(ev.target.result) : parseCSV(ev.target.result);
                state.fields = Object.keys(state.data[0] || {});
                renderFields();
                document.getElementById('fileInfo').innerText = `âœ… å·²è¼‰å…¥ ${state.data.length} ç­†æ•¸æ“š`;
            };
            reader.readAsText(file);
        };
    
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(s => s.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, i) => {
                    obj[header] = values[i] ? values[i].trim() : '';
                    return obj;
                }, {});
            });
        }
    
        function renderFields() {
            els.fieldList.innerHTML = state.fields.map(f => 
                `<div class="field-item" draggable="true" data-f="${f}">ğŸ“„ ${f}</div>`
            ).join('');
            
            // æ›´æ–°åˆ†çµ„é¸å–®
            const sel = document.getElementById('groupFieldSelect');
            sel.innerHTML = `<option value="">--æœªé¸æ“‡--</option>` + 
                state.fields.map(f => `<option value="${f}">${f}</option>`).join('');
        }
    
        function initDrag() {
            // ä¾†æºæ‹–æ›³
            els.fieldList.addEventListener('dragstart', e => {
                e.dataTransfer.setData('type', 'field');
                e.dataTransfer.setData('val', e.target.dataset.f);
            });
    
            // ç•«å¸ƒæ”¾ç½®
            els.canvas.addEventListener('dragover', e => e.preventDefault());
            els.canvas.addEventListener('drop', e => {
                e.preventDefault();
                const type = e.dataTransfer.getData('type');
                if (!type) return;
                const rect = els.canvas.getBoundingClientRect();
                addElement(type, e.dataTransfer.getData('val'), e.clientX - rect.left, e.clientY - rect.top);
            });
    
            // åˆ†éš”ç·šæ‹–æ›³
            let spDrag = false;
            els.splitLine.onmousedown = () => spDrag = true;
            document.addEventListener('mousemove', (e) => {
                if (spDrag) {
                    const rect = els.canvas.getBoundingClientRect();
                    state.config.splitY = Math.max(0, e.clientY - rect.top);
                    updateSplitLine();
                    document.getElementById('splitYInput').value = Math.round(state.config.splitY);
                }
            });
            document.addEventListener('mouseup', () => spDrag = false);
        }
    
        function updateSplitLine() {
            els.splitLine.style.top = state.config.splitY + 'px';
        }
    
        // ==========================================
    // 8. åˆ—å°æ ¸å¿ƒé‚è¼¯ (Print Engine) - ä¿®æ­£ç‰ˆ
    // ==========================================
    document.getElementById('printBtn').onclick = () => {
        const ctr = document.getElementById('print-container');
        ctr.innerHTML = ''; // æ¸…ç©ºä¸Šæ¬¡å…§å®¹

        if (!state.data.length) {
            // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œç‚ºäº†é è¦½æ¨¡æ¿æ•ˆæœï¼Œæˆ‘å€‘å¯ä»¥ç”Ÿæˆä¸€ç­†å‡è³‡æ–™
            // é€™æ¨£æ‚¨åœ¨è¨­è¨ˆæ™‚æŒ‰åˆ—å°ä¹Ÿèƒ½çœ‹åˆ°æ•ˆæœï¼Œä¸ç”¨æ¯æ¬¡éƒ½ä¸Šå‚³ CSV
            if (state.elements.length > 0) {
                 const dummy = {};
                 state.fields.forEach(f => dummy[f] = `(é è¦½:${f})`);
                 // è‡¨æ™‚å°‡ state.data æ›¿æ›ç‚ºä¸€ç­†å‡è³‡æ–™é€²è¡Œåˆ—å°ï¼Œå°å®Œé‚„åŸ
                 const originalData = state.data;
                 state.data = [dummy];
                 
                 runPrintProcess(ctr); // åŸ·è¡Œåˆ—å°
                 
                 state.data = originalData; // é‚„åŸ
                 return;
            } else {
                alert('ç„¡æ•¸æ“šå¯åˆ—å°ï¼Œè«‹å…ˆä¸Šå‚³ CSV/JSON');
                return;
            }
        }

        runPrintProcess(ctr);
    };

    function runPrintProcess(ctr) {
        // å‹•æ…‹æ³¨å…¥ CSS ä»¥è¨­å®šæ­£ç¢ºçš„ç´™å¼µå¤§å°
        const style = document.createElement('style');
        style.innerHTML = `@media print { 
            @page { 
                size: ${state.config.pageSize === 'custom' ? 'auto' : state.config.pageSize} ${state.config.orientation}; 
                margin: 0; 
            } 
        }`;
        ctr.appendChild(style);

        // æ ¹æ“šæ¨¡å¼é¸æ“‡ç”Ÿæˆå‡½æ•¸
        const m = state.config.mode;
        if (m === 'single') printSingle(ctr);
        else if (m === 'group') printGroup(ctr);
        else if (m === 'grid') printGrid(ctr);

        // å»¶é²å‘¼å«ç€è¦½å™¨åˆ—å°
        setTimeout(() => {
            window.print();
            ctr.innerHTML = '';
        }, 500);
    }

    function createPage() {
        const d = document.createElement('div');
        d.className = 'print-page';
        d.style.width = state.config.widthMm + 'mm';
        // é è¨­é«˜åº¦ï¼Œç¨å¾Œå¦‚æœæ˜¯æ”¶æ“šæ¨¡å¼æœƒè¢«å‹•æ…‹è¦†è“‹
        d.style.height = state.config.pageSize === 'receipt80' ? 'auto' : (state.config.heightMm + 'mm');
        return d;
    }

    function createEl(el, row, dx = 0, dy = 0) {
        const d = document.createElement('div');
        d.className = 'print-element';
        // ä½ç½®èˆ‡æ¨£å¼
        const finalX = el.x + dx;
        const finalY = el.y + dy;
        d.style.left = finalX + 'px';
        d.style.top = finalY + 'px';
        d.style.width = el.width + 'px';
        d.style.height = el.height + 'px';
        d.style.fontSize = el.fontSize + 'px';
        d.style.fontWeight = el.fontWeight;
        d.style.background = el.backgroundColor;
        d.style.border = el.border;
        
        // å…§å®¹æ›¿æ›
        d.innerText = el.type === 'field' && row ? (row[el.fieldName] || '') : el.content;
        
        // å›å‚³å…ƒç´ ä»¥åŠå®ƒçš„åº•éƒ¨ Y åº§æ¨™ (ç”¨æ–¼è¨ˆç®—é«˜åº¦)
        d.dataset.bottom = finalY + el.height;
        return d;
    }

    // æ¨¡å¼ A: å–®é å–®ç­† (ä¿®æ­£é«˜åº¦å¡Œé™·)
    function printSingle(ctr) {
        state.data.forEach(row => {
            const pg = createPage();
            let maxBottom = 0;

            state.elements.forEach(el => {
                const domEl = createEl(el, row);
                pg.appendChild(domEl);
                maxBottom = Math.max(maxBottom, parseFloat(domEl.dataset.bottom));
            });

            // ä¿®æ­£æ”¶æ“šæ¨¡å¼é«˜åº¦
            if (state.config.pageSize === 'receipt80') {
                pg.style.height = (maxBottom + 20) + 'px';
            }
            ctr.appendChild(pg);
        });
    }

    // æ¨¡å¼ B: åˆ†çµ„åˆ—è¡¨ (ä¿®æ­£é«˜åº¦å¡Œé™·)
    function printGroup(ctr) {
        const groups = {};
        const keyF = state.config.groupField;
        state.data.forEach(r => {
            const k = keyF ? r[keyF] : 'ALL';
            if (!groups[k]) groups[k] = [];
            groups[k].push(r);
        });

        const hEls = state.elements.filter(e => e.y < state.config.splitY); 
        const dEls = state.elements.filter(e => e.y >= state.config.splitY); 
        dEls.forEach(e => e._oy = e.y - state.config.splitY);

        const pageH = state.config.pageSize === 'receipt80' ? 99999 : 1050; 

        Object.values(groups).forEach(rows => {
            let pg = createPage();
            ctr.appendChild(pg);
            let currentMaxY = 0; // ç”¨ä¾†è¿½è¹¤ç•¶å‰é é¢å°åˆ°äº†å“ªè£¡

            // æ¸²æŸ“è¡¨é ­
            const renderHeader = () => hEls.forEach(e => {
                const domEl = createEl(e, rows[0]);
                pg.appendChild(domEl);
                currentMaxY = Math.max(currentMaxY, parseFloat(domEl.dataset.bottom));
            });
            renderHeader();

            let y = state.config.splitY;

            rows.forEach(row => {
                if (y + state.config.rowHeight > pageH) {
                    pg = createPage();
                    ctr.appendChild(pg);
                    renderHeader();
                    y = state.config.splitY;
                    currentMaxY = y; // é‡ç½®é«˜åº¦è¿½è¹¤
                }
                
                dEls.forEach(e => {
                    const elY = y + e._oy - e.y; // å¯¦éš›åˆ—å°çš„ Y åº§æ¨™
                    const domEl = createEl(e, row, 0, elY); // æ³¨æ„é€™è£¡çš„ä½ç§»é‚è¼¯ä¿®æ­£
                    
                    // æ‰‹å‹•ä¿®æ­£ createEl å…§çš„è¨ˆç®—é‚è¼¯ï¼Œé€™è£¡ç›´æ¥çµ¦çµ•å°ä½ç½®æ¯”è¼ƒæº–ç¢º
                    domEl.style.top = (y + (e.y - state.config.splitY)) + 'px';
                    domEl.style.left = e.x + 'px';
                    
                    pg.appendChild(domEl);
                    const elBottom = (y + (e.y - state.config.splitY)) + e.height;
                    currentMaxY = Math.max(currentMaxY, elBottom);
                });
                y += state.config.rowHeight;
            });

            // é—œéµä¿®æ­£ï¼šå¦‚æœæ˜¯æ”¶æ“šæ¨¡å¼ï¼Œå¼·åˆ¶æ’é–‹é«˜åº¦
            if (state.config.pageSize === 'receipt80') {
                pg.style.height = (currentMaxY + 50) + 'px'; // +50px ç•™ç™½
            }
        });
    }

    // æ¨¡å¼ C: ç¶²æ ¼/æ¨™ç±¤ (ä¿®æ­£ç‰ˆï¼šè‡ªå‹•ç½®ä¸­èˆ‡å®‰å…¨é‚Šè·)
    function printGrid(ctr) {
        const { gridCols, gridRows, gridGapX, gridGapY } = state.config;
        
        // 1. è¨ˆç®—å–®å…ƒæ ¼å¤§å° (æ ¹æ“šç•«å¸ƒä¸Šå…ƒç´ çš„æœ€å¤§é‚Šç•Œ)
        let maxX = 0, maxY = 0;
        state.elements.forEach(e => {
            maxX = Math.max(maxX, e.x + e.width);
            maxY = Math.max(maxY, e.y + e.height);
        });
        
        // å–®æ ¼å®Œæ•´å¯¬åº¦ (å«é–“è·)
        const cellW = maxX + gridGapX;
        const cellH = maxY + gridGapY;

        // 2. è¨ˆç®—æ•´å¼µç´™çš„åƒç´ å¤§å° (1mm ç´„ç­‰æ–¼ 3.78px)
        const MM_TO_PX = 3.78;
        const pagePixelW = state.config.widthMm * MM_TO_PX;
        const pagePixelH = state.config.heightMm * MM_TO_PX;

        // 3. è¨ˆç®—ç¸½å…§å®¹å¯¬é«˜
        const totalContentW = (cellW * gridCols) - gridGapX; // æ‰£æ‰æœ€å¾Œä¸€å€‹å¤šé¤˜é–“è·
        const totalContentH = (cellH * gridRows) - gridGapY;

        // 4. è¨ˆç®—ç½®ä¸­æ‰€éœ€çš„èµ·å§‹åº§æ¨™ (å·¦é‚Šç•Œèˆ‡ä¸Šé‚Šç•Œ)
        // Math.max(20, ...) ç¢ºä¿è‡³å°‘æœ‰ 20px (ç´„5mm) çš„å®‰å…¨é‚Šè·ï¼Œé¿å…å°è¡¨æ©Ÿå¤¾ç´™èª¤å·®
        const startX = Math.max(20, (pagePixelW - totalContentW) / 2);
        const startY = Math.max(20, (pagePixelH - totalContentH) / 2);

        let pg = createPage();
        ctr.appendChild(pg);
        let idx = 0;

        state.data.forEach(row => {
            // æ›é åˆ¤æ–·
            if (idx >= gridCols * gridRows) {
                pg = createPage();
                ctr.appendChild(pg);
                idx = 0;
            }

            const col = idx % gridCols;
            const rowIdx = Math.floor(idx / gridCols);
            
            // åŠ ä¸Š startX èˆ‡ startY é€²è¡Œåç§»
            const offsetX = startX + (col * cellW);
            const offsetY = startY + (rowIdx * cellH);

            state.elements.forEach(el => {
                pg.appendChild(createEl(el, row, offsetX, offsetY));
            });

            idx++;
        });
    }
    </script>
</body>
</html>
