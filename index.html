<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Report Studio v5.0 - è¡¨æ ¼ç²¾éˆç‰ˆ</title>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <style>
        :root { --primary: #2186c4; --bg: #f0f2f5; --surface: #ffffff; --border: #dcdfe6; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; color: #333; }
        
        /* Layout */
        .header { background: #2b3a42; color: white; padding: 0 20px; height: 60px; display: flex; justify-content: space-between; align-items: center; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .panel { background: var(--surface); display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .left-panel { width: 260px; padding: 15px; overflow-y: auto; }
        .center-panel { flex: 1; background: #525659; position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow: auto; }
        .right-panel { width: 300px; padding: 15px; overflow-y: auto; border-left: 1px solid var(--border); }
        .panel-title { font-size: 14px; font-weight: bold; color: #666; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        /* UI Elements */
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; background: #e0e0e0; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .btn:hover { background: #d0d0d0; }
        .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { background: #1a6a9e; }
        .btn-danger { background: #f56c6c; color: white; }
        .btn-success { background: #67c23a; color: white; }
        .btn-block { width: 100%; margin-bottom: 5px; }
        .form-group { margin-bottom: 10px; }
        .form-label { font-size: 12px; color: #666; display: block; margin-bottom: 3px; }
        .form-control { width: 100%; padding: 5px; border: 1px solid var(--border); font-size: 13px; }
        
        /* Upload & List */
        .upload-area { border: 2px dashed var(--border); padding: 15px; text-align: center; cursor: pointer; font-size: 13px; margin-bottom: 10px; color: #666; }
        .upload-area:hover { border-color: var(--primary); background: #ecf5ff; }
        .field-item { padding: 5px 8px; background: #f4f4f5; border: 1px solid #e9e9eb; margin-bottom: 4px; cursor: grab; font-size: 12px; }
        
        /* Canvas */
        .canvas-wrapper { box-shadow: 0 0 20px rgba(0,0,0,0.5); margin: auto; transition: 0.3s; }
        .canvas {
            background: white; position: relative; overflow: hidden; transform-origin: top center;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .canvas-element { position: absolute; cursor: move; display: flex; align-items: center; overflow: hidden; border: 1px dashed #ccc; box-sizing: border-box; }
        .canvas-element.selected { border: 2px solid var(--primary); z-index: 100; background: rgba(33, 150, 243, 0.1); }
        .canvas-element-value { pointer-events: none; width: 100%; padding: 2px; overflow: hidden; }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 8px; height: 8px; background: var(--primary); cursor: nwse-resize; display: none; }
        .canvas-element.selected .resize-handle { display: block; }
        #splitLine { position: absolute; left: 0; width: 100%; height: 0; border-top: 2px dashed #f56c6c; z-index: 90; cursor: ns-resize; display: none; }

        /* Table Wizard Modal */
        .modal-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
        .modal { background: white; padding: 20px; border-radius: 8px; width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        /* Print */
        #print-container { display: none; }
        @media print {
            @page { margin: 0; }
            body * { visibility: hidden; }
            #print-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; visibility: visible; }
            #print-container * { visibility: visible; }
            .print-page { position: relative; margin: 0 auto; background: white; page-break-after: always; break-after: page; overflow: hidden; }
            .print-element { position: absolute; display: flex; align-items: center; padding: 2px; }
            .print-page { background-image: none !important; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="font-weight: bold;">ğŸ“Š Pro Report Studio v5.0 (Table Wizard)</div>
        <div><button class="btn btn-success" id="printBtn">ğŸ–¨ï¸ åˆ—å° / åŒ¯å‡º</button></div>
    </div>

    <div class="main-layout">
        <!-- LEFT: Tools -->
        <div class="panel left-panel">
            <div class="panel-title">1. æª”æ¡ˆ</div>
            <div class="upload-area" id="dataBtn">ğŸ“‚ ä¸Šå‚³ CSV æ•¸æ“š<input type="file" id="dataFile" hidden accept=".csv,.json"></div>
            <div id="fileInfo" style="font-size:12px; color:#67c23a; margin-bottom:10px;"></div>
            <div class="upload-area" id="pdfBtn" style="color:#2186c4; border-color:#2186c4">ğŸ“„ åŒ¯å…¥ PDF åº•åœ–<input type="file" id="pdfFile" hidden accept=".pdf"></div>
            
            <div class="panel-title">2. æ’å…¥ç‰©ä»¶</div>
            <button class="btn btn-block" onclick="openTableModal()">ğŸ“… æ’å…¥è¡¨æ ¼ (ç²¾éˆ)</button>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
                <button class="btn" onclick="addElement('text','æ–‡å­—',20,20)">A æ–‡å­—</button>
                <button class="btn" onclick="addElement('title','æ¨™é¡Œ',20,20,150,40,20,'bold')">H æ¨™é¡Œ</button>
            </div>
            
            <div class="panel-title">3. åŸºæœ¬å½¢ç‹€</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-bottom:10px;">
                <button class="btn" onclick="addElement('text','',50,50,100,50,12,'normal','transparent','2px solid #333')" title="çŸ©å½¢æ¡†">â¬œ</button>
                <button class="btn" onclick="addElement('text','',50,50,200,2,12,'normal','#000','none')" title="æ°´å¹³ç·š">â”</button>
                <button class="btn" onclick="addElement('text','',50,50,2,100,12,'normal','#000','none')" title="å‚ç›´ç·š">â”ƒ</button>
            </div>

            <div class="panel-title">4. å¯ç”¨æ¬„ä½</div>
            <div id="fieldList" style="min-height:100px;"></div>
        </div>

        <!-- CENTER: Canvas -->
        <div class="panel center-panel">
            <div style="margin-bottom:10px;">
                <button class="btn btn-danger" id="clearBgBtn" style="display:none">ğŸ—‘ï¸ æ¸…é™¤èƒŒæ™¯åœ–</button>
            </div>
            <div class="canvas-wrapper">
                <div class="canvas" id="canvas" style="width:210mm; height:297mm;">
                    <div id="splitLine" style="top: 150px;"></div>
                </div>
            </div>
            
            <!-- Table Wizard Modal -->
            <div class="modal-overlay" id="tableModal">
                <div class="modal">
                    <h3 style="margin-bottom:15px">æ’å…¥è¡¨æ ¼ç²¾éˆ</h3>
                    <div class="form-group">
                        <label class="form-label">æ¬„ä½æ•¸ (Columns)</label>
                        <input type="number" id="tblCols" class="form-control" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è³‡æ–™åˆ—æ•¸ (Rows)</label>
                        <input type="number" id="tblRows" class="form-control" value="2" min="1" max="20">
                    </div>
                    <div class="form-group" style="font-size:12px; color:#666">
                        <input type="checkbox" id="autoFill" checked> è‡ªå‹•å¡«å…¥ CSV æ¬„ä½åç¨±èˆ‡è®Šæ•¸
                    </div>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn btn-block" onclick="closeTableModal()">å–æ¶ˆ</button>
                        <button class="btn btn-primary btn-block" onclick="insertTable()">æ’å…¥è¡¨æ ¼</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Settings -->
        <div class="panel right-panel">
            <div class="panel-title">ç‰ˆé¢è¨­å®š</div>
            <div class="form-group"><label class="form-label">ç´™å¼µ</label><select id="pageSize" class="form-control"><option value="a4">A4</option><option value="a5">A5</option><option value="receipt80">80mm æ”¶æ“š</option><option value="custom">è‡ªè¨‚/PDF</option></select></div>
            <div class="form-group"><label class="form-label">æ–¹å‘</label><select id="orient" class="form-control"><option value="portrait">ç›´å‘</option><option value="landscape">æ©«å‘</option></select></div>
            
            <div class="panel-title" style="margin-top:15px">åˆ—å°æ¨¡å¼</div>
            <div class="form-group"><select id="mode" class="form-control"><option value="single">å–®é å–®ç­†</option><option value="group">åˆ†çµ„åˆ—è¡¨</option><option value="grid">ä¸€é å¤šå¼µ (æ¨™ç±¤)</option></select></div>
            
            <div id="grpSet" style="display:none; background:#f0f9eb; padding:10px; border-radius:4px;">
                <div class="form-group"><label class="form-label">åˆ†çµ„æ¬„ä½</label><select id="grpField" class="form-control"></select></div>
                <div class="form-group"><label class="form-label">åˆ†éš”ç·š Y</label><input type="number" id="splitY" class="form-control" value="150"></div>
                <div class="form-group"><label class="form-label">è¡Œé«˜</label><input type="number" id="rowH" class="form-control" value="30"></div>
            </div>
            
            <div id="gridSet" style="display:none; background:#ecf5ff; padding:10px; border-radius:4px;">
                <button class="btn btn-primary btn-block" onclick="autoCalcGrid()">âœ¨ è‡ªå‹•è¨ˆç®—</button>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px">
                    <div><label class="form-label">æ¬„</label><input type="number" id="gCols" class="form-control" value="2"></div>
                    <div><label class="form-label">åˆ—</label><input type="number" id="gRows" class="form-control" value="4"></div>
                </div>
            </div>

            <div class="panel-title" style="margin-top:20px">å±¬æ€§</div>
            <div id="props" style="text-align:center; color:#999; font-size:12px;">é¸æ“‡å…ƒç´ </div>
        </div>
    </div>
    <div id="print-container"></div>

    <script>
        // --- State ---
        const state = { fields: [], elements: [], data: [], selected: null, config: { size: 'a4', orient: 'portrait', w: 210, h: 297, mode: 'single', grpF: '', splitY: 150, rowH: 30, gC: 2, gR: 4, gX: 10, gY: 10 } };
        const el = (id) => document.getElementById(id);
        
        // --- Init ---
        initCanvas(); initDrag();

        // --- Canvas & Layout ---
        function initCanvas() { updSz(); el('pageSize').onchange = (e) => { state.config.size = e.target.value; updSz(); }; el('orient').onchange = (e) => { state.config.orient = e.target.value; updSz(); }; }
        function updSz() {
            const m = { 'a4': [210, 297], 'a5': [148, 210], 'receipt80': [80, 297] };
            let [w, h] = m[state.config.size] || [state.config.w, state.config.h];
            if (state.config.orient === 'landscape' && state.config.size !== 'receipt80' && state.config.size !== 'custom') [w, h] = [h, w];
            state.config.w = w; state.config.h = h;
            el('canvas').style.width = w + 'mm'; el('canvas').style.height = h + 'mm';
            el('canvas').style.height = state.config.size === 'receipt80' ? 'auto' : h + 'mm';
            el('canvas').style.minHeight = state.config.size === 'receipt80' ? '150mm' : '0';
        }

        // --- Table Wizard ---
        function openTableModal() { el('tableModal').style.display = 'flex'; }
        function closeTableModal() { el('tableModal').style.display = 'none'; }
        function insertTable() {
            const rows = parseInt(el('tblRows').value) || 2;
            const cols = parseInt(el('tblCols').value) || 3;
            const auto = el('autoFill').checked;
            const startX = 20, startY = 50;
            const cellW = 35, cellH = 10; // mm to px approx logic handled in addElement (1mm~3.78px) but here we use pixel values directly
            // Using standard pixel sizes for screen: W=120, H=30
            const w = 120, h = 30;

            // Switch to Group mode if inserting many rows
            if(rows > 1) {
                state.config.mode = 'group';
                el('mode').value = 'group';
                updMode();
                state.config.splitY = startY + h; // Set split line below header
                state.config.rowH = h;
                updSplit();
                el('splitY').value = Math.round(state.config.splitY);
            }

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    let type = 'text';
                    let content = '';
                    let bg = 'transparent';
                    let fw = 'normal';

                    // Logic: Row 0 is Header
                    if (r === 0) {
                        bg = '#f0f0f0'; fw = 'bold';
                        content = auto && state.fields[c] ? state.fields[c] : `æ¨™é¡Œ ${c+1}`;
                    } else {
                        // Logic: Row > 0 is Body
                        type = auto && state.fields[c] ? 'field' : 'text';
                        content = auto && state.fields[c] ? state.fields[c] : `å…§å®¹`;
                    }

                    // Only generate 1 body row if in group mode (it will repeat)
                    // But if user asked for static table (rows), generate all.
                    // For flexible "Report" style, usually we generate 1 header row + 1 body row template.
                    
                    addElement(type, content, startX + c * w, startY + r * h, w, h, 14, fw, bg, '1px solid #333');
                }
            }
            closeTableModal();
        }

        // --- PDF Import (Background Only) ---
        el('pdfBtn').onclick = () => el('pdfFile').click();
        el('pdfFile').onchange = async (e) => {
            const f = e.target.files[0]; if (!f) return;
            if(!confirm('åŒ¯å…¥ PDF ç‚ºåº•åœ–ï¼Ÿ(å°‡æ¸…é™¤ç¾æœ‰ç•«å¸ƒ)')) return;
            
            try {
                const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
                const page = await pdf.getPage(1);
                const vp = page.getViewport({ scale: 1.5 });
                const cvs = document.createElement('canvas'); cvs.width = vp.width; cvs.height = vp.height;
                await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
                
                const rawVp = page.getViewport({ scale: 1.0 });
                const wMm = rawVp.width * 0.352778, hMm = rawVp.height * 0.352778;
                
                state.config.size = 'custom'; state.config.w = wMm; state.config.h = hMm;
                el('pageSize').value = 'custom';
                el('canvas').style.backgroundImage = `url(${cvs.toDataURL()})`;
                el('canvas').style.backgroundSize = '100% 100%';
                el('clearBgBtn').style.display = 'inline-block';
                
                state.elements = []; el('canvas').innerHTML = '<div id="splitLine"></div>';
                updSz();
            } catch(err) { alert('PDF éŒ¯èª¤'); }
        };
        el('clearBgBtn').onclick = () => { el('canvas').style.backgroundImage = 'none'; el('clearBgBtn').style.display = 'none'; };

        // --- Elements ---
        function addElement(type, c, x, y, w = 120, h = 30, fs = 14, fw = 'normal', bg = 'transparent', br = '1px dashed #ccc') {
            const id = 'el-' + Math.random().toString(36).substr(2, 9);
            const item = { id, type, content: c, x, y, width: w, height: h, fontSize: fs, fontWeight: fw, backgroundColor: bg, border: br, fieldName: type === 'field' ? c : null };
            state.elements.push(item); renderEl(item); return item;
        }

        function renderEl(item) {
            const d = document.createElement('div'); d.id = item.id; d.className = 'canvas-element'; updEl(d, item);
            d.innerHTML = `<div class="canvas-element-value">${item.type === 'field' ? `[${item.content}]` : item.content}</div><div class="resize-handle"></div>`;
            d.onmousedown = (e) => { if (e.target.className.includes('resize')) return; e.stopPropagation(); selEl(item); drag(e, item, d, 'move'); };
            d.querySelector('.resize-handle').onmousedown = (e) => { e.stopPropagation(); drag(e, item, d, 'resize'); };
            el('canvas').appendChild(d);
        }

        function drag(e, item, d, mode) {
            const sx = e.clientX, sy = e.clientY;
            const startVal = mode === 'move' ? { x: item.x, y: item.y } : { w: item.width, h: item.height };
            const mv = (ev) => {
                if (mode === 'move') { item.x = startVal.x + (ev.clientX - sx); item.y = startVal.y + (ev.clientY - sy); }
                else { item.width = Math.max(5, startVal.w + (ev.clientX - sx)); item.height = Math.max(5, startVal.h + (ev.clientY - sy)); renderProps(item); }
                updEl(d, item);
            };
            const up = () => { document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up); };
            document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
        }

        function updEl(d, item) {
            Object.assign(d.style, { left: item.x + 'px', top: item.y + 'px', width: item.width + 'px', height: item.height + 'px', fontSize: item.fontSize + 'px', fontWeight: item.fontWeight, background: item.backgroundColor, border: item.border });
        }
        function selEl(item) { state.selected = item; document.querySelectorAll('.selected').forEach(x => x.classList.remove('selected')); el(item.id).classList.add('selected'); renderProps(item); }

        function renderProps(item) {
            el('props').innerHTML = `
                <div class="form-group"><label>å…§å®¹</label><input class="form-control" value="${item.content}" oninput="setProp('${item.id}','content',this.value)"></div>
                <div class="form-group"><label>å­—é«”å¤§å°</label><input type="number" class="form-control" value="${item.fontSize}" oninput="setProp('${item.id}','fontSize',this.value)"></div>
                <div class="form-group"><label>èƒŒæ™¯è‰²</label><input type="color" style="width:100%" value="${item.backgroundColor === 'transparent' ? '#ffffff' : item.backgroundColor}" oninput="setProp('${item.id}','backgroundColor',this.value)"></div>
                <div class="form-group"><label>é‚Šæ¡†</label><select class="form-control" onchange="setProp('${item.id}','border',this.value)"><option value="none">ç„¡</option><option value="1px solid #000">å¯¦ç·š</option><option value="2px solid #000">ç²—å¯¦ç·š</option><option value="1px dashed #000">è™›ç·š</option></select></div>
                <button class="btn btn-danger btn-block" onclick="delEl('${item.id}')">åˆªé™¤</button>
            `;
        }
        window.setProp = (id, k, v) => { const item = state.elements.find(x => x.id === id); if (item) { item[k] = v; updEl(el(id), item); if (k === 'content') el(id).querySelector('.canvas-element-value').innerText = item.type === 'field' ? `[${v}]` : v; } };
        window.delEl = (id) => { state.elements = state.elements.filter(x => x.id !== id); el(id).remove(); el('props').innerHTML = ''; };

        // --- File & Drag ---
        el('dataBtn').onclick = () => el('dataFile').click();
        el('dataFile').onchange = (e) => {
            const f = e.target.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                state.data = f.name.endsWith('.json') ? JSON.parse(ev.target.result) : parseCSV(ev.target.result);
                state.fields = Object.keys(state.data[0] || {});
                renderFields(); el('fileInfo').innerText = `âœ… ${state.data.length} ç­†è³‡æ–™`;
            }; r.readAsText(f);
        };
        function parseCSV(t) { const [h, ...r] = t.trim().split('\n'); const ks = h.split(',').map(s => s.trim()); return r.map(l => l.split(',').reduce((a, v, i) => ({ ...a, [ks[i]]: v.trim() }), {})); }
        function renderFields() {
            el('fieldList').innerHTML = state.fields.map(f => `<div class="field-item" draggable="true" data-f="${f}">ğŸ“„ ${f}</div>`).join('');
            el('grpField').innerHTML = `<option value="">--</option>` + state.fields.map(f => `<option value="${f}">${f}</option>`).join('');
            initDrag();
        }
        function initDrag() {
            el('fieldList').ondragstart = (e) => { e.dataTransfer.setData('type', 'field'); e.dataTransfer.setData('val', e.target.dataset.f); };
            el('canvas').ondragover = (e) => e.preventDefault();
            el('canvas').ondrop = (e) => { e.preventDefault(); const t = e.dataTransfer.getData('type'); if (t) addElement(t, e.dataTransfer.getData('val'), e.clientX - el('canvas').getBoundingClientRect().left, e.clientY - el('canvas').getBoundingClientRect().top); };
            let sp = false; el('splitLine').onmousedown = () => sp = true;
            document.onmousemove = (e) => { if (sp) { state.config.splitY = Math.max(0, e.clientY - el('canvas').getBoundingClientRect().top); updSplit(); el('splitY').value = Math.round(state.config.splitY); } };
            document.onmouseup = () => sp = false;
        }
        function updSplit() { el('splitLine').style.top = state.config.splitY + 'px'; }

        // --- Settings ---
        el('mode').onchange = (e) => { state.config.mode = e.target.value; updMode(); };
        function updMode() {
            const m = state.config.mode;
            el('grpSet').style.display = m === 'group' ? 'block' : 'none';
            el('gridSet').style.display = m === 'grid' ? 'block' : 'none';
            el('splitLine').style.display = m === 'group' ? 'block' : 'none';
        }
        ['gCols', 'gRows', 'gX', 'gY'].forEach(k => el(k).onchange = (e) => state.config[k] = +e.target.value);
        el('splitY').onchange = (e) => { state.config.splitY = +e.target.value; updSplit(); };
        el('rowH').onchange = (e) => state.config.rowH = +e.target.value;

        window.autoCalcGrid = () => {
            if (!state.elements.length) return alert('ç©ºç•«å¸ƒ');
            let mx = 0, my = 0; state.elements.forEach(e => { mx = Math.max(mx, e.x + e.width); my = Math.max(my, e.y + e.height); });
            const MM = 3.78, pW = state.config.w * MM, pH = state.config.h * MM, m = 5 * MM;
            const c = Math.floor((pW - m * 2 + state.config.gX) / (mx + state.config.gX));
            const r = Math.floor((pH - m * 2 + state.config.gY) / (my + state.config.gY));
            if (c < 1 || r < 1) return alert('å…§å®¹å¤ªå¤§');
            state.config.gC = c; state.config.gR = r; el('gCols').value = c; el('gRows').value = r; alert(`è¨ˆç®—: ${c}x${r}`);
        };

        // --- Print ---
        el('printBtn').onclick = () => {
            const c = el('print-container'); c.innerHTML = '';
            if (!state.data.length && state.elements.length) { const d = {}; state.fields.forEach(f => d[f] = `(${f})`); var old = state.data; state.data = [d]; runP(c); state.data = old; return; }
            if (!state.data.length) return alert('ç„¡æ•¸æ“š');
            runP(c);
        };

        function runP(c) {
            const s = document.createElement('style'); s.innerHTML = `@media print{@page{size:${state.config.size === 'custom' ? 'auto' : state.config.size} ${state.config.orient};margin:0;}}`; c.appendChild(s);
            const m = state.config.mode;
            if (m === 'single') pS(c); else if (m === 'group') pG(c); else if (m === 'grid') pGd(c);
            setTimeout(() => { window.print(); c.innerHTML = ''; }, 500);
        }

        function mkPg() { const d = document.createElement('div'); d.className = 'print-page'; d.style.width = state.config.w + 'mm'; d.style.height = state.config.size === 'receipt80' ? 'auto' : state.config.h + 'mm'; return d; }
        function mkEl(item, r, dx = 0, dy = 0) {
            const d = document.createElement('div'); d.className = 'print-element';
            const fx = item.x + dx, fy = item.y + dy;
            Object.assign(d.style, { left: fx + 'px', top: fy + 'px', width: item.width + 'px', height: item.height + 'px', fontSize: item.fontSize + 'px', fontWeight: item.fontWeight, background: item.backgroundColor, border: item.border });
            d.innerText = item.type === 'field' && r ? (r[item.fieldName] || '') : item.content; d.dataset.b = fy + item.height; return d;
        }

        function pS(c) { state.data.forEach(r => { const p = mkPg(); let mb = 0; state.elements.forEach(e => { const x = mkEl(e, r); p.appendChild(x); mb = Math.max(mb, +x.dataset.b); }); if (state.config.size === 'receipt80') p.style.height = (mb + 20) + 'px'; c.appendChild(p); }); }
        function pG(c) {
            const g = {}, kf = state.config.grpF; state.data.forEach(r => { const k = kf ? r[kf] : 'A'; if (!g[k]) g[k] = []; g[k].push(r); });
            const hE = state.elements.filter(e => e.y < state.config.splitY), dE = state.elements.filter(e => e.y >= state.config.splitY); dE.forEach(e => e.oy = e.y - state.config.splitY);
            const pH = state.config.size === 'receipt80' ? 99999 : 1050;
            Object.values(g).forEach(rs => {
                let p = mkPg(), cm = 0; const rh = () => hE.forEach(e => { const x = mkEl(e, rs[0]); p.appendChild(x); cm = Math.max(cm, +x.dataset.b); }); rh();
                let y = state.config.splitY;
                rs.forEach(r => { if (y + state.config.rowH > pH) { p = mkPg(); c.appendChild(p); rh(); y = state.config.splitY; cm = y; } dE.forEach(e => { const x = mkEl(e, r, 0, y + e.oy - e.y); x.style.top = (y + e.oy) + 'px'; p.appendChild(x); cm = Math.max(cm, y + e.oy + e.height); }); y += state.config.rowH; });
                if (state.config.size === 'receipt80') p.style.height = (cm + 50) + 'px';
            });
        }
        function pGd(c) {
            const { gC, gR, gX, gY } = state.config;
            let mx = 0, my = 0; state.elements.forEach(e => { mx = Math.max(mx, e.x + e.width); my = Math.max(my, e.y + e.height); });
            const cW = mx + gX, cH = my + gY, MM = 3.78, pW = state.config.w * MM, pH = state.config.h * MM;
            const tW = cW * gC - gX, tH = cH * gR - gY;
            const sx = Math.max(20, (pW - tW) / 2), sy = Math.max(20, (pH - tH) / 2);
            let p = mkPg(), i = 0;
            state.data.forEach(r => { if (i >= gC * gR) { p = mkPg(); c.appendChild(p); i = 0; } const col = i % gC, row = Math.floor(i / gC); state.elements.forEach(e => p.appendChild(mkEl(e, r, sx + col * cW, sy + row * cH))); i++; });
        }
    </script>
</body>
</html>
