<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Report Studio v4.0 - å…¨èƒ½ç‰ˆé¢è¨­è¨ˆ</title>
    <style>
        :root {
            --primary: #2186c4; --primary-hover: #1a6a9e;
            --bg: #f0f2f5; --surface: #ffffff;
            --text: #333; --border: #dcdfe6;
            --success: #67c23a; --danger: #f56c6c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout */
        .header { background: #2b3a42; color: white; padding: 0 20px; height: 60px; display: flex; justify-content: space-between; align-items: center; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .panel { background: var(--surface); display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .left-panel { width: 260px; padding: 15px; overflow-y: auto; }
        .center-panel { flex: 1; background: #525659; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow: auto; }
        .right-panel { width: 320px; padding: 15px; overflow-y: auto; border-left: 1px solid var(--border); }
        .panel-title { font-size: 14px; font-weight: 700; color: #606266; margin-bottom: 12px; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        
        /* Templates & Upload */
        .upload-area { border: 2px dashed var(--border); padding: 15px; text-align: center; cursor: pointer; color: #909399; font-size: 13px; margin-bottom: 10px; }
        .upload-area:hover { border-color: var(--primary); background: #ecf5ff; }
        .field-item { padding: 6px 10px; background: #f4f4f5; border: 1px solid #e9e9eb; margin-bottom: 5px; cursor: grab; font-size: 12px; }
        
        .tpl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 15px; }
        .btn-tpl { padding: 6px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 12px; text-align: center; }
        .btn-tpl:hover { border-color: var(--primary); color: var(--primary); }

        /* Canvas */
        .canvas-wrapper { box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: 0.3s; margin: auto; }
        .canvas {
            background: white; position: relative; overflow: hidden;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px; transform-origin: top center;
        }
        .canvas-element {
            position: absolute; cursor: move; display: flex; align-items: center; overflow: hidden;
            border: 1px dashed #ccc; box-sizing: border-box;
        }
        .canvas-element.selected { border: 2px solid var(--primary); z-index: 100; background: rgba(33, 150, 243, 0.05); }
        .canvas-element-value { pointer-events: none; width: 100%; padding: 2px; }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: var(--primary); cursor: nwse-resize; display: none; }
        .canvas-element.selected .resize-handle { display: block; }
        
        /* Split Line */
        #splitLine { position: absolute; left: 0; width: 100%; height: 0; border-top: 2px dashed #f56c6c; z-index: 90; cursor: ns-resize; display: none; }

        /* Controls */
        .form-group { margin-bottom: 10px; }
        .form-label { font-size: 12px; color: #666; display: block; margin-bottom: 3px; }
        .form-control { width: 100%; padding: 5px; border: 1px solid var(--border); font-size: 13px; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; color: white; background: #666; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--success); } .btn-danger { background: var(--danger); }
        .btn-block { width: 100%; display: flex; justify-content: center;}

        /* Print Logic */
        @media print {
            @page { margin: 0; }
            body * { visibility: hidden; }
            #print-container, #print-container * { visibility: visible; }
            #print-container { position: absolute; left: 0; top: 0; width: 100%; }
            .print-page { position: relative; margin: 0 auto; background: white; page-break-after: always; break-after: page; overflow: hidden; }
            .print-element { position: absolute; display: flex; align-items: center; padding: 2px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="font-weight: bold;">ğŸ“Š Pro Report Studio v4.0</div>
        <div><button class="btn btn-success" id="printBtn">ğŸ–¨ï¸ åˆ—å° / åŒ¯å‡º PDF</button></div>
    </div>

    <div class="main-layout">
        <!-- LEFT PANEL -->
        <div class="panel left-panel">
            <div class="panel-title">1. æ•¸æ“šæº</div>
            <div class="upload-area" id="uploadArea">ğŸ“‚ ä¸Šå‚³ CSV / JSON<input type="file" id="fileInput" hidden></div>
            <div id="fileInfo" style="font-size:12px; color:#67c23a; margin-bottom:10px;"></div>
            
            <div class="panel-title">2. å¿«é€Ÿç¯„æœ¬</div>
            <div class="tpl-grid">
                <div class="btn-tpl" onclick="tpl('table')">ğŸ“‘ è‡ªå‹•è¡¨æ ¼</div>
                <div class="btn-tpl" onclick="tpl('receipt')">ğŸ§¾ ç†±æ„Ÿæ‡‰æ”¶æ“š</div>
                <div class="btn-tpl" onclick="tpl('labels')">ğŸ·ï¸ æ¨™ç±¤è²¼ç´™(8æ ¼)</div>
                <div class="btn-tpl" onclick="tpl('invoice')">ğŸ’° å•†æ¥­ç™¼ç¥¨</div>
            </div>

            <div class="panel-title">3. å¯ç”¨æ¬„ä½</div>
            <div id="fieldList" style="min-height: 100px;"></div>
        </div>

        <!-- CENTER CANVAS -->
        <div class="panel center-panel">
            <div style="margin-bottom:10px; display:flex; gap:10px;">
                <button class="btn" style="background:white; color:#333" id="addTextBtn">â• æ–‡å­—</button>
                <button class="btn" style="background:white; color:#333" id="addTitleBtn">ğŸ“Œ æ¨™é¡Œ</button>
            </div>
            <div class="canvas-wrapper">
                <div class="canvas" id="canvas" style="width:210mm; height:297mm;">
                    <div id="splitLine" style="top: 150px;"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT SETTINGS -->
        <div class="panel right-panel">
            <div class="panel-title">ğŸ“„ ç‰ˆé¢èˆ‡ç´™å¼µ</div>
            <div class="form-group">
                <label class="form-label">ç´™å¼µå¤§å°</label>
                <select class="form-control" id="pageSizeSelect">
                    <option value="a4">A4 (210 x 297 mm)</option>
                    <option value="a5">A5 (148 x 210 mm)</option>
                    <option value="b5">B5 (176 x 250 mm)</option>
                    <option value="receipt80">80mm æ”¶æ“š (ç„¡é™é•·)</option>
                    <option value="custom">è‡ªè¨‚å°ºå¯¸</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">æ–¹å‘</label>
                <select class="form-control" id="orientationSelect">
                    <option value="portrait">ç›´å‘ (Portrait)</option>
                    <option value="landscape">æ©«å‘ (Landscape)</option>
                </select>
            </div>

            <div class="panel-title" style="margin-top:10px">ğŸ–¨ï¸ åˆ—å°æ¨¡å¼</div>
            <div class="form-group">
                <label class="form-label">æ’åˆ—æ–¹å¼</label>
                <select class="form-control" id="reportMode">
                    <option value="single">å–®é å–®ç­† (æ¯ç­†ä¸€é )</option>
                    <option value="group">è¡¨æ ¼åˆ—è¡¨ (Master-Detail)</option>
                    <option value="grid">ä¸€é å¤šå¼µ (æµ·å ±/æ¨™ç±¤)</option>
                </select>
            </div>

            <!-- Settings: Table Mode -->
            <div id="groupSettings" style="display:none; background:#f0f9eb; padding:8px; border-radius:4px;">
                <div class="form-group">
                    <label class="form-label">åˆ—è¡¨åˆ†çµ„æ¬„ä½</label>
                    <select class="form-control" id="groupFieldSelect"></select>
                </div>
                <div class="form-group"><label class="form-label">åˆ†éš”ç·š Y (px)</label><input type="number" class="form-control" id="splitYInput" value="150"></div>
                <div class="form-group"><label class="form-label">è¡Œé«˜ (px)</label><input type="number" class="form-control" id="rowHeightInput" value="30"></div>
            </div>

            <!-- Settings: Grid/Poster Mode -->
            <div id="gridSettings" style="display:none; background:#ecf5ff; padding:8px; border-radius:4px;">
                <div style="font-size:12px; color:#409eff; margin-bottom:5px;">âš ï¸ è«‹å°‡ç•«å¸ƒè¦–ç‚ºã€Œå–®å¼µè²¼ç´™ã€çš„å¤§å°ä¾†è¨­è¨ˆ</div>
                <div class="form-group"><label class="form-label">æ©«å‘å¹¾æ¬„ (Columns)</label><input type="number" class="form-control" id="gridCols" value="2"></div>
                <div class="form-group"><label class="form-label">ç›´å‘å¹¾åˆ— (Rows)</label><input type="number" class="form-control" id="gridRows" value="4"></div>
                <div class="form-group"><label class="form-label">æ°´å¹³é–“è· (px)</label><input type="number" class="form-control" id="gridGapX" value="10"></div>
                <div class="form-group"><label class="form-label">å‚ç›´é–“è· (px)</label><input type="number" class="form-control" id="gridGapY" value="10"></div>
            </div>

            <div class="panel-title" style="margin-top:20px">âœ¨ å…ƒç´ å±¬æ€§</div>
            <div id="propPanel" style="font-size:12px; color:#999; text-align:center; padding:10px;">é¸æ“‡å…ƒç´ ä»¥ç·¨è¼¯</div>
        </div>
    </div>

    <div id="print-container"></div>

    <script>
        // --- State ---
        const state = {
            fields: [], elements: [], data: [], selectedElement: null,
            config: {
                pageSize: 'a4', orientation: 'portrait',
                widthMm: 210, heightMm: 297,
                mode: 'single', // single, group, grid
                groupField: '', splitY: 150, rowHeight: 30,
                gridCols: 2, gridRows: 4, gridGapX: 10, gridGapY: 10
            }
        };

        const els = {
            canvas: document.getElementById('canvas'),
            fieldList: document.getElementById('fieldList'),
            propPanel: document.getElementById('propPanel'),
            splitLine: document.getElementById('splitLine'),
            modeSelect: document.getElementById('reportMode'),
            sizeSelect: document.getElementById('pageSizeSelect'),
            orientSelect: document.getElementById('orientationSelect')
        };

        // --- Init ---
        initCanvas();
        initDrag();
        
        // --- 1. Canvas & Page Size Logic ---
        function initCanvas() {
            updateCanvasSize();
            els.sizeSelect.onchange = (e) => { state.config.pageSize = e.target.value; updateCanvasSize(); };
            els.orientSelect.onchange = (e) => { state.config.orientation = e.target.value; updateCanvasSize(); };
        }

        function updateCanvasSize() {
            const sizeMap = {
                'a4': [210, 297], 'a5': [148, 210], 'b5': [176, 250],
                'receipt80': [80, 297] // Height is just visual for receipt
            };
            
            let [w, h] = sizeMap[state.config.pageSize] || [210, 297];
            
            // Swap for landscape (except receipt)
            if (state.config.orientation === 'landscape' && state.config.pageSize !== 'receipt80') {
                [w, h] = [h, w];
            }

            state.config.widthMm = w;
            state.config.heightMm = h;
            
            els.canvas.style.width = w + 'mm';
            els.canvas.style.height = h + 'mm';

            // Special UI for receipt
            if(state.config.pageSize === 'receipt80') {
                els.canvas.style.height = 'auto';
                els.canvas.style.minHeight = '150mm';
                els.canvas.style.borderBottom = '3px jagged #ccc'; // Visual effect
            }
        }

        // --- 2. Templates ---
        window.tpl = (type) => {
            if(!confirm('é€™å°‡æ¸…é™¤ç•¶å‰ç•«å¸ƒï¼Œç¢ºå®šå—ï¼Ÿ')) return;
            state.elements = [];
            els.canvas.innerHTML = '<div id="splitLine"></div>';
            
            if (type === 'table') {
                setPage('a4', 'portrait', 'group');
                const colW = 120, rowH = 30;
                addElement('title', 'â—‹â—‹å ±è¡¨', 20, 20, 200, 40, 24, 'bold');
                state.config.splitY = 100;
                
                state.fields.forEach((f, i) => {
                    const x = 20 + i * colW;
                    addElement('text', f, x, 70, colW, 30, 13, 'bold', '#f5f5f5', '1px solid #333'); // Header
                    addElement('field', f, x, 100, colW, 30, 13, 'normal', 'transparent', '1px solid #333'); // Body
                });
                updateSplitLine();
            }
            else if (type === 'receipt') {
                setPage('receipt80', 'portrait', 'group');
                addElement('title', 'STORE RECEIPT', 5, 10, 280, 30, 18, 'bold');
                addElement('text', '--------------------------------', 0, 40, 300, 20);
                addElement('text', 'Date: 2023-11-27', 5, 60, 200, 20);
                
                state.config.splitY = 100;
                // Simple list layout
                addElement('text', 'Item', 5, 80, 150, 20, 12, 'bold');
                addElement('text', 'Price', 200, 80, 80, 20, 12, 'bold');
                
                if(state.fields.length >= 2) {
                    addElement('field', state.fields[0], 5, 100, 150, 20);
                    addElement('field', state.fields[1], 200, 100, 80, 20);
                }
                updateSplitLine();
            }
            else if (type === 'labels') {
                // Label Mode: Use Grid
                setPage('a4', 'portrait', 'grid');
                state.config.gridCols = 2;
                state.config.gridRows = 4;
                state.config.gridGapX = 10;
                state.config.gridGapY = 10;
                document.getElementById('gridCols').value = 2;
                document.getElementById('gridRows').value = 4;

                // Draw one label box (visual guide)
                // A4 width ~790px. 2 cols + gaps -> approx 350px width per label
                const labelW = 350, labelH = 200;
                
                // Add border container for the label
                addElement('text', '', 0, 0, labelW, labelH, 12, 'normal', 'transparent', '2px solid #ccc');
                addElement('title', 'å“¡å·¥è­‰', 20, 20, 100, 30, 16, 'bold');
                
                let y = 60;
                state.fields.slice(0, 3).forEach(f => {
                    addElement('text', f+':', 20, y, 80, 25, 12, 'bold');
                    addElement('field', f, 100, y, 200, 25, 12, 'normal', '#eee');
                    y += 30;
                });
            }
            else if (type === 'invoice') {
                setPage('a4', 'portrait', 'single');
                addElement('title', 'INVOICE', 500, 40, 200, 40, 30, 'bold');
                addElement('text', 'No. #123456', 500, 80, 200, 30);
                // Demo
                addElement('text', 'Bill To:', 40, 120, 100, 30, 14, 'bold');
                if(state.fields.length > 0) addElement('field', state.fields[0], 40, 150, 300, 30, 14, 'normal', '#f9f9f9', '1px solid #ccc');
            }
        };

        function setPage(size, orient, mode) {
            els.sizeSelect.value = state.config.pageSize = size;
            els.orientSelect.value = state.config.orientation = orient;
            els.modeSelect.value = state.config.mode = mode;
            updateCanvasSize();
            updateSettingsUI();
        }

        // --- 3. Mode & Logic ---
        els.modeSelect.onchange = (e) => {
            state.config.mode = e.target.value;
            updateSettingsUI();
        };

        function updateSettingsUI() {
            const m = state.config.mode;
            document.getElementById('groupSettings').style.display = m === 'group' ? 'block' : 'none';
            document.getElementById('gridSettings').style.display = m === 'grid' ? 'block' : 'none';
            els.splitLine.style.display = m === 'group' ? 'block' : 'none';
        }

        // Grid Settings Listeners
        ['gridCols', 'gridRows', 'gridGapX', 'gridGapY'].forEach(id => {
            document.getElementById(id).onchange = (e) => state.config[id] = parseInt(e.target.value);
        });
        
        // Group Settings
        document.getElementById('splitYInput').onchange = (e) => { state.config.splitY = +e.target.value; updateSplitLine(); };
        document.getElementById('rowHeightInput').onchange = (e) => state.config.rowHeight = +e.target.value;

        // --- 4. Element CRUD ---
        document.getElementById('addTextBtn').onclick = () => addElement('text', 'æ–‡å­—', 20, 20);
        document.getElementById('addTitleBtn').onclick = () => addElement('title', 'æ¨™é¡Œ', 20, 20, 150, 40, 20, 'bold');

        function addElement(type, content, x, y, w=120, h=30, fs=14, fw='normal', bg='transparent', border='1px dashed #ccc') {
            const el = {
                id: 'el-' + Math.random().toString(36).substr(2, 9),
                type, content, x, y, width: w, height: h,
                fontSize: fs, fontWeight: fw, backgroundColor: bg, border,
                fieldName: type === 'field' ? content : null
            };
            state.elements.push(el);
            renderEl(el);
            return el;
        }

        function renderEl(el) {
            const div = document.createElement('div');
            div.id = el.id;
            div.className = 'canvas-element';
            updateElStyle(div, el);
            
            div.innerHTML = `<div class="canvas-element-value">${el.type==='field' ? `[${el.content}]` : el.content}</div><div class="resize-handle"></div>`;
            
            div.onmousedown = (e) => {
                if(e.target.classList.contains('resize-handle')) return;
                e.stopPropagation(); selectEl(el);
                const sx = e.clientX, sy = e.clientY, ox = el.x, oy = el.y;
                const mv = (ev) => { el.x = ox + (ev.clientX - sx); el.y = oy + (ev.clientY - sy); updateElStyle(div, el); };
                const up = () => { document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up); };
                document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
            };

            const hdl = div.querySelector('.resize-handle');
            hdl.onmousedown = (e) => {
                e.stopPropagation();
                const sx = e.clientX, sy = e.clientY, ow = el.width, oh = el.height;
                const rz = (ev) => { el.width = Math.max(10, ow+(ev.clientX-sx)); el.height = Math.max(10, oh+(ev.clientY-sy)); updateElStyle(div, el); renderProps(el); };
                const st = () => { document.removeEventListener('mousemove', rz); document.removeEventListener('mouseup', st); };
                document.addEventListener('mousemove', rz); document.addEventListener('mouseup', st);
            };
            els.canvas.appendChild(div);
        }

        function updateElStyle(div, el) {
            div.style.left = el.x + 'px'; div.style.top = el.y + 'px';
            div.style.width = el.width + 'px'; div.style.height = el.height + 'px';
            div.style.fontSize = el.fontSize + 'px'; div.style.fontWeight = el.fontWeight;
            div.style.background = el.backgroundColor; div.style.border = el.border;
        }

        function selectEl(el) {
            state.selectedElement = el;
            document.querySelectorAll('.canvas-element').forEach(d => d.classList.remove('selected'));
            document.getElementById(el.id).classList.add('selected');
            renderProps(el);
        }

        function renderProps(el) {
            els.propPanel.innerHTML = `
                <div class="form-group"><label class="form-label">å…§å®¹</label><input class="form-control" value="${el.content}" oninput="setProp('${el.id}','content',this.value)"></div>
                <div class="form-group"><label class="form-label">å­—é«”å¤§å°</label><input type="number" class="form-control" value="${el.fontSize}" oninput="setProp('${el.id}','fontSize',this.value)"></div>
                <div class="form-group"><label class="form-label">èƒŒæ™¯è‰²</label><input type="color" style="width:100%" value="${el.backgroundColor==='transparent'?'#ffffff':el.backgroundColor}" oninput="setProp('${el.id}','backgroundColor',this.value)"></div>
                <div class="form-group"><label class="form-label">é‚Šæ¡†</label><select class="form-control" onchange="setProp('${el.id}','border',this.value)">
                    <option value="none" ${el.border==='none'?'selected':''}>ç„¡</option>
                    <option value="1px solid #000" ${el.border.includes('solid')?'selected':''}>å¯¦ç·š</option>
                    <option value="1px dashed #000" ${el.border.includes('dashed')?'selected':''}>è™›ç·š</option>
                </select></div>
                <button class="btn btn-danger btn-block" onclick="delEl('${el.id}')">åˆªé™¤</button>
            `;
        }

        window.setProp = (id, k, v) => {
            const el = state.elements.find(e => e.id === id);
            if(el) {
                el[k] = v;
                const div = document.getElementById(id);
                updateElStyle(div, el);
                if(k==='content') div.querySelector('.canvas-element-value').innerText = el.type==='field'?`[${v}]`:v;
            }
        };
        window.delEl = (id) => { state.elements = state.elements.filter(e=>e.id!==id); document.getElementById(id).remove(); els.propPanel.innerHTML=''; };

        // --- 5. Upload & Drag ---
        document.getElementById('uploadArea').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                state.data = file.name.endsWith('.json') ? JSON.parse(ev.target.result) : parseCSV(ev.target.result);
                state.fields = Object.keys(state.data[0]||{});
                renderFields();
                document.getElementById('fileInfo').innerText = `âœ… ${state.data.length} ç­†æ•¸æ“š`;
            };
            reader.readAsText(file);
        };
        function parseCSV(t) { const [h,...r]=t.trim().split('\n'); const ks=h.split(',').map(s=>s.trim()); return r.map(l=>l.split(',').reduce((a,v,i)=>({...a,[ks[i]]:v.trim()}),{})); }
        function renderFields() {
            els.fieldList.innerHTML = state.fields.map(f => `<div class="field-item" draggable="true" data-f="${f}">ğŸ“„ ${f}</div>`).join('');
            const sel = document.getElementById('groupFieldSelect');
            sel.innerHTML = `<option value="">--æœªé¸æ“‡--</option>` + state.fields.map(f=>`<option value="${f}">${f}</option>`).join('');
        }

        function initDrag() {
            els.fieldList.addEventListener('dragstart', e => { e.dataTransfer.setData('type','field'); e.dataTransfer.setData('val', e.target.dataset.f); });
            els.canvas.addEventListener('dragover', e => e.preventDefault());
            els.canvas.addEventListener('drop', e => {
                e.preventDefault();
                const type = e.dataTransfer.getData('type');
                if(!type) return;
                const rect = els.canvas.getBoundingClientRect();
                addElement(type, e.dataTransfer.getData('val'), e.clientX-rect.left, e.clientY-rect.top);
            });
            
            // Split line drag logic
            let spDrag = false;
            els.splitLine.onmousedown = () => spDrag = true;
            document.onmousemove = (e) => {
                if(spDrag) {
                    const rect = els.canvas.getBoundingClientRect();
                    state.config.splitY = Math.max(0, e.clientY - rect.top);
                    updateSplitLine();
                    document.getElementById('splitYInput').value = Math.round(state.config.splitY);
                }
            };
            document.onmouseup = () => spDrag = false;
        }

        function updateSplitLine() { els.splitLine.style.top = state.config.splitY + 'px'; }

        // --- 6. PRINT ENGINE (The Heart) ---
        document.getElementById('printBtn').onclick = () => {
            const ctr = document.getElementById('print-container');
            ctr.innerHTML = '';
            if(!state.data.length) return alert('ç„¡æ•¸æ“š');

            // Apply page size styles to CSS
            const style = document.createElement('style');
            style.innerHTML = `@media print { @page { size: ${state.config.pageSize === 'custom' ? 'auto' : state.config.pageSize} ${state.config.orientation}; margin: 0; } }`;
            ctr.appendChild(style);

            const mode = state.config.mode;
            if(mode === 'single') printSingle(ctr);
            else if(mode === 'group') printGroup(ctr);
            else if(mode === 'grid') printGrid(ctr);

            setTimeout(() => window.print(), 500);
        };

        function createPage() {
            const div = document.createElement('div');
            div.className = 'print-page';
            div.style.width = state.config.widthMm + 'mm';
            div.style.height = state.config.pageSize === 'receipt80' ? 'auto' : (state.config.heightMm + 'mm');
            return div;
        }

        function createEl(el, row, dx=0, dy=0) {
            const div = document.createElement('div');
            div.className = 'print-element';
            div.style.left = (el.x + dx) + 'px'; div.style.top = (el.y + dy) + 'px';
            div.style.width = el.width + 'px'; div.style.height = el.height + 'px';
            div.style.fontSize = el.fontSize + 'px'; div.style.fontWeight = el.fontWeight;
            div.style.background = el.backgroundColor; div.style.border = el.border;
            div.innerText = el.type === 'field' && row ? (row[el.fieldName]||'') : el.content;
            return div;
        }

        // Mode 1: Single
        function printSingle(ctr) {
            state.data.forEach(row => {
                const pg = createPage();
                state.elements.forEach(el => pg.appendChild(createEl(el, row)));
                ctr.appendChild(pg);
            });
        }

        // Mode 2: Master-Detail (Group)
        function printGroup(ctr) {
            const groups = {};
            const keyF = state.config.groupField;
            state.data.forEach(r => { const k = keyF ? r[keyF] : 'ALL'; if(!groups[k]) groups[k]=[]; groups[k].push(r); });

            const { splitY, rowHeight } = state.config;
            const hEls = state.elements.filter(e => e.y < splitY);
            const dEls = state.elements.filter(e => e.y >= splitY);
            dEls.forEach(e => e._oy = e.y - splitY);

            // Calculate pixels per mm for page break (approx 3.78 px/mm) but easier to use fixed logic
            const pageH = state.config.pageSize === 'receipt80' ? 99999 : 1050; 

            Object.values(groups).forEach(rows => {
                let pg = createPage();
                ctr.appendChild(pg);
                const renderH = () => hEls.forEach(e => pg.appendChild(createEl(e, rows[0])));
                renderH();
                
                let y = splitY;
                rows.forEach(row => {
                    if(y + rowHeight > pageH) {
                        pg = createPage(); ctr.appendChild(pg); renderH(); y = splitY;
                    }
                    dEls.forEach(e => pg.appendChild(createEl(e, row, 0, y + e._oy - e.y))); // Math trick to offset correctly
                    y += rowHeight;
                });
            });
        }

        // Mode 3: Grid / Labels (Poster)
        function printGrid(ctr) {
            const { gridCols, gridRows, gridGapX, gridGapY } = state.config;
            // Assuming the user designed ONE label starting at 0,0 or wherever.
            // We need to calculate how much to shift.
            
            // Auto-detect cell size based on right-most and bottom-most element
            let maxX = 0, maxY = 0;
            state.elements.forEach(e => {
                maxX = Math.max(maxX, e.x + e.width);
                maxY = Math.max(maxY, e.y + e.height);
            });
            const cellW = maxX + gridGapX;
            const cellH = maxY + gridGapY;

            let pg = createPage();
            ctr.appendChild(pg);
            let idx = 0;

            state.data.forEach(row => {
                if(idx >= gridCols * gridRows) {
                    pg = createPage();
                    ctr.appendChild(pg);
                    idx = 0;
                }
                
                // Calculate Grid Position
                const col = idx % gridCols;
                const r = Math.floor(idx / gridCols);
                const offsetX = col * cellW;
                const offsetY = r * cellH;

                state.elements.forEach(el => {
                    pg.appendChild(createEl(el, row, offsetX, offsetY));
                });
                
                idx++;
            });
        }
    </script>
</body>
</html>
