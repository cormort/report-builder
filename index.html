<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²éšå ±è¡¨è¨­è¨ˆå™¨ - Master-Detail Support</title>
    <style>
        :root {
            --primary: #2186c4;
            --primary-hover: #1a6a9e;
            --bg: #f5f5f5;
            --surface: #ffffff;
            --text: #333333;
            --border: #e0e0e0;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .header {
            background: var(--surface); padding: 20px; border-radius: 8px; margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
        }
        .main-layout { display: grid; grid-template-columns: 250px 1fr 300px; gap: 20px; }
        .panel { background: var(--surface); border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .panel-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--primary); }
        
        /* Upload & Fields */
        .upload-area {
            border: 2px dashed var(--border); border-radius: 6px; padding: 20px; text-align: center;
            cursor: pointer; margin-bottom: 15px; transition: all 0.3s;
        }
        .upload-area:hover { border-color: var(--primary); background: rgba(33, 150, 243, 0.05); }
        .field-list { max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 10px; }
        .field-item {
            padding: 8px 12px; margin-bottom: 6px; background: var(--bg); border-radius: 4px;
            cursor: move; font-size: 13px; display: flex; align-items: center; gap: 8px; user-select: none;
        }
        .field-item:hover { background: var(--primary); color: white; }

        /* Canvas */
        .canvas-wrapper {
            border: 1px solid var(--border); border-radius: 8px; background: #525659;
            overflow: auto; height: 700px; position: relative; display: flex; justify-content: center; padding: 20px;
        }
        .canvas {
            width: 210mm; height: 297mm; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            position: relative; overflow: hidden; flex-shrink: 0;
        }
        .canvas-element {
            position: absolute; cursor: move; padding: 5px;
            background: rgba(33, 150, 243, 0.1); border: 1px solid var(--primary); border-radius: 2px;
            min-width: 50px; min-height: 20px; display: flex; align-items: center; white-space: nowrap; overflow: hidden;
        }
        .canvas-element.selected { border: 2px solid var(--danger); z-index: 100; }
        .canvas-element-value { pointer-events: none; width: 100%; }
        .resize-handle {
            position: absolute; bottom: 0; right: 0; width: 10px; height: 10px;
            background: var(--primary); cursor: nwse-resize;
        }

        /* Split Line for Master-Detail */
        #splitLine {
            position: absolute; left: 0; width: 100%; height: 0;
            border-top: 2px dashed #f44336; z-index: 90; cursor: ns-resize;
        }
        #splitLine::after {
            content: 'é é¦–èˆ‡åˆ—è¡¨åˆ†éš”ç·š (æ‹–æ›³èª¿æ•´)'; position: absolute; right: 10px; top: -20px;
            font-size: 12px; color: #f44336; font-weight: bold; background: rgba(255,255,255,0.8);
        }

        /* Property Panel */
        .property-group { margin-bottom: 15px; }
        .property-label { font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; display: block; }
        .property-input, .property-select { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; }
        
        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        
        .message { padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 13px; }
        .message.info { background: #e3f2fd; color: #1565c0; }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #print-container, #print-container * { visibility: visible; }
            #print-container { position: absolute; left: 0; top: 0; width: 100%; }
            .print-page {
                position: relative; width: 210mm; height: 297mm;
                margin: 0 auto; background: white; overflow: hidden;
                page-break-after: always; break-after: page;
            }
            .print-element { position: absolute; display: flex; align-items: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š é€²éšå ±è¡¨è¨­è¨ˆå™¨ (åˆ†çµ„/å¥—è¡¨åŠŸèƒ½)</h1>
            <div>
                <button class="btn btn-secondary" id="previewBtn">ğŸ‘ï¸ é è¦½</button>
                <button class="btn btn-success" id="printBtn">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button>
            </div>
        </div>

        <div class="main-layout">
            <!-- Left Panel -->
            <div class="panel left-panel">
                <div class="panel-title">ğŸ“ 1. ä¸Šå‚³æ•¸æ“š</div>
                <div class="upload-area" id="uploadArea">
                    <p>é»æ“Šä¸Šå‚³ CSV/JSON</p>
                    <input type="file" id="fileInput" accept=".csv,.json" style="display:none">
                </div>
                <div id="message"></div>
                <div class="panel-title">ğŸ·ï¸ 2. æ‹–æ›³æ¬„ä½</div>
                <div class="field-list" id="fieldList"></div>
            </div>

            <!-- Center Panel -->
            <div class="panel canvas-panel">
                <div class="panel-title">ğŸ¨ 3. è¨­è¨ˆç•«å¸ƒ</div>
                <div style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" id="addTextBtn">â• å›ºå®šçš„æ–‡å­—</button>
                    <button class="btn btn-secondary" id="addTitleBtn">ğŸ“Œ å ±è¡¨æ¨™é¡Œ</button>
                    <span style="font-size: 12px; color: #666; margin-left: 10px;">ğŸ’¡ æç¤ºï¼šç´…è‰²è™›ç·šä»¥ä¸Šæ˜¯æ¯é é‡è¤‡çš„æ¨™é¡Œï¼Œä»¥ä¸‹æ˜¯åˆ—è¡¨</span>
                </div>
                <div class="canvas-wrapper">
                    <div class="canvas" id="canvas">
                        <div id="splitLine" style="top: 150px;"></div> <!-- Default split position -->
                        <div class="canvas-label" style="position: absolute; top:5px; right:5px; color:#ccc;">A4</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="panel right-panel">
                <div class="panel-title">âš™ï¸ 4. å ±è¡¨è¨­å®š</div>
                
                <div class="property-group" style="background: #e8f5e9; padding: 10px; border-radius: 4px;">
                    <label class="property-label">ğŸ“„ åˆ—å°æ¨¡å¼</label>
                    <select class="property-select" id="reportMode">
                        <option value="single">å–®ç­†åˆ†é  (Mail Merge)</option>
                        <option value="group">åˆ†çµ„åˆ—è¡¨ (Master-Detail)</option>
                    </select>
                </div>

                <div id="groupSettings" style="display: none; border: 1px solid #4caf50; padding: 10px; border-radius: 4px; margin-bottom: 20px;">
                    <div class="property-group">
                        <label class="property-label">ğŸ”‘ åˆ†çµ„æ¬„ä½ (å¦‚: å“¡å·¥å§“å)</label>
                        <select class="property-select" id="groupFieldSelect">
                            <option value="">-- è«‹é¸æ“‡ --</option>
                        </select>
                    </div>
                    <div class="property-group">
                        <label class="property-label">ğŸ“ åˆ—è¡¨èµ·å§‹ Y åº§æ¨™ (px)</label>
                        <input type="number" class="property-input" id="splitYInput" value="150">
                    </div>
                    <div class="property-group">
                        <label class="property-label">â†•ï¸ è³‡æ–™è¡Œé«˜ (px)</label>
                        <input type="number" class="property-input" id="rowHeightInput" value="40">
                    </div>
                    <p style="font-size:12px; color:#666;">* ç´…ç·šä»¥ä¸‹çš„å…ƒç´ å°‡ä½œç‚ºã€Œåˆ—è¡¨æ¬„ä½ã€é‡è¤‡åˆ—å°</p>
                </div>

                <div class="panel-title">å…ƒä»¶å±¬æ€§</div>
                <div id="propertyPanel">
                    <div style="text-align: center; color: #999; padding: 20px 0;">é»æ“Šå…ƒç´ ç·¨è¼¯</div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" style="width:100%" id="saveBtn">ğŸ’¾ ä¿å­˜è¨­å®š</button>
                    <button class="btn btn-danger" style="width:100%; margin-top:10px" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©ºç•«å¸ƒ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Print Container -->
    <div id="print-container"></div>

    <script>
        // State
        const state = {
            fields: [],
            elements: [],
            data: [],
            selectedElement: null,
            previewMode: false,
            config: {
                mode: 'single', // 'single' or 'group'
                groupField: '',
                splitY: 150,
                rowHeight: 40
            }
        };

        // DOM
        const canvas = document.getElementById('canvas');
        const splitLine = document.getElementById('splitLine');
        const splitYInput = document.getElementById('splitYInput');
        const reportMode = document.getElementById('reportMode');
        const groupSettings = document.getElementById('groupSettings');
        const groupFieldSelect = document.getElementById('groupFieldSelect');

        // Init
        setupDragAndDrop();
        setupSplitLine();

        // 1. Upload Logic
        document.getElementById('uploadArea').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if(file.name.endsWith('.json')) state.data = JSON.parse(e.target.result);
                else state.data = parseCSV(e.target.result);
                
                extractFields();
                showMessage(`âœ… è¼‰å…¥ ${state.data.length} ç­†è³‡æ–™`);
            };
            reader.readAsText(file);
        };

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, h, i) => ({...obj, [h]: values[i]?.trim() || ''}), {});
            });
        }

        function extractFields() {
            if(!state.data.length) return;
            state.fields = Object.keys(state.data[0]);
            
            // Render Field List
            const list = document.getElementById('fieldList');
            list.innerHTML = state.fields.map(f => `
                <div class="field-item" draggable="true" data-field="${f}">
                    <span>ğŸ“Š ${f}</span>
                </div>
            `).join('');
            
            // Render Group Select
            groupFieldSelect.innerHTML = `<option value="">-- è«‹é¸æ“‡ --</option>` + 
                state.fields.map(f => `<option value="${f}">${f}</option>`).join('');
            
            addDragListeners();
        }

        // 2. Settings Logic
        reportMode.addEventListener('change', (e) => {
            state.config.mode = e.target.value;
            if(state.config.mode === 'group') {
                groupSettings.style.display = 'block';
                splitLine.style.display = 'block';
            } else {
                groupSettings.style.display = 'none';
                splitLine.style.display = 'none';
            }
        });

        splitYInput.addEventListener('change', (e) => {
            const y = parseInt(e.target.value);
            state.config.splitY = y;
            splitLine.style.top = y + 'px';
        });

        document.getElementById('rowHeightInput').addEventListener('change', (e) => {
            state.config.rowHeight = parseInt(e.target.value);
        });
        
        document.getElementById('groupFieldSelect').addEventListener('change', (e) => {
            state.config.groupField = e.target.value;
        });

        function setupSplitLine() {
            let isDragging = false;
            splitLine.addEventListener('mousedown', () => isDragging = true);
            document.addEventListener('mousemove', (e) => {
                if(!isDragging) return;
                const rect = canvas.getBoundingClientRect();
                let y = e.clientY - rect.top;
                y = Math.max(0, Math.min(y, 1100)); // Limit
                splitLine.style.top = y + 'px';
                splitYInput.value = Math.round(y);
                state.config.splitY = y;
            });
            document.addEventListener('mouseup', () => isDragging = false);
        }

        // 3. Canvas Logic
        function addDragListeners() {
            document.querySelectorAll('.field-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('type', 'field');
                    e.dataTransfer.setData('content', item.dataset.field);
                });
            });
        }

        function setupDragAndDrop() {
            canvas.addEventListener('dragover', e => e.preventDefault());
            canvas.addEventListener('drop', e => {
                e.preventDefault();
                const type = e.dataTransfer.getData('type');
                const content = e.dataTransfer.getData('content');
                const rect = canvas.getBoundingClientRect();
                addElement(type, content, e.clientX - rect.left, e.clientY - rect.top);
            });
        }

        document.getElementById('addTextBtn').onclick = () => addElement('text', 'æ–‡å­—å…§å®¹', 50, 50);
        document.getElementById('addTitleBtn').onclick = () => addElement('title', 'å ±è¡¨æ¨™é¡Œ', 50, 20);

        function addElement(type, content, x, y) {
            const el = {
                id: 'el-' + Date.now(),
                type, content, x, y, 
                width: 150, height: 30, 
                fontSize: 14, fontWeight: 'normal',
                fieldName: type === 'field' ? content : null
            };
            state.elements.push(el);
            renderElement(el);
        }

        function renderElement(el) {
            const div = document.createElement('div');
            div.id = el.id;
            div.className = 'canvas-element';
            div.style.left = el.x + 'px';
            div.style.top = el.y + 'px';
            div.style.width = el.width + 'px';
            div.style.height = el.height + 'px';
            div.style.fontSize = el.fontSize + 'px';
            div.style.fontWeight = el.fontWeight;
            
            div.innerHTML = `<div class="canvas-element-value">${type === 'field' ? `[${el.content}]` : el.content}</div><div class="resize-handle"></div>`;
            
            // Selection
            div.onmousedown = (e) => {
                if(e.target.classList.contains('resize-handle')) return;
                e.stopPropagation();
                selectElement(el, div);
                
                // Dragging
                let startX = e.clientX, startY = e.clientY;
                let origX = el.x, origY = el.y;
                
                const moveHandler = (em) => {
                    el.x = origX + (em.clientX - startX);
                    el.y = origY + (em.clientY - startY);
                    div.style.left = el.x + 'px';
                    div.style.top = el.y + 'px';
                };
                const upHandler = () => {
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                };
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            };

            // Resizing
            const handle = div.querySelector('.resize-handle');
            handle.onmousedown = (e) => {
                e.stopPropagation();
                let startX = e.clientX, startY = e.clientY;
                let origW = el.width, origH = el.height;
                
                const resizeMove = (em) => {
                    el.width = Math.max(20, origW + (em.clientX - startX));
                    el.height = Math.max(20, origH + (em.clientY - startY));
                    div.style.width = el.width + 'px';
                    div.style.height = el.height + 'px';
                };
                const resizeUp = () => {
                    document.removeEventListener('mousemove', resizeMove);
                    document.removeEventListener('mouseup', resizeUp);
                };
                document.addEventListener('mousemove', resizeMove);
                document.addEventListener('mouseup', resizeUp);
            };

            canvas.appendChild(div);
        }

        function selectElement(el, div) {
            document.querySelectorAll('.canvas-element').forEach(d => d.classList.remove('selected'));
            div.classList.add('selected');
            state.selectedElement = el;
            renderProperties(el);
        }

        function renderProperties(el) {
            const panel = document.getElementById('propertyPanel');
            panel.innerHTML = `
                <div class="property-group">
                    <label class="property-label">å…§å®¹ / æ¬„ä½</label>
                    <input class="property-input" value="${el.content}" onchange="updateProp('${el.id}', 'content', this.value)">
                </div>
                <div class="property-group">
                    <label class="property-label">å­—é«”å¤§å°</label>
                    <input type="number" class="property-input" value="${el.fontSize}" onchange="updateProp('${el.id}', 'fontSize', this.value)">
                </div>
                <div class="property-group">
                    <label class="property-label">ç²—ç´°</label>
                    <select class="property-select" onchange="updateProp('${el.id}', 'fontWeight', this.value)">
                        <option value="normal" ${el.fontWeight === 'normal'?'selected':''}>æ­£å¸¸</option>
                        <option value="bold" ${el.fontWeight === 'bold'?'selected':''}>ç²—é«”</option>
                    </select>
                </div>
                <button class="btn btn-danger" style="width:100%" onclick="deleteElement('${el.id}')">åˆªé™¤å…ƒç´ </button>
            `;
        }

        window.updateProp = (id, prop, val) => {
            const el = state.elements.find(e => e.id === id);
            if(el) {
                el[prop] = val;
                const div = document.getElementById(id);
                if(prop === 'content') div.querySelector('.canvas-element-value').innerText = val;
                if(prop === 'fontSize') div.style.fontSize = val + 'px';
                if(prop === 'fontWeight') div.style.fontWeight = val;
            }
        };

        window.deleteElement = (id) => {
            state.elements = state.elements.filter(e => e.id !== id);
            document.getElementById(id).remove();
            document.getElementById('propertyPanel').innerHTML = '';
        };

        // 4. PRINT LOGIC (Core Feature)
        document.getElementById('printBtn').onclick = () => {
            const container = document.getElementById('print-container');
            container.innerHTML = '';

            if(!state.data || state.data.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³è³‡æ–™');
                return;
            }

            if(state.config.mode === 'single') {
                printSingleMode(container);
            } else {
                if(!state.config.groupField) {
                    alert('è«‹é¸æ“‡åˆ†çµ„æ¬„ä½ (ä¾‹å¦‚å“¡å·¥å§“å)');
                    return;
                }
                printGroupMode(container);
            }

            setTimeout(() => window.print(), 500);
        };

        function createPrintElement(def, content, customY = null) {
            const div = document.createElement('div');
            div.className = 'print-element';
            div.innerText = content;
            div.style.left = def.x + 'px';
            div.style.top = (customY !== null ? customY : def.y) + 'px';
            div.style.width = def.width + 'px';
            div.style.height = def.height + 'px';
            div.style.fontSize = def.fontSize + 'px';
            div.style.fontWeight = def.fontWeight;
            return div;
        }

        // Mode A: Mail Merge (One Page Per Record)
        function printSingleMode(container) {
            state.data.forEach(row => {
                const page = document.createElement('div');
                page.className = 'print-page';
                
                state.elements.forEach(el => {
                    let text = el.content;
                    if(el.type === 'field' && row[el.fieldName] !== undefined) {
                        text = row[el.fieldName];
                    }
                    page.appendChild(createPrintElement(el, text));
                });
                container.appendChild(page);
            });
        }

        // Mode B: Master-Detail (Grouped List)
        function printGroupMode(container) {
            // 1. Group Data
            const groups = {};
            state.data.forEach(row => {
                const key = row[state.config.groupField] || 'Uncategorized';
                if(!groups[key]) groups[key] = [];
                groups[key].push(row);
            });

            const splitY = state.config.splitY;
            const rowHeight = state.config.rowHeight;
            const A4Height = 1122; // approx height in px for A4 at 96dpi (297mm)
            const marginBottom = 50;

            // Identify Header vs Detail Elements
            const headerEls = state.elements.filter(e => e.y < splitY);
            const detailEls = state.elements.filter(e => e.y >= splitY);

            // Shift detail elements relative to splitY (for template calculation)
            detailEls.forEach(el => el.offsetY = el.y - splitY);

            // 2. Iterate Groups
            Object.keys(groups).forEach(groupKey => {
                const rows = groups[groupKey];
                
                let currentPage = document.createElement('div');
                currentPage.className = 'print-page';
                container.appendChild(currentPage);

                // Helper: Render Header (uses data from the FIRST row of the group)
                const renderHeader = (pageObj, firstRow) => {
                    headerEls.forEach(el => {
                        let text = el.content;
                        if(el.type === 'field' && firstRow[el.fieldName] !== undefined) {
                            text = firstRow[el.fieldName];
                        }
                        pageObj.appendChild(createPrintElement(el, text));
                    });
                };

                // Init first page of this group
                renderHeader(currentPage, rows[0]);
                let currentY = splitY;

                // 3. Render Rows
                rows.forEach(row => {
                    // Check if page overflow
                    if(currentY + rowHeight > A4Height - marginBottom) {
                        // Create New Page
                        currentPage = document.createElement('div');
                        currentPage.className = 'print-page';
                        container.appendChild(currentPage);
                        
                        // Repeat Header
                        renderHeader(currentPage, rows[0]);
                        currentY = splitY; // Reset Y
                    }

                    // Render Detail Columns
                    detailEls.forEach(el => {
                        let text = el.content;
                        if(el.type === 'field' && row[el.fieldName] !== undefined) {
                            text = row[el.fieldName];
                        }
                        // Important: Y is calculated dynamically
                        const dynamicY = currentY + el.offsetY; // maintain relative layout inside row
                        const elDiv = createPrintElement(el, text, dynamicY);
                        // Force height to be rowHeight to ensure alignment
                        // elDiv.style.height = rowHeight + 'px'; 
                        currentPage.appendChild(elDiv);
                    });

                    currentY += rowHeight;
                });
            });
        }

        function showMessage(msg) {
            const m = document.getElementById('message');
            m.className = 'message info';
            m.innerText = msg;
            setTimeout(() => m.innerText = '', 3000);
        }
        
        document.getElementById('clearBtn').onclick = () => {
            state.elements = [];
            canvas.innerHTML = '<div id="splitLine" style="top: 150px;"></div><div class="canvas-label" style="position: absolute; top:5px; right:5px; color:#ccc;">A4</div>';
            setupSplitLine();
        }
    </script>
</body>
</html>
