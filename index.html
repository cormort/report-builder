<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­å ±è¡¨è¨­è¨ˆå™¨ - Pro Report Studio</title>
    <style>
        :root {
            --primary: #2186c4; --primary-hover: #1a6a9e;
            --bg: #f0f2f5; --surface: #ffffff;
            --text: #333; --border: #dcdfe6;
            --success: #67c23a; --danger: #f56c6c; --warning: #e6a23c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout */
        .header {
            background: #2b3a42; color: white; padding: 0 20px; height: 60px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        
        /* Panels */
        .panel { background: var(--surface); display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .left-panel { width: 260px; padding: 15px; overflow-y: auto; }
        .center-panel { flex: 1; background: #525659; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow: auto; }
        .right-panel { width: 300px; padding: 15px; overflow-y: auto; border-left: 1px solid var(--border); }
        
        .panel-title { font-size: 14px; font-weight: 700; color: #606266; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .divider { height: 1px; background: var(--border); margin: 15px 0; }

        /* Tools & Upload */
        .upload-area {
            border: 2px dashed var(--border); border-radius: 6px; padding: 20px; text-align: center;
            cursor: pointer; transition: all 0.3s; color: #909399; font-size: 13px;
        }
        .upload-area:hover { border-color: var(--primary); background: #ecf5ff; color: var(--primary); }
        
        .field-list { display: flex; flex-direction: column; gap: 5px; }
        .field-item {
            padding: 8px 12px; background: #f4f4f5; border: 1px solid #e9e9eb; border-radius: 4px;
            cursor: grab; font-size: 13px; display: flex; align-items: center; gap: 8px; color: #606266;
        }
        .field-item:hover { background: #ecf5ff; border-color: #b3d8ff; color: var(--primary); }
        
        /* Template Buttons */
        .template-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .tpl-btn {
            padding: 8px; border: 1px solid var(--border); background: white; border-radius: 4px;
            cursor: pointer; font-size: 12px; text-align: center; transition: 0.2s;
        }
        .tpl-btn:hover { border-color: var(--primary); color: var(--primary); background: #f0f9eb; }

        /* Canvas */
        .canvas-wrapper { position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.3); }
        .canvas {
            width: 210mm; height: 297mm; background: white; position: relative; overflow: hidden;
            /* Grid Background for Alignment */
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .canvas-element {
            position: absolute; cursor: move; padding: 0; box-sizing: border-box;
            display: flex; align-items: center; overflow: hidden;
            /* Default to transparent to look like real print */
            border: 1px dashed #ccc; 
        }
        .canvas-element.selected { border: 2px solid var(--primary); z-index: 100; background: rgba(33, 150, 243, 0.05); }
        .canvas-element-value { width: 100%; height: 100%; display: flex; align-items: center; padding: 0 4px; pointer-events: none; }
        .resize-handle {
            position: absolute; bottom: 0; right: 0; width: 8px; height: 8px; background: var(--primary);
            cursor: nwse-resize; display: none;
        }
        .canvas-element.selected .resize-handle { display: block; }

        /* Split Line */
        #splitLine {
            position: absolute; left: 0; width: 100%; height: 0; border-top: 2px dashed #f56c6c; z-index: 90; cursor: ns-resize;
        }
        #splitLine::after {
            content: 'åˆ—è¡¨åˆ†éš”ç·š (Header / Body)'; position: absolute; right: 0; top: -20px;
            font-size: 11px; background: #f56c6c; color: white; padding: 2px 6px; border-radius: 3px 0 0 0;
        }

        /* Forms */
        .form-group { margin-bottom: 12px; }
        .form-label { font-size: 12px; color: #606266; margin-bottom: 4px; display: block; }
        .form-control { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; }
        .form-control:focus { outline: none; border-color: var(--primary); }
        
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-block { width: 100%; }

        /* Print Logic */
        @media print {
            body * { visibility: hidden; }
            #print-container, #print-container * { visibility: visible; }
            #print-container { position: absolute; left: 0; top: 0; width: 100%; }
            .print-page {
                position: relative; width: 210mm; height: 297mm; margin: 0 auto; background: white;
                page-break-after: always; break-after: page; overflow: hidden;
            }
            .print-element { position: absolute; display: flex; align-items: center; padding: 0 4px; box-sizing: border-box; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="font-size: 18px; font-weight: bold;">ğŸ“Š Pro Report Studio</div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" id="printBtn">ğŸ–¨ï¸ åˆ—å° / åŒ¯å‡º PDF</button>
        </div>
    </div>

    <div class="main-layout">
        <!-- LEFT: Data & Templates -->
        <div class="panel left-panel">
            <div class="panel-title">1. æ•¸æ“šæº</div>
            <div class="upload-area" id="uploadArea">
                ğŸ“‚ é»æ“Šä¸Šå‚³ CSV / JSON
                <input type="file" id="fileInput" accept=".csv,.json" style="display:none">
            </div>
            <div id="fileInfo" style="font-size:12px; color:#67c23a; margin-top:5px;"></div>

            <div class="divider"></div>
            
            <div class="panel-title">2. å¿«é€Ÿæ¨¡æ¿</div>
            <div class="template-grid">
                <div class="tpl-btn" onclick="applyTemplate('table')">ğŸ“‘ è‡ªå‹•è¡¨æ ¼</div>
                <div class="tpl-btn" onclick="applyTemplate('invoice')">ğŸ§¾ ç™¼ç¥¨æ¨£å¼</div>
                <div class="tpl-btn" onclick="applyTemplate('card')">ğŸªª å“¡å·¥å¡</div>
                <div class="tpl-btn" onclick="applyTemplate('clean')">ğŸ—‘ï¸ ç©ºç™½</div>
            </div>

            <div class="divider"></div>

            <div class="panel-title">3. æ¬„ä½æ‹–æ›³</div>
            <div class="field-list" id="fieldList">
                <div style="color:#999; font-size:12px; text-align:center; padding:10px;">è«‹å…ˆä¸Šå‚³æ•¸æ“š</div>
            </div>
        </div>

        <!-- CENTER: Canvas -->
        <div class="panel center-panel">
            <div style="margin-bottom: 10px; display:flex; gap:10px;">
                <button class="btn" style="background:white;" id="addTextBtn">â• æ’å…¥æ–‡å­—</button>
                <button class="btn" style="background:white;" id="addTitleBtn">ğŸ“Œ æ’å…¥æ¨™é¡Œ</button>
            </div>
            <div class="canvas-wrapper">
                <div class="canvas" id="canvas">
                    <div id="splitLine" style="top: 150px;"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Settings -->
        <div class="panel right-panel">
            <div class="panel-title">å ±è¡¨å…¨åŸŸè¨­å®š</div>
            <div class="form-group">
                <label class="form-label">åˆ—å°æ¨¡å¼</label>
                <select class="form-control" id="reportMode">
                    <option value="single">å–®ç­†åˆ†é  (Mail Merge)</option>
                    <option value="group">åˆ†çµ„åˆ—è¡¨ (Master-Detail)</option>
                </select>
            </div>
            
            <div id="groupSettings" style="display:none; background:#f0f9eb; padding:10px; border-radius:4px; margin-bottom:15px;">
                <div class="form-group">
                    <label class="form-label">åˆ†çµ„ä¾æ“š (ä¾‹å¦‚: å“¡å·¥å§“å)</label>
                    <select class="form-control" id="groupFieldSelect"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">è¡¨é ­/å…§å®¹åˆ†éš”ç·š Y (px)</label>
                    <input type="number" class="form-control" id="splitYInput" value="150">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¯ä¸€è¡Œé«˜åº¦ (px)</label>
                    <input type="number" class="form-control" id="rowHeightInput" value="30">
                </div>
            </div>

            <div class="divider"></div>

            <div class="panel-title">é¸å–å…ƒç´ å±¬æ€§</div>
            <div id="propertyPanel">
                <div style="text-align:center; color:#999; padding:20px;">è«‹é»æ“Šç•«å¸ƒä¸Šçš„å…ƒç´ </div>
            </div>
        </div>
    </div>

    <div id="print-container"></div>

    <script>
        // --- Core State ---
        const state = {
            fields: [], elements: [], data: [],
            selectedElement: null,
            config: { mode: 'single', groupField: '', splitY: 150, rowHeight: 30 }
        };

        // --- DOM Cache ---
        const els = {
            canvas: document.getElementById('canvas'),
            fieldList: document.getElementById('fieldList'),
            propPanel: document.getElementById('propertyPanel'),
            splitLine: document.getElementById('splitLine'),
            splitYInput: document.getElementById('splitYInput'),
            groupSettings: document.getElementById('groupSettings'),
            modeSelect: document.getElementById('reportMode'),
            groupFieldSelect: document.getElementById('groupFieldSelect')
        };

        // --- Initialization ---
        initDragDrop();
        initSplitLine();
        
        // --- 1. File Handling ---
        document.getElementById('uploadArea').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    state.data = file.name.endsWith('.json') ? JSON.parse(evt.target.result) : parseCSV(evt.target.result);
                    state.fields = Object.keys(state.data[0] || {});
                    renderFieldList();
                    document.getElementById('fileInfo').innerText = `âœ… å·²è¼‰å…¥ ${state.data.length} ç­†è³‡æ–™`;
                } catch(err) { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
            };
            reader.readAsText(file);
        };

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const v = line.split(',');
                return headers.reduce((acc, h, i) => ({...acc, [h]: v[i]?.trim() || ''}), {});
            });
        }

        function renderFieldList() {
            els.fieldList.innerHTML = state.fields.map(f => `
                <div class="field-item" data-field="${f}">ğŸ“„ ${f}</div>
            `).join('');
            
            els.groupFieldSelect.innerHTML = `<option value="">-- æœªé¸æ“‡ --</option>` + 
                state.fields.map(f => `<option value="${f}">${f}</option>`).join('');
        }

        // --- 2. Template System (The Magic) ---
        window.applyTemplate = (type) => {
            if(type !== 'clean' && state.fields.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³æ•¸æ“šæª”æ¡ˆï¼Œæ‰èƒ½ç”Ÿæˆå°æ‡‰çš„è¡¨æ ¼æˆ–æ¬„ä½ï¼');
                return;
            }

            if(confirm('å¥—ç”¨æ¨¡æ¿å°‡æ¸…é™¤ç•¶å‰ç•«å¸ƒï¼Œç¢ºå®šå—ï¼Ÿ')) {
                state.elements = [];
                els.canvas.innerHTML = '<div id="splitLine"></div>';
                
                // é‡ç½®åˆ†éš”ç·š
                state.config.splitY = 150;
                updateSplitLineUI();

                if (type === 'table') generateAutoTable();
                else if (type === 'invoice') generateInvoice();
                else if (type === 'card') generateCard();
                else if (type === 'clean') { /* already cleared */ }
            }
        };

        function generateAutoTable() {
            // åˆ‡æ›åˆ°åˆ†çµ„æ¨¡å¼
            state.config.mode = 'group';
            updateModeUI();
            
            // è¨­å®šè¡¨æ ¼åƒæ•¸
            const startX = 20;
            const startY = 110; // Header Y position
            const colWidth = 120;
            const rowHeight = 30;
            state.config.splitY = startY + rowHeight; // åˆ†éš”ç·šåœ¨è¡¨é ­ä¸‹æ–¹
            state.config.rowHeight = rowHeight;
            updateSplitLineUI();

            // ç”Ÿæˆæ¨™é¡Œ
            addElement('title', 'è³‡æ–™å ±è¡¨', 20, 30, 300, 40, 24, 'bold');

            // è‡ªå‹•ç”Ÿæˆæ¬„ä½
            state.fields.forEach((field, index) => {
                const x = startX + (index * colWidth);
                
                // 1. è¡¨é ­ (Header) - ç°è‰²èƒŒæ™¯ï¼Œæœ‰é‚Šæ¡†
                addElement('text', field, x, startY, colWidth, rowHeight, 13, 'bold', '#f0f0f0', '1px solid #333');
                
                // 2. å…§å®¹ (Body) - ç™½è‰²èƒŒæ™¯ï¼Œæœ‰é‚Šæ¡† (æ”¾åœ¨åˆ†éš”ç·šä¸‹æ–¹ï¼Œä¹Ÿå°±æ˜¯ Y=splitY)
                // é€™è£¡çš„ Y åº§æ¨™åœ¨ Group Mode ä¸‹æ˜¯ç›¸å°åˆ—è¡¨èµ·å§‹é»çš„ï¼Œä½†ç‚ºäº†è¦–è¦ºåŒ–æˆ‘å€‘è¨­åœ¨ splitY
                // æ³¨æ„ï¼šé€™è£¡ç‚ºäº†è®“è¦–è¦ºå°é½Šï¼Œæˆ‘å€‘è¨­å®šå…§å®¹å…ƒç´ çš„ Y = state.config.splitY
                const bodyEl = addElement('field', field, x, state.config.splitY, colWidth, rowHeight, 13, 'normal', 'transparent', '1px solid #333');
                
                // ç‚ºäº†é¿å…é›™é‡é‚Šæ¡†ï¼Œå¯ä»¥æŠŠå…§å®¹çš„ä¸Šé‚Šæ¡†æ‹¿æ‰ (CSS hack via style)
                // é€™è£¡ç°¡åŒ–è™•ç†ï¼Œç›´æ¥ç•«æ¡†
            });
        }

        function generateInvoice() {
            state.config.mode = 'group';
            updateModeUI();
            state.config.splitY = 200;
            updateSplitLineUI();

            addElement('title', 'INVOICE / ç™¼ç¥¨', 550, 40, 200, 40, 24, 'bold');
            addElement('text', 'å…¬å¸åç¨±: My Company Ltd.', 40, 40, 300, 25);
            addElement('text', 'æ—¥æœŸ: 2023-10-20', 550, 90, 200, 25);
            
            // å‡è¨­æœ‰æ¬„ä½çš„è©±ï¼Œéš¨æ©Ÿæ”¾å¹¾å€‹ç•¶ç¤ºç¯„
            if(state.fields.length > 0) {
                addElement('text', 'å®¢æˆ¶åç¨±:', 40, 100, 80, 25, 13, 'bold');
                addElement('field', state.fields[0], 120, 100, 200, 25, 13, 'normal', '#eee', '1px solid #ccc');
            }

            // è¡¨æ ¼é ­éƒ¨
            const headers = ['å“é …', 'æ•¸é‡', 'å–®åƒ¹', 'é‡‘é¡'];
            headers.forEach((h, i) => {
                addElement('text', h, 40 + i*150, 170, 150, 30, 13, 'bold', '#ddd', '1px solid #333');
            });
            
            // å˜—è©¦è‡ªå‹•å°æ‡‰è³‡æ–™æ¬„ä½ (å¦‚æœæœ‰çš„è©±)
            state.fields.slice(0, 4).forEach((f, i) => {
                addElement('field', f, 40 + i*150, 200, 150, 30, 13, 'normal', 'transparent', '1px solid #ccc');
            });
        }

        function generateCard() {
            state.config.mode = 'single';
            updateModeUI();
            
            // ç•«ä¸€å€‹å¤–æ¡†
            addElement('text', '', 20, 20, 350, 200, 14, 'normal', 'transparent', '2px solid #333');
            addElement('title', 'è­˜åˆ¥è­‰', 40, 40, 100, 30, 18, 'bold');
            
            let y = 80;
            state.fields.slice(0, 3).forEach(f => {
                addElement('text', f + ':', 40, y, 80, 25, 12, 'bold');
                addElement('field', f, 120, y, 200, 25, 14, 'normal', '#f9f9f9', 'none');
                y += 35;
            });
        }

        // --- 3. Canvas & Interaction ---
        function initDragDrop() {
            // Drag Start (From List)
            els.fieldList.addEventListener('mousedown', e => {
                const item = e.target.closest('.field-item'); // Changed to mousedown logic for simpler simulation
                if(!item) return;
                item.setAttribute('draggable', true);
            });
            els.fieldList.addEventListener('dragstart', e => {
                const item = e.target.closest('.field-item');
                e.dataTransfer.setData('type', 'field');
                e.dataTransfer.setData('content', item.dataset.field);
            });

            // Drop (To Canvas)
            els.canvas.addEventListener('dragover', e => e.preventDefault());
            els.canvas.addEventListener('drop', e => {
                e.preventDefault();
                const type = e.dataTransfer.getData('type');
                const content = e.dataTransfer.getData('content');
                if(!type) return;
                const rect = els.canvas.getBoundingClientRect();
                addElement(type, content, e.clientX - rect.left, e.clientY - rect.top);
            });
        }

        document.getElementById('addTextBtn').onclick = () => addElement('text', 'è‡ªè¨‚æ–‡å­—', 50, 50);
        document.getElementById('addTitleBtn').onclick = () => addElement('title', 'æ¨™é¡Œ', 50, 50, 200, 40, 20, 'bold');

        function addElement(type, content, x, y, w=150, h=30, fs=14, fw='normal', bg='transparent', border='1px dashed #ccc') {
            const el = {
                id: 'el-' + Date.now() + Math.random(),
                type, content, x, y, width: w, height: h,
                fontSize: fs, fontWeight: fw, backgroundColor: bg, border: border,
                fieldName: type === 'field' ? content : null
            };
            state.elements.push(el);
            renderElementDOM(el);
            return el;
        }

        function renderElementDOM(el) {
            const div = document.createElement('div');
            div.id = el.id;
            div.className = 'canvas-element';
            updateElementStyle(div, el);
            
            div.innerHTML = `
                <div class="canvas-element-value">${el.type === 'field' ? `[${el.content}]` : el.content}</div>
                <div class="resize-handle"></div>
            `;

            // Interaction: Select & Drag
            div.onmousedown = (e) => {
                if(e.target.classList.contains('resize-handle')) return;
                e.stopPropagation();
                selectElement(el);
                
                const startX = e.clientX, startY = e.clientY;
                const origX = el.x, origY = el.y;
                
                const move = (em) => {
                    el.x = origX + (em.clientX - startX);
                    el.y = origY + (em.clientY - startY);
                    updateElementStyle(div, el);
                };
                const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); };
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', up);
            };

            // Interaction: Resize
            const handle = div.querySelector('.resize-handle');
            handle.onmousedown = (e) => {
                e.stopPropagation();
                const startX = e.clientX, startY = e.clientY;
                const origW = el.width, origH = el.height;
                const resize = (em) => {
                    el.width = Math.max(20, origW + (em.clientX - startX));
                    el.height = Math.max(20, origH + (em.clientY - startY));
                    updateElementStyle(div, el);
                    renderProperties(el); // Live update props
                };
                const stop = () => { document.removeEventListener('mousemove', resize); document.removeEventListener('mouseup', stop); };
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stop);
            };

            els.canvas.appendChild(div);
        }

        function updateElementStyle(div, el) {
            div.style.left = el.x + 'px';
            div.style.top = el.y + 'px';
            div.style.width = el.width + 'px';
            div.style.height = el.height + 'px';
            div.style.fontSize = el.fontSize + 'px';
            div.style.fontWeight = el.fontWeight;
            div.style.background = el.backgroundColor;
            div.style.border = el.border;
        }

        function selectElement(el) {
            state.selectedElement = el;
            document.querySelectorAll('.canvas-element').forEach(d => d.classList.remove('selected'));
            document.getElementById(el.id).classList.add('selected');
            renderProperties(el);
        }

        function renderProperties(el) {
            els.propPanel.innerHTML = `
                <div class="form-group"><label class="form-label">å…§å®¹</label>
                <input class="form-control" value="${el.content}" oninput="updateProp('${el.id}', 'content', this.value)"></div>
                
                <div class="form-group"><label class="form-label">èƒŒæ™¯è‰²</label>
                <input type="color" style="width:100%" value="${el.backgroundColor === 'transparent' ? '#ffffff' : el.backgroundColor}" oninput="updateProp('${el.id}', 'backgroundColor', this.value)"></div>
                
                <div class="form-group"><label class="form-label">é‚Šæ¡†æ¨£å¼</label>
                <select class="form-control" onchange="updateProp('${el.id}', 'border', this.value)">
                    <option value="none" ${el.border==='none'?'selected':''}>ç„¡é‚Šæ¡†</option>
                    <option value="1px solid #000" ${el.border.includes('solid')?'selected':''}>å¯¦ç·šæ¡†</option>
                    <option value="1px dashed #000" ${el.border.includes('dashed')?'selected':''}>è™›ç·šæ¡†</option>
                </select></div>
                
                <div class="form-group"><label class="form-label">å­—é«”å¤§å° / å¯¬ / é«˜</label>
                <div style="display:flex; gap:5px">
                    <input type="number" class="form-control" value="${el.fontSize}" oninput="updateProp('${el.id}', 'fontSize', this.value)">
                    <input type="number" class="form-control" value="${el.width}" oninput="updateProp('${el.id}', 'width', this.value)">
                    <input type="number" class="form-control" value="${el.height}" oninput="updateProp('${el.id}', 'height', this.value)">
                </div></div>

                <button class="btn btn-danger btn-block" onclick="deleteEl('${el.id}')">ğŸ—‘ï¸ åˆªé™¤æ­¤å…ƒç´ </button>
            `;
        }

        window.updateProp = (id, key, val) => {
            const el = state.elements.find(e => e.id === id);
            if(el) {
                el[key] = val;
                const div = document.getElementById(id);
                updateElementStyle(div, el);
                if(key === 'content') div.querySelector('.canvas-element-value').innerText = el.type==='field' ? `[${val}]` : val;
            }
        };

        window.deleteEl = (id) => {
            state.elements = state.elements.filter(e => e.id !== id);
            document.getElementById(id).remove();
            els.propPanel.innerHTML = '';
        };

        // --- 4. Split Line & Settings ---
        function initSplitLine() {
            let isDragging = false;
            els.splitLine.addEventListener('mousedown', () => isDragging = true);
            document.addEventListener('mousemove', (e) => {
                if(!isDragging) return;
                const rect = els.canvas.getBoundingClientRect();
                let y = Math.max(0, Math.min(e.clientY - rect.top, 1100));
                state.config.splitY = y;
                updateSplitLineUI();
            });
            document.addEventListener('mouseup', () => isDragging = false);
            
            els.splitYInput.onchange = (e) => { state.config.splitY = +e.target.value; updateSplitLineUI(); };
            els.modeSelect.onchange = (e) => { state.config.mode = e.target.value; updateModeUI(); };
            els.groupFieldSelect.onchange = (e) => state.config.groupField = e.target.value;
            document.getElementById('rowHeightInput').onchange = (e) => state.config.rowHeight = +e.target.value;
        }

        function updateSplitLineUI() {
            els.splitLine.style.top = state.config.splitY + 'px';
            els.splitYInput.value = Math.round(state.config.splitY);
        }

        function updateModeUI() {
            els.modeSelect.value = state.config.mode;
            const isGroup = state.config.mode === 'group';
            els.groupSettings.style.display = isGroup ? 'block' : 'none';
            els.splitLine.style.display = isGroup ? 'block' : 'none';
        }

        // --- 5. Print Engine (Robust) ---
        document.getElementById('printBtn').onclick = () => {
            const container = document.getElementById('print-container');
            container.innerHTML = '';
            if(!state.data.length) return alert('ç„¡æ•¸æ“šå¯åˆ—å°');

            if(state.config.mode === 'single') printSingle(container);
            else printGroup(container);

            setTimeout(() => window.print(), 500);
        };

        function printSingle(container) {
            state.data.forEach(row => {
                const page = createPage();
                state.elements.forEach(el => page.appendChild(createPrintEl(el, row)));
                container.appendChild(page);
            });
        }

        function printGroup(container) {
            if(!state.config.groupField && state.data.length > 0) {
                 // Fallback if user forgot to select group field: group everything into one dummy group
                 alert('æ³¨æ„ï¼šæ‚¨æœªé¸æ“‡åˆ†çµ„æ¬„ä½ï¼Œå°‡æŠŠæ‰€æœ‰è³‡æ–™è¦–ç‚ºåŒä¸€çµ„ã€‚');
            }
            
            const groups = {};
            state.data.forEach(row => {
                const key = row[state.config.groupField] || 'ALL';
                if(!groups[key]) groups[key] = [];
                groups[key].push(row);
            });

            const { splitY, rowHeight } = state.config;
            const headerEls = state.elements.filter(e => e.y < splitY);
            const detailEls = state.elements.filter(e => e.y >= splitY);
            detailEls.forEach(e => e.offsetY = e.y - splitY);

            Object.keys(groups).forEach(key => {
                const rows = groups[key];
                let page = createPage();
                container.appendChild(page);
                
                // Render Header
                const renderHeader = () => headerEls.forEach(el => page.appendChild(createPrintEl(el, rows[0])));
                renderHeader();
                
                let curY = splitY;
                rows.forEach(row => {
                    if(curY + rowHeight > 1080) { // New Page
                        page = createPage();
                        container.appendChild(page);
                        renderHeader();
                        curY = splitY;
                    }
                    // Render Row
                    detailEls.forEach(el => {
                        const div = createPrintEl(el, row);
                        div.style.top = (curY + el.offsetY) + 'px';
                        page.appendChild(div);
                    });
                    curY += rowHeight;
                });
            });
        }

        function createPage() {
            const div = document.createElement('div');
            div.className = 'print-page';
            return div;
        }

        function createPrintEl(el, row) {
            const div = document.createElement('div');
            div.className = 'print-element';
            div.style.left = el.x + 'px';
            div.style.top = el.y + 'px';
            div.style.width = el.width + 'px';
            div.style.height = el.height + 'px';
            div.style.fontSize = el.fontSize + 'px';
            div.style.fontWeight = el.fontWeight;
            div.style.background = el.backgroundColor;
            div.style.border = el.border; // Print borders
            
            let txt = el.content;
            if(el.type === 'field' && row) txt = row[el.fieldName] || '';
            div.innerText = txt;
            return div;
        }
    </script>
</body>
</html>
