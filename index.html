<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Report Studio v7.0 - ç¯„ä¾‹é€Ÿæˆç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; --primary-light: #818cf8; --bg: #0f172a; --surface: #1e293b; --surface2: #334155;
            --border: #475569; --text: #e2e8f0; --text-secondary: #94a3b8; --success: #10b981; --danger: #ef4444;
            --demo-color: #8b5cf6; /* ç´«è‰²ç³»ï¼Œå‘¼æ‡‰èªªæ˜æª” */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .material-symbols-outlined { font-size: 20px; vertical-align: middle; }

        /* Header */
        .header { height: 56px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 20px; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header .title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        
        /* Layout */
        .main-layout { flex: 1; display: flex; overflow: hidden; }
        .left-panel { width: 280px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .tab-nav { display: flex; background: var(--surface2); border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 14px 8px; text-align: center; cursor: pointer; color: var(--text-secondary); transition: 0.2s; font-size: 13px; }
        .tab-btn.active, .tab-btn:hover { color: white; background: rgba(99,102,241,0.2); border-bottom: 2px solid var(--primary); }
        .tab-content { flex: 1; overflow-y: auto; padding: 16px; display: none; }
        .tab-content.active { display: block; }

        /* Components */
        .btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; background: var(--surface2); color: var(--text); }
        .btn:hover { background: #475569; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99,102,241,0.4); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-demo { background: var(--demo-color); color: white; width: 100%; justify-content: flex-start; margin-bottom: 8px; text-align: left; padding: 10px 12px; }
        .btn-demo:hover { background: #7c3aed; box-shadow: 0 4px 12px rgba(139,92,246,0.4); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-block { width: 100%; }
        
        .form-group { margin-bottom: 14px; }
        .form-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; display: block; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface2); color: var(--text); font-size: 13px; }
        .upload-area { border: 2px dashed var(--border); padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; background: var(--surface2); }
        .field-item { padding: 10px 12px; background: var(--surface2); border-radius: 8px; margin-bottom: 8px; cursor: grab; display: flex; align-items: center; gap: 8px; font-size: 13px; border: 1px solid transparent; }
        .field-item:hover { background: rgba(99,102,241,0.2); border-color: var(--primary); }

        /* Canvas */
        .center-panel { flex: 1; background: #1e293b; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; overflow: auto; }
        .canvas { background: white; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.6); border-radius: 4px; overflow: hidden; transform-origin: top center; background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px); background-size: 20px 20px; }
        .canvas-element { position: absolute; border: 1px dashed #94a3b8; background: rgba(99,102,241,0.05); border-radius: 4px; cursor: move; display: flex; align-items: center; box-sizing: border-box; color: #333; user-select: none; }
        .canvas-element.selected { border: 2px solid var(--primary); background: rgba(99,102,241,0.15); z-index: 100; }
        .canvas-element-value { pointer-events: none; width: 100%; padding: 2px; overflow: hidden; white-space: nowrap; }
        .resize-handle { position: absolute; bottom: -4px; right: -4px; width: 12px; height: 12px; background: var(--primary); border: 2px solid white; border-radius: 50%; cursor: nwse-resize; opacity: 0; }
        .canvas-element.selected .resize-handle { opacity: 1; }

        /* Right Panel */
        .right-panel { width: 320px; background: var(--surface); border-left: 1px solid var(--border); padding: 16px; overflow-y: auto; }
        .panel-title { font-size: 14px; font-weight: 700; color: var(--primary-light); margin: 20px 0 12px 0; padding-bottom: 8px; border-bottom: 1px solid var(--border); }

        /* Floating Toolbar */
        .floating-toolbar { position: absolute; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 8px; display: none; gap: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 1000; }
        .floating-toolbar.show { display: flex; }

        /* Split Line */
        #splitLine { position: absolute; left: 0; width: 100%; border-top: 3px dashed #ef4444; z-index: 90; cursor: ns-resize; opacity: 0.8; display: none; }
        #splitLine::after { content: "åˆ†çµ„åˆ†éš”ç·š"; position: absolute; top: -10px; right: 0; background: var(--danger); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; }

        /* Table & Props */
        .table-element { display: block !important; overflow: visible !important; border: none !important; background: transparent !important; }
        .col-resizer:hover { opacity: 1 !important; background: var(--primary) !important; }
        .prop-col-item { transition: 0.2s; border: 1px solid var(--border); background: var(--surface2); color: var(--text); }
        .prop-col-item.drag-over { border-color: var(--primary); background: rgba(99,102,241,0.2); }
        .context-menu { position: fixed; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 9999; min-width: 160px; }
        .context-menu div { padding: 10px 16px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border); color: var(--text); }
        .context-menu div:hover { background: var(--primary); color: white; }
        .modal-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: var(--surface); padding: 24px; border-radius: 16px; width: 360px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        .tag-item { padding: 6px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 16px; font-size: 12px; cursor: grab; color: var(--primary-light); display: inline-block; margin: 2px; }

        /* Print */
        #print-container { display: none; }
        @media print {
            @page { margin: 0; }
            body * { visibility: hidden; }
            #print-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; visibility: visible; }
            #print-container * { visibility: visible; }
            .print-page { position: relative; margin: 0 auto; background: white; page-break-after: always; break-after: page; overflow: hidden; }
            .print-element { position: absolute; display: flex; align-items: center; padding: 2px; box-sizing: border-box; color: black; }
            .print-page { background-image: none !important; }
            .print-table-row { position: relative !important; left: auto !important; top: auto !important; display: flex; }
            .print-table-cell { word-break: break-word; white-space: pre-wrap; overflow: visible; height: auto !important; min-height: 30px; color: black; }
            .print-table-wrapper { position: absolute; display: flex; flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">
            <span class="material-symbols-outlined" style="font-size:28px;color:var(--primary)">auto_fix_high</span>
            Pro Report Studio <small style="opacity:0.7;margin-left:8px;font-weight:400;font-size:12px">v7.0 ç¯„ä¾‹é€Ÿæˆç‰ˆ</small>
        </div>
        <div class="actions">
            <button class="btn btn-success" id="printBtn">
                <span class="material-symbols-outlined">print</span> åˆ—å° / åŒ¯å‡º PDF
            </button>
        </div>
    </div>

    <div class="main-layout">
        <!-- å·¦å´å·¥å…·æ¬„ -->
        <div class="left-panel">
            <div class="tab-nav">
                <div class="tab-btn active" data-tab="tab1"><span class="material-symbols-outlined">rocket_launch</span><div>é€Ÿæˆ</div></div>
                <div class="tab-btn" data-tab="tab2"><span class="material-symbols-outlined">dataset</span><div>è³‡æ–™</div></div>
                <div class="tab-btn" data-tab="tab3"><span class="material-symbols-outlined">widgets</span><div>å…ƒä»¶</div></div>
            </div>

            <!-- Tab 1: é€Ÿæˆç¯„ä¾‹ (New) -->
            <div id="tab1" class="tab-content active">
                <div style="margin-bottom:15px; font-size:13px; color:var(--text-secondary)">
                    é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œè‡ªå‹•è¼‰å…¥<br><b>ã€Œç¯„ä¾‹è³‡æ–™ + ç‰ˆé¢è¨­è¨ˆ + è¨­å®šã€</b>
                </div>
                
                <button class="btn btn-demo" onclick="loadDemo('invoice')">
                    <span class="material-symbols-outlined">receipt_long</span> ä¸‰è¯å¼ç™¼ç¥¨ / æ”¶æ“š
                </button>
                <button class="btn btn-demo" onclick="loadDemo('label')">
                    <span class="material-symbols-outlined">label</span> æ¨™ç±¤è²¼ç´™ (ä¸€é å¤šå¼µ)
                </button>
                <button class="btn btn-demo" onclick="loadDemo('shipping')">
                    <span class="material-symbols-outlined">local_shipping</span> å‡ºè²¨å–® (ä¾å®¢æˆ¶åˆ†çµ„)
                </button>
                <button class="btn btn-demo" onclick="loadDemo('receipt')">
                    <span class="material-symbols-outlined">receipt</span> 80mm ç†±æ„Ÿå°ç¥¨
                </button>

                <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                    <div style="font-weight:600; margin-bottom:10px; color:var(--primary-light)">å¿«é€Ÿæ¨™é¡Œå·¥å…·</div>
                    <textarea id="quickTextInput" class="form-control" rows="3" placeholder="è²¼ä¸Šæ¬„ä½ï¼šå“å è¦æ ¼ æ•¸é‡ å–®åƒ¹ é‡‘é¡"></textarea>
                    <button class="btn btn-primary btn-block" style="margin-top:8px" onclick="parseQuickText()">
                        <span class="material-symbols-outlined">content_cut</span> åˆ‡åˆ†ä¸¦ç”¢ç”Ÿæ¨™ç±¤
                    </button>
                    <div id="quickTextList" style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;"></div>
                </div>
            </div>

            <!-- Tab 2: è³‡æ–™ -->
            <div id="tab2" class="tab-content">
                <div class="form-group">
                    <div class="upload-area" id="dataBtn">
                        <span class="material-symbols-outlined" style="font-size:36px;color:#10b981">upload_file</span>
                        <div style="margin-top:8px">ä¸Šå‚³ CSV / JSON</div>
                        <input type="file" id="dataFile" hidden accept=".csv,.json">
                    </div>
                    <div id="fileInfo" style="margin-top:8px; color:#10b981; font-weight:500; font-size:12px; text-align:center;"></div>
                </div>
                <div class="form-group">
                    <div class="upload-area" id="layoutBtn" style="border-color: #8b5cf6; background: rgba(139,92,246,0.05);">
                        <span class="material-symbols-outlined" style="font-size:36px;color:#8b5cf6">dashboard_customize</span>
                        <div style="margin-top:8px">åŒ¯å…¥è¡¨æ ¼çµæ§‹ (JSON)</div>
                        <div style="font-size:11px;color:#666;margin-top:4px">ä¾†è‡ª PDF åµæ¸¬å™¨çš„ export.json</div>
                        <input type="file" id="layoutFile" hidden accept=".json">
                    </div>
                </div>
                <div class="form-group">
                    <div class="upload-area" id="pdfBtn">
                        <span class="material-symbols-outlined" style="font-size:36px;color:var(--primary)">picture_as_pdf</span>
                        <div style="margin-top:8px">åŒ¯å…¥ PDF åº•åœ–</div>
                        <input type="file" id="pdfFile" hidden accept=".pdf">
                    </div>
                </div>

                <div style="margin-top:20px">
                    <div style="font-weight:600; margin-bottom:12px; color:var(--primary-light); font-size:13px;">æ¬„ä½åˆ—è¡¨ (å¯æ‹–æ›³)</div>
                    <div id="fieldList"></div>
                </div>
            </div>

            <!-- Tab 3: å…ƒä»¶ -->
            <div id="tab3" class="tab-content">
                <button class="btn btn-primary btn-block" style="margin-bottom:12px" onclick="openTableModal('smart')">
                    <span class="material-symbols-outlined">table_view</span> æ’å…¥æ™ºèƒ½è¡¨æ ¼
                </button>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn" onclick="addElement('text','æ–‡å­—')"><span class="material-symbols-outlined">text_fields</span> æ–‡å­—</button>
                    <button class="btn" onclick="addElement('title','æ¨™é¡Œ',null,null,null,null,24,'bold')"><span class="material-symbols-outlined">title</span> æ¨™é¡Œ</button>
                    <button class="btn" onclick="addElement('text','',50,50,200,4,12,'normal','#000','none')"><span class="material-symbols-outlined">remove</span> æ©«ç·š</button>
                    <button class="btn" onclick="addElement('text','',50,50,4,120,12,'normal','#000','none')"><span class="material-symbols-outlined">vertical_align_center</span> ç›´ç·š</button>
                    <button class="btn" onclick="addElement('text','',50,50,150,80,12,'normal','transparent','2px solid #333')"><span class="material-symbols-outlined">crop_square</span> çŸ©å½¢</button>
                    <button class="btn btn-danger" onclick="if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')){state.elements=[];el('canvas').innerHTML='<div id=splitLine></div>';}"><span class="material-symbols-outlined">delete_sweep</span> æ¸…ç©º</button>
                </div>
            </div>
        </div>

        <!-- ä¸­é–“ç•«å¸ƒ -->
        <div class="center-panel">
            <div style="position:absolute; top:10px; right:10px; z-index:10;">
                <button class="btn btn-danger btn-sm" id="clearBgBtn" style="display:none">ğŸ—‘ï¸ æ¸…é™¤èƒŒæ™¯</button>
            </div>
            <div class="canvas-wrapper">
                <div class="canvas" id="canvas" style="width:210mm; height:297mm;">
                    <div id="splitLine" style="top:150px;display:none;"></div>
                </div>
            </div>

            <!-- æµ®å‹•å·¥å…·åˆ— -->
            <div class="floating-toolbar" id="floatBar">
                <button class="btn btn-sm" onclick="duplicateSelected()" title="è¤‡è£½"><span class="material-symbols-outlined">content_copy</span></button>
                <button class="btn btn-sm" onclick="delEl(state.selected.id)" title="åˆªé™¤"><span class="material-symbols-outlined">delete</span></button>
                <button class="btn btn-sm" onclick="bringToFront()" title="ç§»è‡³æœ€å‰"><span class="material-symbols-outlined">flip_to_front</span></button>
                <button class="btn btn-sm" onclick="sendToBack()" title="ç§»è‡³æœ€å¾Œ"><span class="material-symbols-outlined">flip_to_back</span></button>
            </div>
        </div>

        <!-- å³å´å±¬æ€§é¢æ¿ -->
        <div class="right-panel">
            <div class="panel-title">ç‰ˆé¢è¨­å®š</div>
            <div class="form-group">
                <label class="form-label">ç´™å¼µ</label>
                <select id="pageSize" class="form-control">
                    <option value="a4">A4 (210Ã—297mm)</option>
                    <option value="a5">A5</option>
                    <option value="receipt80">80mm å°ç¥¨</option>
                    <option value="custom">è‡ªè¨‚</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">æ–¹å‘</label>
                <select id="orient" class="form-control">
                    <option value="portrait">ç›´å‘</option>
                    <option value="landscape">æ©«å‘</option>
                </select>
            </div>

            <div class="panel-title">è¼¸å‡ºæ¨¡å¼</div>
            <select id="mode" class="form-control" style="margin-bottom:12px">
                <option value="single">å–®é å–®ç­†</option>
                <option value="group">åˆ†çµ„åˆ—è¡¨</option>
                <option value="grid">ä¸€é å¤šç­†</option>
            </select>
            
            <div id="grpSet" style="display:none; background:rgba(16,185,129,0.1); padding:12px; border-radius:8px; border:1px solid var(--success);">
                <div class="form-group"><label class="form-label">åˆ†çµ„æ¬„ä½</label><select id="grpField" class="form-control"></select></div>
                <div class="form-group"><label class="form-label">åˆ†éš”ç·š Y</label><input type="number" id="splitY" class="form-control" value="150"></div>
                <div class="form-group"><label class="form-label">è¡Œé«˜ (é è¦½)</label><input type="number" id="rowH" class="form-control" value="30"></div>
            </div>

            <div id="gridSet" style="display:none; background:rgba(99,102,241,0.1); padding:12px; border-radius:8px; border:1px solid var(--primary);">
                <button class="btn btn-primary btn-block" style="margin-bottom:10px" onclick="autoCalcGrid()">âœ¨ è‡ªå‹•è¨ˆç®—</button>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                    <div><label class="form-label">æ¬„</label><input type="number" id="gCols" class="form-control" value="2"></div>
                    <div><label class="form-label">åˆ—</label><input type="number" id="gRows" class="form-control" value="4"></div>
                    <div><label class="form-label">é–“è·X</label><input type="number" id="gX" class="form-control" value="10"></div>
                    <div><label class="form-label">é–“è·Y</label><input type="number" id="gY" class="form-control" value="10"></div>
                </div>
            </div>

            <div id="props" style="margin-top:20px;">
                <div style="padding:40px 0; opacity:0.5; text-align:center; color:var(--text-secondary);">
                    <span class="material-symbols-outlined" style="font-size:48px;">gesture</span>
                    <div style="margin-top:16px;">è«‹åœ¨ç•«å¸ƒä¸Šé¸æ“‡ä¸€å€‹å…ƒä»¶</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Table Modal -->
    <div class="modal-overlay" id="tableModal">
        <div class="modal">
            <h3 id="modalTitle" style="margin-bottom:15px; font-size:18px; font-weight:700; color:var(--text)">æ’å…¥è¡¨æ ¼</h3>
            <div class="form-group"><label class="form-label">æ¬„ä½æ•¸ (Cols)</label><input type="number" id="tblCols" class="form-control" value="3" min="1" max="10"></div>
            <div class="form-group"><label class="form-label">è³‡æ–™åˆ—æ•¸ (Rows)</label><input type="number" id="tblRows" class="form-control" value="2" min="1" max="20"></div>
            <div class="form-group" style="font-size:12px; color:var(--text-secondary)"><input type="checkbox" id="autoFill" checked> è‡ªå‹•å¡«å…¥æ¬„ä½è®Šæ•¸</div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-block" onclick="closeTableModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary btn-block" onclick="insertTable()">æ’å…¥</button>
            </div>
        </div>
    </div>

    <div id="print-container"></div>

    <script>
        const state = { fields: [], elements: [], data: [], selected: null, config: { size: 'a4', orient: 'portrait', w: 210, h: 297, mode: 'single', grpF: '', splitY: 150, rowH: 30, gC: 2, gR: 4, gX: 10, gY: 10 } };
        const el = (id) => document.getElementById(id);
        let currentTableMode = 'smart';

        // Tab Logic
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            };
        });

        initCanvas(); initDrag();

        // --- Canvas & Layout ---
        function initCanvas() { updSz(); el('pageSize').onchange = (e) => { state.config.size = e.target.value; updSz(); }; el('orient').onchange = (e) => { state.config.orient = e.target.value; updSz(); }; }
        function updSz() {
            const m = { 'a4': [210, 297], 'a5': [148, 210], 'receipt80': [80, 297] };
            let [w, h] = m[state.config.size] || [state.config.w, state.config.h];
            if (state.config.orient === 'landscape' && state.config.size !== 'receipt80' && state.config.size !== 'custom') [w, h] = [h, w];
            state.config.w = w; state.config.h = h;
            el('canvas').style.width = w + 'mm'; el('canvas').style.height = h + 'mm';
            el('canvas').style.height = state.config.size === 'receipt80' ? 'auto' : h + 'mm';
            el('canvas').style.minHeight = state.config.size === 'receipt80' ? '150mm' : '0';
        }

        // --- Demo Loader (NEW) ---
        window.loadDemo = (type) => {
            if(!confirm('é€™å°‡æ¸…é™¤ç•¶å‰ç•«å¸ƒèˆ‡è³‡æ–™ï¼Œè¼‰å…¥ç¯„ä¾‹ï¼Ÿ')) return;
            
            state.elements = [];
            el('canvas').innerHTML = '<div id="splitLine"></div>';
            
            let demoData = [];
            
            if (type === 'invoice') {
                // ä¸‰è¯å¼ç™¼ç¥¨ç¯„ä¾‹
                demoData = [
                    {çµ±ç·¨:'10622345', å®¢æˆ¶åç¨±:'å°ç£ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸', ç™¼ç¥¨è™Ÿç¢¼:'AB12345678', æ—¥æœŸ:'2025/01/15', å“å:'åŸå­ç­†', è¦æ ¼:'è—è‰²', æ•¸é‡:'10', å–®åƒ¹:'15', é‡‘é¡:'150'},
                    {çµ±ç·¨:'10622345', å®¢æˆ¶åç¨±:'å°ç£ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸', ç™¼ç¥¨è™Ÿç¢¼:'AB12345678', æ—¥æœŸ:'2025/01/15', å“å:'A4å½±å°ç´™', è¦æ ¼:'80ç£…', æ•¸é‡:'2', å–®åƒ¹:'450', é‡‘é¡:'900'}
                ];
                setPage('a4', 'portrait', 'group');
                addElement('title', 'é›»å­è¨ˆç®—æ©Ÿçµ±ä¸€ç™¼ç¥¨', 250, 30, 300, 30, 22, 'bold');
                addElement('text', 'è²·å—äººï¼š', 40, 90, 60, 25, 12, 'bold');
                addElement('field', 'å®¢æˆ¶åç¨±', 100, 90, 200, 25, 12, 'normal', '#eee', '1px solid #999');
                addElement('text', 'çµ±ä¸€ç·¨è™Ÿï¼š', 500, 90, 80, 25, 12, 'bold');
                addElement('field', 'çµ±ç·¨', 580, 90, 150, 25, 12, 'normal', '#eee', '1px solid #999');
                
                // Smart Table
                const tbl = {
                    id: 'el-demo-tbl', type: 'table', x: 40, y: 140,
                    columns: ['å“å', 'è¦æ ¼', 'æ•¸é‡', 'å–®åƒ¹', 'é‡‘é¡'],
                    fields: ['å“å', 'è¦æ ¼', 'æ•¸é‡', 'å–®åƒ¹', 'é‡‘é¡'],
                    columnWidths: [200, 100, 80, 100, 100],
                    rowHeight: 30, headerHeight: 35, headerBg: '#f0f0f0', headerBorder: '2px solid #333', cellBorder: '1px solid #999',
                    fontSize: 12, headerFontWeight: 'bold', mergedCells: [], columnAligns: ['left','left','center','right','right']
                };
                state.elements.push(tbl);
                renderTableElementAdvanced(tbl);
                
                state.config.splitY = 140;
                updSplit();
            }
            else if (type === 'label') {
                // æ¨™ç±¤è²¼ç´™ç¯„ä¾‹
                demoData = [
                    {å“å:'åŸå­ç­†', æ¢ç¢¼:'4712345678901', å”®åƒ¹:'15'},
                    {å“å:'A4å½±å°ç´™', æ¢ç¢¼:'4712345678902', å”®åƒ¹:'450'},
                    {å“å:'æ»‘é¼ å¢Š', æ¢ç¢¼:'4712345678903', å”®åƒ¹:'280'},
                    {å“å:'USBéš¨èº«ç¢Ÿ', æ¢ç¢¼:'4712345678904', å”®åƒ¹:'599'}
                ];
                setPage('a4', 'portrait', 'grid');
                state.config.gC = 2; state.config.gR = 4;
                el('gCols').value = 2; el('gRows').value = 4;
                
                addElement('text', '', 0, 0, 350, 200, 12, 'normal', 'transparent', '2px solid #ccc');
                addElement('title', 'ç”¢å“æ¨™ç±¤', 20, 20, 150, 30, 16, 'bold');
                addElement('text', 'å“å:', 20, 60, 50, 25, 12, 'bold');
                addElement('field', 'å“å', 80, 60, 200, 25, 14, 'bold', '#eee');
                addElement('text', 'å”®åƒ¹: $', 20, 100, 60, 25, 12, 'bold');
                addElement('field', 'å”®åƒ¹', 80, 100, 100, 25, 14, 'normal', '#eee');
                addElement('text', '||||||||||||||||||||', 20, 140, 200, 30, 20, 'normal'); // Fake barcode
            }
            else if (type === 'shipping') {
                // å‡ºè²¨å–®ç¯„ä¾‹
                demoData = [
                    {æ¥­å‹™:'é˜¿æ˜', å®¢æˆ¶åç¨±:'å°ç£ç§‘æŠ€', å“å:'åŸå­ç­†', æ•¸é‡:'10', å–®åƒ¹:'15', é‡‘é¡:'150', æ—¥æœŸ:'2025/01/15'},
                    {æ¥­å‹™:'é˜¿æ˜', å®¢æˆ¶åç¨±:'å°ç£ç§‘æŠ€', å“å:'A4ç´™', æ•¸é‡:'2', å–®åƒ¹:'450', é‡‘é¡:'900', æ—¥æœŸ:'2025/01/15'},
                    {æ¥­å‹™:'å°èŠ±', å®¢æˆ¶åç¨±:'å€‹äººæˆ¶', å“å:'æ»‘é¼ å¢Š', æ•¸é‡:'1', å–®åƒ¹:'280', é‡‘é¡:'280', æ—¥æœŸ:'2025/01/16'}
                ];
                setPage('a4', 'portrait', 'group');
                state.config.grpF = 'å®¢æˆ¶åç¨±';
                
                addElement('title', 'å‡ºè²¨å–®', 20, 20, 200, 40, 24, 'bold');
                addElement('text', 'å®¢æˆ¶:', 20, 70, 50, 25, 12, 'bold');
                addElement('field', 'å®¢æˆ¶åç¨±', 80, 70, 200, 25, 12, 'normal', '#eee');
                addElement('text', 'æ¥­å‹™:', 300, 70, 50, 25, 12, 'bold');
                addElement('field', 'æ¥­å‹™', 360, 70, 100, 25, 12, 'normal', '#eee');
                
                const tbl = {
                    id: 'el-demo-ship', type: 'table', x: 20, y: 110,
                    columns: ['å“å', 'æ•¸é‡', 'å–®åƒ¹', 'é‡‘é¡'],
                    fields: ['å“å', 'æ•¸é‡', 'å–®åƒ¹', 'é‡‘é¡'],
                    columnWidths: [250, 80, 100, 100],
                    rowHeight: 30, headerHeight: 35, headerBg: '#e0e7ff', headerBorder: '1px solid #6366f1', cellBorder: '1px solid #ccc',
                    fontSize: 12, headerFontWeight: 'bold', mergedCells: [], columnAligns: ['left','center','right','right']
                };
                state.elements.push(tbl);
                renderTableElementAdvanced(tbl);
                
                state.config.splitY = 110;
                updSplit();
            }
            else if (type === 'receipt') {
                // æ”¶æ“šç¯„ä¾‹
                demoData = [
                    {å“å:'åŸå­ç­†', æ•¸é‡:'10', å–®åƒ¹:'15', é‡‘é¡:'150'},
                    {å“å:'A4å½±å°ç´™', æ•¸é‡:'2', å–®åƒ¹:'450', é‡‘é¡:'900'}
                ];
                setPage('receipt80', 'portrait', 'group');
                addElement('title', 'æ­¡è¿å…‰è‡¨', 10, 10, 200, 30, 16, 'bold');
                addElement('text', '--------------------------', 0, 40, 250, 20);
                
                const tbl = {
                    id: 'el-demo-rec', type: 'table', x: 0, y: 60,
                    columns: ['å“å', 'æ•¸é‡', 'é‡‘é¡'],
                    fields: ['å“å', 'æ•¸é‡', 'é‡‘é¡'],
                    columnWidths: [120, 50, 80],
                    rowHeight: 25, headerHeight: 25, headerBg: 'transparent', headerBorder: 'none', cellBorder: 'none',
                    fontSize: 11, headerFontWeight: 'bold', mergedCells: [], columnAligns: ['left','center','right']
                };
                state.elements.push(tbl);
                renderTableElementAdvanced(tbl);
                
                state.config.splitY = 60;
                updSplit();
            }

            // Load Data
            state.data = demoData;
            state.fields = Object.keys(demoData[0]);
            renderFields();
            el('fileInfo').innerText = `âœ… å·²è¼‰å…¥ç¯„ä¾‹è³‡æ–™ (${state.data.length} ç­†)`;
            
            // Switch to Data Tab to show fields
            document.querySelector('[data-tab="tab1"]').click();
        };

        // --- Quick Text Logic ---
        function parseQuickText() {
            const txt = el('quickTextInput').value;
            if(!txt.trim()) return;
            const items = txt.split(/[\s,]+/).filter(t => t.trim());
            el('quickTextList').innerHTML = items.map(t => 
                `<div class="tag-item" draggable="true" ondragstart="dragQuickText(event, '${t}')">${t}</div>`
            ).join('');
        }
        window.dragQuickText = (e, val) => {
            e.dataTransfer.setData('type', 'text-replace');
            e.dataTransfer.setData('val', val);
        };

        // --- Table Wizard ---
        function openTableModal(mode) {
            currentTableMode = mode || 'smart';
            el('tableModal').style.display = 'flex';
            el('modalTitle').innerText = mode === 'smart' ? 'æ™ºèƒ½è¡¨æ ¼ (å–®ä¸€ç‰©ä»¶)' : 'è™›æ“¬æ ¼ç·š (å–®æ ¼è‡ªç”±æ’)';
        }
        function closeTableModal() { el('tableModal').style.display = 'none'; }
        function insertTable() { if (currentTableMode === 'smart') insertTableSmart(); else insertTableVirtual(); }

        // === Smart Table Logic ===
        function insertTableSmart() {
            const rows = parseInt(el('tblRows').value) || 2;
            const cols = parseInt(el('tblCols').value) || 3;
            const auto = el('autoFill').checked;
            const columns = [], fields = [], columnWidths = [];
            for (let c = 0; c < cols; c++) {
                const fname = auto && state.fields[c] ? state.fields[c] : '';
                columns.push(fname || `æ¬„ä½ ${c+1}`); fields.push(fname); columnWidths.push(100);
            }
            const tblConfig = {
                id: 'el-' + Math.random().toString(36).substr(2, 9), type: 'table',
                x: 20, y: 50, columns, fields, columnWidths,
                rowHeight: 30, headerHeight: 35, headerBg: '#f0f0f0', headerBorder: '2px solid #333', cellBorder: '1px solid #999',
                fontSize: 14, headerFontWeight: 'bold', mergedCells: [], columnAligns: Array(cols).fill('left')
            };
            state.elements.push(tblConfig); renderTableElementAdvanced(tblConfig);
            if(rows > 1) { state.config.mode = 'group'; el('mode').value = 'group'; updMode(); }
            closeTableModal();
        }

        function renderTableElementAdvanced(table) {
            const d = document.createElement('div'); d.id = table.id; d.className = 'canvas-element table-element';
            const totalW = table.columnWidths.reduce((a, b) => a + b, 0);
            const totalH = table.headerHeight + table.rowHeight * 2;
            d.style.cssText = `left:${table.x}px; top:${table.y}px; width:${totalW}px; height:${totalH}px; border:2px solid #2186c4; background:white; cursor:move; position:absolute;`;
            
            let html = '<div style="width:100%;height:100%;">';
            // Header
            html += `<div style="display:flex; height:${table.headerHeight}px;">`;
            table.columns.forEach((col, i) => {
                html += `<div style="position:relative; width:${table.columnWidths[i]}px; background:${table.headerBg}; border:${table.headerBorder}; padding:5px; font-weight:${table.headerFontWeight}; font-size:${table.fontSize}px; text-align:${table.columnAligns[i]}; overflow:hidden; box-sizing:border-box; color:#333;">${col}<div class="col-resizer" data-col="${i}" style="position:absolute; right:0; top:0; width:5px; height:100%; cursor:col-resize;"></div></div>`;
            });
            html += '</div>';
            // Data
            html += `<div style="display:flex; height:${table.rowHeight}px;">`;
            table.fields.forEach((f, i) => { 
                html += `<div class="table-cell-drop" data-col="${i}" style="width:${table.columnWidths[i]}px; border:${table.cellBorder}; padding:5px; font-size:${table.fontSize}px; text-align:${table.columnAligns[i]}; color:#666; overflow:hidden; box-sizing:border-box;">[${f||'æ‹–æ›³æ¬„ä½'}]</div>`; 
            });
            html += '</div></div>';
            
            d.innerHTML = html;
            d.onmouseenter = () => d.querySelectorAll('.col-resizer').forEach(r => r.style.opacity = '1');
            d.onmouseleave = () => d.querySelectorAll('.col-resizer').forEach(r => r.style.opacity = '0');
            
            d.querySelectorAll('.col-resizer').forEach(r => {
                r.onmousedown = (e) => {
                    e.stopPropagation(); const ci = +r.dataset.col, sx = e.clientX, sw = table.columnWidths[ci];
                    const mv = (ev) => { table.columnWidths[ci] = Math.max(20, sw + (ev.clientX - sx)); d.remove(); renderTableElementAdvanced(table); };
                    const up = () => { document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up); renderTableProps(table); };
                    document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
                };
            });

            d.querySelectorAll('.table-cell-drop').forEach(cell => {
                cell.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); cell.style.background = '#e6f7ff'; });
                cell.addEventListener('dragleave', (e) => { e.stopPropagation(); cell.style.background = 'transparent'; });
                cell.addEventListener('drop', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    const type = e.dataTransfer.getData('type');
                    const val = e.dataTransfer.getData('val');
                    if (type === 'field') updateTableField(table.id, parseInt(cell.dataset.col), val);
                    cell.style.background = 'transparent';
                });
            });

            d.onmousedown = (e) => { if(e.target.classList.contains('col-resizer'))return; e.stopPropagation(); selEl(table); dragTable(e, table, d); };
            d.oncontextmenu = (e) => { e.preventDefault(); showTableCtxMenu(e, table); };
            el('canvas').appendChild(d);
        }

        function dragTable(e, table, d) {
            const sx = e.clientX, sy = e.clientY, stX = table.x, stY = table.y;
            const mv = (ev) => { table.x = stX + (ev.clientX - sx); table.y = stY + (ev.clientY - sy); d.style.left = table.x + 'px'; d.style.top = table.y + 'px'; };
            const up = () => { document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up); };
            document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
        }

        // === Table Props ===
        function renderTableProps(t) {
            const totalW = t.columnWidths.reduce((a, b) => a + b, 0);
            el('props').innerHTML = `
                <div class="panel-title">è¡¨æ ¼è¨­å®š (å¯¬:${totalW}px)</div>
                <div class="form-group"><label>è¡¨é ­é«˜</label><input type="number" class="form-control" value="${t.headerHeight}" oninput="updTbl('${t.id}','headerHeight',+this.value)"></div>
                <div class="form-group"><label>åˆ—é«˜</label><input type="number" class="form-control" value="${t.rowHeight}" oninput="updTbl('${t.id}','rowHeight',+this.value)"></div>
                <div class="form-group"><label>å­—é«”</label><input type="number" class="form-control" value="${t.fontSize}" oninput="updTbl('${t.id}','fontSize',+this.value)"></div>
                <div class="form-group"><label>èƒŒæ™¯</label><input type="color" class="form-control" value="${t.headerBg}" oninput="updTbl('${t.id}','headerBg',this.value)"></div>
                <div class="form-group"><label>é‚Šæ¡†</label><select class="form-control" onchange="updTbl('${t.id}','cellBorder',this.value)"><option value="none">ç„¡</option><option value="1px solid #999">ç´°ç·š</option><option value="2px solid #333">ç²—ç·š</option></select></div>
                <div class="panel-title">æ¬„ä½å¾®èª¿</div>
                ${t.columns.map((c,i)=>`
                    <div class="prop-col-item" style="padding:8px;margin-bottom:5px;border-radius:4px;" 
                            ondragover="allowDrop(event, this)" ondragleave="leaveDrop(this)" ondrop="dropToProp(event, '${t.id}', ${i}, this)">
                        <div style="font-weight:bold;margin-bottom:3px;font-size:12px;">${i+1}. ${c}</div>
                        <div style="display:flex;gap:4px;margin-bottom:4px;">
                            <input type="number" value="${t.columnWidths[i]}" class="form-control" style="width:60px;padding:4px;" oninput="updColW('${t.id}',${i},+this.value)">
                            <select class="form-control" style="padding:4px;" onchange="updColA('${t.id}',${i},this.value)"><option value="left" ${t.columnAligns[i]=='left'?'selected':''}>å·¦</option><option value="center" ${t.columnAligns[i]=='center'?'selected':''}>ä¸­</option><option value="right" ${t.columnAligns[i]=='right'?'selected':''}>å³</option></select>
                        </div>
                        <div style="font-size:11px;color:var(--primary);border:1px dashed var(--border);padding:4px;background:var(--surface);display:flex;justify-content:space-between;align-items:center;border-radius:4px;">
                            <span>ğŸ”— ${t.fields[i] || 'æœªç¶å®š'}</span>
                            ${t.fields[i] ? `<span onclick="removeTableField('${t.id}', ${i})" style="cursor:pointer;color:var(--danger);font-weight:bold;" title="è§£é™¤ç¶å®š">âœ•</span>` : ''}
                        </div>
                    </div>`).join('')}
                <button class="btn btn-danger btn-block" style="margin-top:10px" onclick="delEl('${t.id}')">åˆªé™¤è¡¨æ ¼</button>`;
        }
        
        window.allowDrop = (e, el) => { e.preventDefault(); el.classList.add('drag-over'); };
        window.leaveDrop = (el) => { el.classList.remove('drag-over'); };
        window.dropToProp = (e, id, idx, el) => {
            e.preventDefault(); el.classList.remove('drag-over');
            const type = e.dataTransfer.getData('type');
            const val = e.dataTransfer.getData('val');
            if (type === 'field') updateTableField(id, idx, val);
            else if (type === 'text-replace') updateTableColumnName(id, idx, val);
        };

        window.updTbl = (id, k, v) => { const t = state.elements.find(e => e.id === id); if(t) { t[k] = v; el(id).remove(); renderTableElementAdvanced(t); } };
        window.updColW = (id, i, v) => { const t = state.elements.find(e => e.id === id); if(t) { t.columnWidths[i] = Math.max(10, v); el(id).remove(); renderTableElementAdvanced(t); } };
        window.updColA = (id, i, v) => { const t = state.elements.find(e => e.id === id); if(t) { t.columnAligns[i] = v; el(id).remove(); renderTableElementAdvanced(t); } };
        window.updateTableField = (id, i, f) => { const t = state.elements.find(e => e.id === id); if(t) { t.fields[i] = f; el(id).remove(); renderTableElementAdvanced(t); renderTableProps(t); } };
        window.updateTableColumnName = (id, i, n) => { const t = state.elements.find(e => e.id === id); if(t) { t.columns[i] = n; el(id).remove(); renderTableElementAdvanced(t); renderTableProps(t); } };
        window.removeTableField = (id, i) => { const t = state.elements.find(e => e.id === id); if(t) { t.fields[i] = ''; el(id).remove(); renderTableElementAdvanced(t); renderTableProps(t); } };

        // === Context Menu ===
        function showTableCtxMenu(e, t) {
            document.querySelectorAll('.context-menu').forEach(m => m.remove());
            const m = document.createElement('div'); m.className = 'context-menu';
            m.style.left = e.clientX + 'px'; m.style.top = e.clientY + 'px';
            [
                { l: 'â• åŠ æ¬„ä½', a: () => addCol(t) }, { l: 'â– åˆªæ¬„ä½', a: () => remCol(t) }, { l: 'ğŸ”€ åˆä½µå„²å­˜æ ¼', a: () => openMerge(t) }
            ].forEach(i => {
                const b = document.createElement('div'); b.innerText = i.l; b.onclick = () => { i.a(); m.remove(); }; m.appendChild(b);
            });
            document.body.appendChild(m);
            setTimeout(() => document.addEventListener('click', () => m.remove(), { once: true }), 100);
        }
        function addCol(t) { t.columns.push('æ–°æ¬„'); t.fields.push(''); t.columnWidths.push(100); t.columnAligns.push('left'); el(t.id).remove(); renderTableElementAdvanced(t); renderTableProps(t); }
        function remCol(t) { if(t.columns.length>1){ t.columns.pop(); t.fields.pop(); t.columnWidths.pop(); t.columnAligns.pop(); el(t.id).remove(); renderTableElementAdvanced(t); renderTableProps(t); } }
        function openMerge(t) {
            const res = prompt(`è¼¸å…¥åˆä½µåƒæ•¸ (åˆ—,èµ·å§‹æ¬„,æ¬„æ•¸)\nåˆ—: 0=è¡¨é ­, 1=å…§å®¹\nä¾‹å¦‚: 0,0,2 (åˆä½µè¡¨é ­å‰å…©æ¬„)`);
            if(res) {
                const [r, c, s] = res.split(',').map(Number);
                if(!isNaN(r) && !isNaN(c) && !isNaN(s)) {
                    if(!t.mergedCells) t.mergedCells = [];
                    t.mergedCells.push({ row: r, col: c, colspan: s });
                    el(t.id).remove(); renderTableElementAdvanced(t);
                }
            }
        }

        // === Virtual Table Logic ===
        function insertTableVirtual() {
            const rows = parseInt(el('tblRows').value) || 2;
            const cols = parseInt(el('tblCols').value) || 3;
            const auto = el('autoFill').checked;
            const sx = 20, sy = 50, cw = 120, ch = 30;
            for (let c = 0; c < cols; c++) {
                const h = addElement('text', auto && state.fields[c] ? state.fields[c] : `æ¨™é¡Œ ${c+1}`, sx + c * cw, sy, cw, ch, 14, 'bold', '#f0f0f0', 'none'); h.isTableHeader = true;
                if (rows > 1) { const f = addElement(auto && state.fields[c] ? 'field' : 'text', auto && state.fields[c] ? state.fields[c] : 'å…§å®¹', sx + c * cw, sy + ch, cw, ch, 14, 'normal', 'transparent', 'none'); f.isTableData = true; f.tableColumn = c; }
            }
            if(rows > 1) { state.config.mode = 'group'; el('mode').value = 'group'; state.config.splitY = sy + ch; state.config.rowH = ch; updMode(); updSplit(); el('splitY').value = Math.round(state.config.splitY); }
            closeTableModal();
        }
        function genGL(el, w, h) {
            const s = el.isTableHeader ? '2px solid #333' : '1px solid #999';
            return [ {x1:el.x,y1:el.y,x2:el.x+w,y2:el.y,s}, {x1:el.x,y1:el.y+h,x2:el.x+w,y2:el.y+h,s:'1px solid #999'}, {x1:el.x,y1:el.y,x2:el.x,y2:el.y+h,s:'1px solid #999'}, {x1:el.x+w,y1:el.y,x2:el.x+w,y2:el.y+h,s:'1px solid #999'} ];
        }
        function renGL(l) {
            const d = document.createElement('div'); d.className = 'print-element';
            if (l.y1 === l.y2) d.style.cssText = `position:absolute; left:${l.x1}px; top:${l.y1}px; width:${l.x2-l.x1}px; height:0; border-top:${l.s};`;
            else d.style.cssText = `position:absolute; left:${l.x1}px; top:${l.y1}px; width:0; height:${l.y2-l.y1}px; border-left:${l.s};`;
            return d;
        }

        // --- Common Elements ---
        function addElement(type, c, x, y, w=120, h=30, fs=14, fw='normal', bg='transparent', br='1px dashed #ccc') {
            const item = { id: 'el-'+Math.random().toString(36).substr(2,9), type, content:c, x:x||20, y:y||20, width:w, height:h, fontSize:fs, fontWeight:fw, backgroundColor:bg, border:br, fieldName:type==='field'?c:null };
            state.elements.push(item); renderEl(item); return item;
        }
        function renderEl(item) {
            if (item.type === 'table') { renderTableElementAdvanced(item); return; }
            const d = document.createElement('div'); d.id = item.id; d.className = 'canvas-element'; updEl(d, item);
            d.innerHTML = `<div class="canvas-element-value">${item.type==='field'?`[${item.content}]`:item.content}</div><div class="resize-handle"></div>`;
            d.onmousedown = (e) => { 
                if(e.target.className.includes('resize')) return; 
                e.preventDefault(); // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šé˜²æ­¢ç€è¦½å™¨é è¨­æ‹–æ›³è¡Œç‚º â˜…â˜…â˜…
                e.stopPropagation(); 
                selEl(item); 
                drag(e, item, d, 'move'); 
            };
            d.querySelector('.resize-handle').onmousedown = (e) => { e.stopPropagation(); drag(e, item, d, 'resize'); };
            el('canvas').appendChild(d);
        }
        function drag(e, item, d, mode) {
            const sx=e.clientX, sy=e.clientY;
            const sv = mode === 'move' ? { x: Number(item.x), y: Number(item.y) } : { w: Number(item.width), h: Number(item.height) };
            const mv=(ev)=>{ 
                if(mode==='move'){ item.x = sv.x + (ev.clientX - sx); item.y = sv.y + (ev.clientY - sy); } 
                else { item.width = Math.max(5, sv.w + (ev.clientX - sx)); item.height = Math.max(5, sv.h + (ev.clientY - sy)); renderProps(item); } 
                updEl(d,item); 
                updateFloatBar();
            };
            const up=()=>{document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
            document.addEventListener('mousemove',mv); document.addEventListener('mouseup',up);
        }
        function updEl(d, i) { Object.assign(d.style, { left:i.x+'px', top:i.y+'px', width:i.width+'px', height:i.height+'px', fontSize:i.fontSize+'px', fontWeight:i.fontWeight, background:i.backgroundColor, border:i.border }); }
        
        function selEl(i) { state.selected=i; document.querySelectorAll('.selected').forEach(x=>x.classList.remove('selected')); el(i.id).classList.add('selected'); renderProps(i); updateFloatBar(); }
        
        function renderProps(i) {
            if (i.type === 'table') return renderTableProps(i);
            el('props').innerHTML = `
                <div class="panel-title">å…ƒä»¶å±¬æ€§</div>
                <div class="form-group"><label class="form-label">å…§å®¹</label><input class="form-control" value="${i.content}" oninput="setProp('${i.id}','content',this.value)"></div>
                <div style="display:flex; gap:8px;">
                    <div class="form-group" style="flex:1"><label class="form-label">å¯¬</label><input type="number" class="form-control" value="${i.width}" oninput="setProp('${i.id}','width',+this.value)"></div>
                    <div class="form-group" style="flex:1"><label class="form-label">é«˜</label><input type="number" class="form-control" value="${i.height}" oninput="setProp('${i.id}','height',+this.value)"></div>
                </div>
                <div class="form-group"><label class="form-label">å­—é«”å¤§å°</label><input type="number" class="form-control" value="${i.fontSize}" oninput="setProp('${i.id}','fontSize',+this.value)"></div>
                <div class="form-group"><label class="form-label">èƒŒæ™¯è‰²</label><input type="color" class="form-control" style="height:40px" value="${i.backgroundColor==='transparent'?'#ffffff':i.backgroundColor}" oninput="setProp('${i.id}','backgroundColor',this.value)"></div>
                <div class="form-group"><label class="form-label">é‚Šæ¡†</label><select class="form-control" onchange="setProp('${i.id}','border',this.value)"><option value="none">ç„¡</option><option value="1px solid #000">å¯¦ç·š</option><option value="1px dashed #000">è™›ç·š</option></select></div>
                <button class="btn btn-danger btn-block" onclick="delEl('${i.id}')">åˆªé™¤å…ƒä»¶</button>`;
        }
        window.setProp = (id, k, v) => { const i = state.elements.find(x => x.id === id); if (i) { i[k] = v; updEl(el(id), i); if (k === 'content') el(id).querySelector('.canvas-element-value').innerText = i.type === 'field' ? `[${v}]` : v; } };
        window.delEl = (id) => { state.elements = state.elements.filter(x => x.id !== id); el(id).remove(); el('props').innerHTML = ''; el('floatBar').classList.remove('show'); };

        // Float Bar
        function updateFloatBar() {
            const sel = state.selected && el(state.selected.id);
            const bar = el('floatBar');
            if (sel && state.selected.type !== 'table') {
                const rect = sel.getBoundingClientRect();
                const canvasRect = el('canvas').getBoundingClientRect();
                bar.style.left = (rect.right - canvasRect.left + 10) + 'px';
                bar.style.top = (rect.top - canvasRect.top - 50) + 'px';
                bar.classList.add('show');
            } else {
                bar.classList.remove('show');
            }
        }
        window.duplicateSelected = () => {
            if (!state.selected) return;
            const orig = state.selected;
            const copy = JSON.parse(JSON.stringify(orig));
            copy.id = 'el-' + Math.random().toString(36).substr(2,9);
            copy.x += 20; copy.y += 20;
            state.elements.push(copy);
            renderEl(copy);
        };
        window.bringToFront = () => { if(state.selected){ const el = state.elements.splice(state.elements.indexOf(state.selected),1)[0]; state.elements.push(el); rerenderAll(); } };
        window.sendToBack = () => { if(state.selected){ const el = state.elements.splice(state.elements.indexOf(state.selected),1)[0]; state.elements.unshift(el); rerenderAll(); } };
        function rerenderAll() { el('canvas').innerHTML = '<div id="splitLine"></div>'; state.elements.forEach(renderEl); }

        // --- PDF & File ---
        el('pdfBtn').onclick = () => { el('pdfFile').value = ''; el('pdfFile').click(); };
        el('pdfFile').onchange = async (e) => {
            const f = e.target.files[0]; if (!f) return;
            if(!confirm('åŒ¯å…¥ PDF ç‚ºåº•åœ–ï¼Ÿ')) return;
            const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
            const page = await pdf.getPage(1);
            const vp = page.getViewport({ scale: 1.5 });
            const cvs = document.createElement('canvas'); cvs.width = vp.width; cvs.height = vp.height;
            await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
            const raw = page.getViewport({ scale: 1.0 });
            state.config.size = 'custom'; state.config.w = raw.width * 0.3528; state.config.h = raw.height * 0.3528;
            el('pageSize').value = 'custom';
            el('canvas').style.backgroundImage = `url(${cvs.toDataURL()})`; el('canvas').style.backgroundSize = '100% 100%';
            el('clearBgBtn').style.display = 'inline-block';
            state.elements = []; el('canvas').innerHTML = '<div id="splitLine"></div>'; updSz();
        };
        el('clearBgBtn').onclick = () => { el('canvas').style.backgroundImage = 'none'; el('clearBgBtn').style.display = 'none'; };
        el('dataBtn').onclick = () => el('dataFile').click();
        el('dataFile').onchange = (e) => {
            const f = e.target.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = (ev) => { state.data = f.name.endsWith('.json') ? JSON.parse(ev.target.result) : parseCSV(ev.target.result); state.fields = Object.keys(state.data[0] || {}); renderFields(); el('fileInfo').innerText = `âœ… ${state.data.length} ç­†è³‡æ–™`; }; r.readAsText(f);
        };
        function parseCSV(t) { const [h, ...r] = t.trim().split('\n'); const ks = h.split(',').map(s => s.trim()); return r.map(l => l.split(',').reduce((a, v, i) => ({ ...a, [ks[i]]: v.trim() }), {})); }
        function renderFields() { el('fieldList').innerHTML = state.fields.map(f => `<div class="field-item" draggable="true" data-f="${f}"><span class="material-symbols-outlined" style="font-size:16px;color:var(--primary)">data_object</span> ${f}</div>`).join(''); el('grpField').innerHTML = `<option value="">--</option>` + state.fields.map(f => `<option value="${f}">${f}</option>`).join(''); initDrag(); }
        function initDrag() {
            el('fieldList').ondragstart = (e) => { e.dataTransfer.setData('type', 'field'); e.dataTransfer.setData('val', e.target.dataset.f); };
            el('canvas').ondragover = (e) => e.preventDefault();
            el('canvas').ondrop = (e) => { e.preventDefault(); const t = e.dataTransfer.getData('type'); if (t) addElement(t, e.dataTransfer.getData('val'), e.clientX - el('canvas').getBoundingClientRect().left, e.clientY - el('canvas').getBoundingClientRect().top); };
            let sp = false; el('splitLine').onmousedown = () => sp = true;
            document.onmousemove = (e) => { if (sp) { state.config.splitY = Math.max(0, e.clientY - el('canvas').getBoundingClientRect().top); updSplit(); el('splitY').value = Math.round(state.config.splitY); } };
            document.onmouseup = () => sp = false;
        }
        function updSplit() { el('splitLine').style.top = state.config.splitY + 'px'; }
        el('mode').onchange = (e) => { state.config.mode = e.target.value; updMode(); };
        function updMode() { const m = state.config.mode; el('grpSet').style.display = m === 'group' ? 'block' : 'none'; el('gridSet').style.display = m === 'grid' ? 'block' : 'none'; el('splitLine').style.display = m === 'group' ? 'block' : 'none'; }
        ['gCols', 'gRows', 'gX', 'gY'].forEach(k => el(k).onchange = (e) => state.config[k] = +e.target.value);
        el('splitY').onchange = (e) => { state.config.splitY = +e.target.value; updSplit(); };
        el('rowH').onchange = (e) => state.config.rowH = +e.target.value;
        el('grpField').onchange = (e) => state.config.grpF = e.target.value;
        window.autoCalcGrid = () => {
            if (!state.elements.length) return alert('ç©ºç•«å¸ƒ');
            let mx = 0, my = 0; state.elements.forEach(e => { mx = Math.max(mx, e.x + e.width); my = Math.max(my, e.y + e.height); });
            const MM = 3.78, pW = state.config.w * MM, pH = state.config.h * MM, m = 5 * MM;
            const c = Math.floor((pW - m * 2 + state.config.gX) / (mx + state.config.gX));
            const r = Math.floor((pH - m * 2 + state.config.gY) / (my + state.config.gY));
            state.config.gC = c; state.config.gR = r; el('gCols').value = c; el('gRows').value = r; alert(`è¨ˆç®—: ${c}x${r}`);
        };

        // --- Print Engine ---
        el('printBtn').onclick = () => {
            const c = el('print-container'); c.innerHTML = '';
            if (!state.data.length && state.elements.length) { const d = {}; state.fields.forEach(f => d[f] = `(${f})`); var old = state.data; state.data = [d]; runP(c); state.data = old; return; }
            if (!state.data.length) return alert('ç„¡æ•¸æ“š');
            runP(c);
        };
        function runP(c) {
            const s = document.createElement('style'); s.innerHTML = `@media print{@page{size:${state.config.size === 'custom' ? 'auto' : state.config.size} ${state.config.orient};margin:0;}}`; c.appendChild(s);
            const m = state.config.mode;
            if (m === 'single') pS(c);
            else if (m === 'group') {
                const hasVTable = state.elements.some(e => e.isTableHeader || e.isTableData);
                if (hasVTable) pGWithGrid(c); else pG(c);
            } else if (m === 'grid') pGd(c);
            setTimeout(() => { window.print(); c.innerHTML = ''; }, 500);
        }
        function mkPg() { const d = document.createElement('div'); d.className = 'print-page'; d.style.width = state.config.w + 'mm'; d.style.height = state.config.size === 'receipt80' ? 'auto' : state.config.h + 'mm'; return d; }
        function mkEl(item, r, dx = 0, dy = 0) {
            const d = document.createElement('div'); d.className = 'print-element';
            const fx = item.x + dx, fy = item.y + dy;
            Object.assign(d.style, { left: fx + 'px', top: fy + 'px', width: item.width + 'px', height: item.height + 'px', fontSize: item.fontSize + 'px', fontWeight: item.fontWeight, background: item.backgroundColor, border: item.border });
            d.innerText = item.type === 'field' && r ? (r[item.fieldName] || '') : item.content; d.dataset.b = fy + item.height; return d;
        }
        
        // Smart Table Printing
        function mkTblRow(t, rec, y, isH) {
            const r = document.createElement('div'); r.className = 'print-table-row';
            r.style.cssText = `position:relative; left:${t.x}px; display:flex; width:${t.columnWidths.reduce((a,b)=>a+b,0)}px;`;
            const merges = t.mergedCells?.filter(m => m.row === (isH ? 0 : 1)) || [];
            const skip = new Set();
            (isH ? t.columns : t.fields).forEach((val, i) => {
                if (skip.has(i)) return;
                const m = merges.find(m => m.col === i);
                let w = t.columnWidths[i], cs = 1;
                if (m) { cs = m.colspan; w = 0; for (let k = i; k < i + cs && k < t.columnWidths.length; k++) { w += t.columnWidths[k]; if(k>i) skip.add(k); } }
                const d = document.createElement('div'); d.className = 'print-table-cell';
                d.style.cssText = `width:${w}px; border:${isH?t.headerBorder:t.cellBorder}; background:${isH?t.headerBg:'transparent'}; padding:5px; font-size:${t.fontSize}px; font-weight:${isH?t.headerFontWeight:'normal'}; display:flex; align-items:center; justify-content:${t.columnAligns[i]}; box-sizing:border-box; word-break:break-word; white-space:pre-wrap; min-height:${isH?t.headerHeight:t.rowHeight}px;`;
                d.innerText = isH ? val : (rec[val] || '');
                r.appendChild(d);
            });
            return r;
        }

        function pS(c) { state.data.forEach(r => { const p = mkPg(); let mb = 0; state.elements.forEach(e => { if(e.type==='table')return; const x = mkEl(e, r); p.appendChild(x); mb = Math.max(mb, +x.dataset.b); }); if (state.config.size === 'receipt80') p.style.height = (mb + 20) + 'px'; c.appendChild(p); }); }
        function pG(c) {
            const g = {}, kf = state.config.grpF; state.data.forEach(r => { const k = kf ? r[kf] : 'A'; if (!g[k]) g[k] = []; g[k].push(r); });
            const pH = state.config.size === 'receipt80' ? 99999 : 1050;
            Object.values(g).forEach(rs => {
                let p = mkPg(); c.appendChild(p); 
                const wrapper = document.createElement('div'); wrapper.className = 'print-table-wrapper'; wrapper.style.top = state.config.splitY + 'px'; p.appendChild(wrapper);
                let cy = 0;
                rs.forEach((r, idx) => {
                    state.elements.filter(e => e.type === 'table').forEach(t => {
                        if (idx === 0) { const h = mkTblRow(t, null, 0, true); wrapper.appendChild(h); cy += h.offsetHeight; }
                        const d = mkTblRow(t, r, 0, false); wrapper.appendChild(d); 
                        if (cy > pH) { d.remove(); p = mkPg(); c.appendChild(p); const newWrap = document.createElement('div'); newWrap.className = 'print-table-wrapper'; newWrap.style.top = state.config.splitY + 'px'; p.appendChild(newWrap); const h = mkTblRow(t, null, 0, true); newWrap.appendChild(h); newWrap.appendChild(d); cy = 0; }
                        cy += 30;
                    });
                    state.elements.filter(e => e.type !== 'table').forEach(e => { if(idx===0) p.appendChild(mkEl(e, r)); });
                });
            });
        }
        function pGWithGrid(c) {
            const g = {}, kf = state.config.grpF; state.data.forEach(r => { const k = kf ? r[kf] : 'A'; if (!g[k]) g[k] = []; g[k].push(r); });
            const hE = state.elements.filter(e => e.y < state.config.splitY), dE = state.elements.filter(e => e.y >= state.config.splitY);
            const pH = state.config.size === 'receipt80' ? 99999 : 1050;
            Object.values(g).forEach(rs => {
                let p = mkPg(), cy = state.config.splitY;
                const rh = () => hE.forEach(e => { p.appendChild(mkEl(e, rs[0])); if(e.isTableHeader) genGL(e, e.width, e.height).forEach(l=>p.appendChild(renGL(l))); });
                rh();
                rs.forEach(r => {
                    if (cy + state.config.rowH > pH) { c.appendChild(p); p = mkPg(); rh(); cy = state.config.splitY; }
                    dE.forEach(e => {
                        const oy = cy - state.config.splitY;
                        const x = mkEl(e, r, 0, oy); x.style.top = (e.y + oy) + 'px'; p.appendChild(x);
                        if (e.isTableData) genGL({...e, y:e.y+oy}, e.width, e.height).forEach(l=>p.appendChild(renGL(l)));
                    });
                    cy += state.config.rowH;
                });
                c.appendChild(p);
            });
        }
        function pGd(c) {
            const { gC, gR, gX, gY } = state.config;
            let mx = 0, my = 0; state.elements.forEach(e => { mx = Math.max(mx, e.x + e.width); my = Math.max(my, e.y + e.height); });
            const cW = mx + gX, cH = my + gY, MM = 3.78, pW = state.config.w * MM, pH = state.config.h * MM;
            const tW = cW * gC - gX, tH = cH * gR - gY;
            const sx = Math.max(20, (pW - tW) / 2), sy = Math.max(20, (pH - tH) / 2);
            let p = mkPg(), i = 0;
            state.data.forEach(r => { if (i >= gC * gR) { p = mkPg(); c.appendChild(p); i = 0; } const col = i % gC, row = Math.floor(i / gC); state.elements.forEach(e => p.appendChild(mkEl(e, r, sx + col * cW, sy + row * cH))); i++; });
        }

        // --- æ–°å¢ï¼šåŒ¯å…¥ PDF è¡¨æ ¼çµæ§‹é‚è¼¯ ---
        el('layoutBtn').onclick = () => {
            el('layoutFile').value = '';
            el('layoutFile').click();
        };
        
        el('layoutFile').onchange = (e) => {
            const f = e.target.files[0];
            if (!f) return;
        
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    const json = JSON.parse(ev.target.result);
                    
                    // æª¢æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¢º
                    if (!json.columns || !Array.isArray(json.columns)) {
                        alert('æ ¼å¼éŒ¯èª¤ï¼šè«‹ä¸Šå‚³ç”± PDF è¡¨æ ¼åµæ¸¬å™¨åŒ¯å‡ºçš„ JSON æª”æ¡ˆ');
                        return;
                    }
        
                    importLayoutFromJSON(json);
                    
                    // è‡ªå‹•åˆ‡æ›åˆ°å…ƒä»¶åˆ†é ä»¥æŸ¥çœ‹çµæœ
                    document.querySelector('[data-tab="tab3"]').click(); // æˆ–æ˜¯ç•™åœ¨ç•¶å‰é é¢
                    alert('âœ… è¡¨æ ¼çµæ§‹å·²æˆåŠŸåŒ¯å…¥ï¼');
                } catch (err) {
                    alert('è§£æå¤±æ•—ï¼š' + err.message);
                    console.error(err);
                }
            };
            r.readAsText(f);
        };
        
        // --- ä¿®æ­£ç‰ˆï¼šåŒ¯å…¥ä¸¦å…è¨±å¾®èª¿ç¸®æ”¾ ---
        function importLayoutFromJSON(json) {
            const cols = json.columns;
            if (!cols || cols.length === 0) return;
        
            // 1. è©¢å•å¾®èª¿åƒæ•¸
            // æ¨™æº– A4 ç¶²é è§£æåº¦ä¸‹ï¼Œ1mm ç´„ç­‰æ–¼ 3.78px
            // ä½†å› ç‚ºåº•åœ– PDF è§£æåº¦ä¸åŒï¼Œå¯èƒ½éœ€è¦å¾®èª¿
            const defaultScale = 3.78; 
            let scaleStr = prompt(
                "è«‹ç¢ºèªåŒ¯å…¥ç¸®æ”¾å€ç‡ (px per mm)ï¼š\n" +
                "â— è‹¥è¡¨æ ¼å¤ªå°ï¼Œè«‹å°‡æ•¸å€¼æ”¹å¤§ (å¦‚ 4.0)\n" + 
                "â— è‹¥è¡¨æ ¼å¤ªå¤§ï¼Œè«‹å°‡æ•¸å€¼æ”¹å° (å¦‚ 3.5)\n" +
                "â— X ä½ç§»ï¼šå¯è¼¸å…¥ '3.78, 10' ä»£è¡¨å€ç‡ 3.78 ä¸”å‘å³ç§» 10px", 
                defaultScale
            );
        
            if (scaleStr === null) return; // å–æ¶ˆ
        
            // è§£æè¼¸å…¥ (æ”¯æ´ "å€ç‡, ä½ç§»X, ä½ç§»Y")
            let [scaleInput, offXInput, offYInput] = scaleStr.split(',').map(Number);
            
            const MM_TO_PX = scaleInput || defaultScale;
            const offsetX = offXInput || 0; // æ‰‹å‹• X ä¿®æ­£
            const offsetY = offYInput || 0; // æ‰‹å‹• Y ä¿®æ­£
        
            // 2. è¨ˆç®—èµ·å§‹ä½ç½®
            // åµæ¸¬å™¨çš„ X æ˜¯ mmï¼Œä¹˜ä¸Šå€ç‡å¾ŒåŠ ä¸Šæ‰‹å‹•ä¿®æ­£
            const startX = ((cols[0].x || 10) * MM_TO_PX) + offsetX;
            // Y è»¸é è¨­æ”¾åœ¨ 100px è™•ï¼Œä¹Ÿå¯ä¿®æ­£
            const startY = 100 + offsetY; 
        
            // 3. è½‰æ›è³‡æ–™èˆ‡å¯¬åº¦
            const columnNames = cols.map(c => c.name || 'æœªå‘½å');
            const fields = cols.map(c => c.name || ''); 
            
            // å¯¬åº¦è½‰æ›
            const columnWidths = cols.map(c => Math.round((c.width || 20) * MM_TO_PX));
        
            // 4. å»ºç«‹è¡¨æ ¼ç‰©ä»¶
            const newTable = {
                id: 'el-imported-' + Math.random().toString(36).substr(2, 9),
                type: 'table',
                x: startX,
                y: startY,
                columns: columnNames,
                fields: fields,
                columnWidths: columnWidths,
                // æ¨£å¼è¨­å®š
                rowHeight: 30,
                headerHeight: 35,
                headerBg: '#e0e7ff',
                headerBorder: '1px solid #6366f1',
                cellBorder: '1px solid #ccc',
                fontSize: 12,
                headerFontWeight: 'bold',
                mergedCells: [],
                columnAligns: columnNames.map(n => 
                    (n.includes('é‡‘') || n.includes('åƒ¹') || n.includes('æ•¸')) ? 'right' : 'left'
                )
            };
        
            // 5. æ’å…¥ä¸¦æ¸²æŸ“
            state.elements.push(newTable);
            renderTableElementAdvanced(newTable);
            
            // 6. å¦‚æœæ˜¯ Group æ¨¡å¼ï¼ŒåŒæ­¥èª¿æ•´åˆ†éš”ç·š
            if (state.config.mode === 'group') {
                state.config.splitY = startY;
                updSplit();
                el('splitY').value = Math.round(startY);
            }
        }
    </script>
</body>
</html>
