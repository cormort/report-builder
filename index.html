<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Report Studio v8.0 - å°ˆæ¥­è¨­è¨ˆç‰ˆ</title>
    <!-- å¼•å…¥ PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; --primary-light: #818cf8; --bg: #0f172a; --surface: #1e293b; --surface2: #334155;
            --border: #475569; --text: #e2e8f0; --text-secondary: #94a3b8; --success: #10b981; --danger: #ef4444;
            --guide-color: #0ea5e9; /* è¼”åŠ©ç·šé¡è‰² */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        .material-symbols-outlined { font-size: 20px; vertical-align: middle; }

        /* Header */
        .header { height: 60px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; z-index: 200; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; color: white; }
        .toolbar { display: flex; gap: 8px; background: var(--surface2); padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
        .tool-btn { background: transparent; border: none; color: var(--text); padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 4px; font-size: 13px; }
        .tool-btn:hover { background: rgba(255,255,255,0.1); }
        .tool-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .tool-btn.active { background: var(--primary); color: white; }

        /* Layout */
        .main-layout { flex: 1; display: flex; overflow: hidden; }
        .left-panel { width: 280px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 100; }
        .tab-nav { display: flex; background: var(--surface2); border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px 0; text-align: center; cursor: pointer; color: var(--text-secondary); transition: 0.2s; font-size: 13px; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: white; background: rgba(99,102,241,0.1); border-bottom-color: var(--primary); }
        .tab-content { flex: 1; overflow-y: auto; padding: 16px; display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Components */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
        .btn:hover { background: #475569; border-color: var(--text-secondary); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background: var(--primary); color: white; border: none; box-shadow: 0 4px 12px rgba(99,102,241,0.3); }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-success { background: var(--success); color: white; border: none; }
        .btn-danger { background: var(--danger); color: white; border: none; }
        .btn-block { width: 100%; }
        
        .form-group { margin-bottom: 14px; }
        .form-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; display: flex; justify-content: space-between; }
        .form-control { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 13px; transition: 0.2s; }
        .form-control:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }
        
        .upload-area { border: 2px dashed var(--border); padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; background: rgba(255,255,255,0.02); transition: 0.2s; }
        .upload-area:hover { border-color: var(--primary); background: rgba(99,102,241,0.05); }

        .field-item { padding: 8px 12px; background: var(--surface2); border-radius: 6px; margin-bottom: 6px; cursor: grab; display: flex; align-items: center; gap: 8px; font-size: 13px; border: 1px solid transparent; transition: 0.2s; }
        .field-item:hover { border-color: var(--primary); transform: translateX(4px); }
        .field-item:active { cursor: grabbing; }

        /* Center Canvas */
        .center-panel { flex: 1; background: #0f172a; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-container { flex: 1; overflow: auto; display: flex; justify-content: center; padding: 40px; position: relative; }
        .canvas { background: white; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform-origin: top center; transition: transform 0.2s; }
        /* æ ¼ç·šèƒŒæ™¯ */
        .canvas-bg-grid { background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
        
        /* Elements */
        .canvas-element { position: absolute; border: 1px dashed transparent; cursor: move; display: flex; align-items: center; box-sizing: border-box; color: #333; overflow: hidden; }
        .canvas-element:hover { border-color: var(--primary-light); }
        .canvas-element.selected { border: 2px solid var(--primary); z-index: 100; box-shadow: 0 0 0 4px rgba(99,102,241,0.2); }
        .canvas-element-value { width: 100%; pointer-events: none; overflow: hidden; white-space: nowrap; }
        
        /* Resize Handles */
        .resize-handle { position: absolute; width: 10px; height: 10px; background: white; border: 2px solid var(--primary); border-radius: 50%; opacity: 0; transition: 0.1s; z-index: 101; }
        .selected .resize-handle { opacity: 1; }
        .rh-se { bottom: -6px; right: -6px; cursor: se-resize; }
        .rh-e { top: 50%; right: -6px; transform: translateY(-50%); cursor: e-resize; }
        .rh-s { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: s-resize; }

        /* Guides & Snap */
        .guide-line { position: absolute; background: var(--guide-color); pointer-events: none; z-index: 999; display: none; }
        .guide-x { width: 100%; height: 1px; border-top: 1px dashed var(--guide-color); }
        .guide-y { height: 100%; width: 1px; border-left: 1px dashed var(--guide-color); }

        /* Right Panel */
        .right-panel { width: 300px; background: var(--surface); border-left: 1px solid var(--border); padding: 0; display: flex; flex-direction: column; z-index: 100; }
        .props-header { padding: 16px; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--primary-light); }
        .props-content { padding: 16px; overflow-y: auto; flex: 1; }

        /* Floating Toolbar */
        .floating-toolbar { position: absolute; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 6px; display: none; gap: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); z-index: 1000; transform: translateX(-50%); }
        .floating-toolbar.show { display: flex; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: translate(-50%, 10px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* Table & Props */
        .table-element { display: block !important; overflow: visible !important; border: none !important; background: transparent !important; }
        .col-resizer:hover { opacity: 1 !important; background: var(--primary) !important; }
        .context-menu { position: fixed; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 9999; min-width: 180px; overflow: hidden; }
        .context-menu-item { padding: 10px 16px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border); color: var(--text); display: flex; gap: 10px; align-items: center; }
        .context-menu-item:hover { background: var(--primary); color: white; }
        .context-menu-item:last-child { border-bottom: none; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal { background: var(--surface); padding: 24px; border-radius: 12px; width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid var(--border); animation: modalPop 0.3s; }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Split Line */
        #splitLine { position: absolute; left: 0; width: 100%; border-top: 2px dashed var(--danger); z-index: 90; cursor: ns-resize; opacity: 0.8; display: none; }
        #splitLine::after { content: "åˆ†çµ„/åˆ†é åˆ‡å‰²ç·š (Group Split)"; position: absolute; right: 0; top: -20px; background: var(--danger); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }

        /* Print */
        @media print {
            @page { margin: 0; }
            body * { visibility: hidden; }
            #print-container, #print-container * { visibility: visible; }
            #print-container { position: absolute; left: 0; top: 0; width: 100%; }
            .print-page { page-break-after: always; break-after: page; position: relative; overflow: hidden; background: white; margin: 0 auto; }
            .print-element { position: absolute; display: flex; align-items: center; color: black; box-sizing: border-box; }
            .print-table-cell { word-break: break-word; white-space: pre-wrap; }
        }
    </style>
</head>
<body>
    <!-- 1. Header with Tools -->
    <div class="header">
        <div class="header-left">
            <div class="title">
                <span class="material-symbols-outlined" style="font-size:32px;color:var(--primary)">auto_fix_high</span>
                <div>
                    Pro Report Studio <span style="color:var(--success);font-size:12px;vertical-align:top">v8.0</span>
                    <div style="font-size:11px;opacity:0.6;font-weight:400">Professional Layout Designer</div>
                </div>
            </div>
            <div class="toolbar">
                <button class="tool-btn" onclick="undo()" id="undoBtn" title="å¾©åŸ (Ctrl+Z)"><span class="material-symbols-outlined">undo</span></button>
                <button class="tool-btn" onclick="redo()" id="redoBtn" title="é‡åš (Ctrl+Y)"><span class="material-symbols-outlined">redo</span></button>
                <div style="width:1px;height:20px;background:var(--border);margin:0 4px"></div>
                <button class="tool-btn" onclick="saveProject()" title="å„²å­˜å°ˆæ¡ˆ (Design)"><span class="material-symbols-outlined">save</span> å„²å­˜</button>
                <button class="tool-btn" onclick="loadProject()" title="é–‹å•Ÿå°ˆæ¡ˆ"><span class="material-symbols-outlined">folder_open</span> é–‹å•Ÿ</button>
                <input type="file" id="projectFile" hidden accept=".prs,.json">
            </div>
        </div>
        <div>
            <button class="btn btn-success" id="printBtn">
                <span class="material-symbols-outlined">print</span> é è¦½èˆ‡åˆ—å°
            </button>
        </div>
    </div>

    <div class="main-layout">
        <!-- 2. Left Panel -->
        <div class="left-panel">
            <div class="tab-nav">
                <div class="tab-btn active" data-tab="tab1">è³‡æ–™ä¾†æº</div>
                <div class="tab-btn" data-tab="tab2">åŸºç¤å…ƒä»¶</div>
                <div class="tab-btn" data-tab="tab3">åœ–å±¤/é€Ÿæˆ</div>
            </div>

            <div id="tab1" class="tab-content active">
                <div class="form-group">
                    <div class="upload-area" onclick="el('dataFile').click()">
                        <span class="material-symbols-outlined" style="font-size:32px;color:var(--success)">table_view</span>
                        <div style="margin-top:8px;font-weight:500">åŒ¯å…¥è³‡æ–™ (CSV/JSON)</div>
                        <div style="font-size:11px;color:#999;margin-top:4px">æ”¯æ´ Excel è½‰å‡ºçš„ CSV</div>
                    </div>
                    <input type="file" id="dataFile" hidden accept=".csv,.json">
                    <div id="fileInfo" style="margin-top:8px;text-align:center;font-size:12px;color:var(--success)"></div>
                </div>
                
                <div class="form-group">
                    <div class="upload-area" onclick="el('pdfFile').click()" style="border-color:var(--primary)">
                        <span class="material-symbols-outlined" style="font-size:32px;color:var(--primary)">picture_as_pdf</span>
                        <div style="margin-top:8px;font-weight:500">åŒ¯å…¥ PDF åº•åœ–</div>
                    </div>
                    <input type="file" id="pdfFile" hidden accept=".pdf">
                    <button class="btn btn-danger btn-sm btn-block" id="clearBgBtn" style="margin-top:8px;display:none">æ¸…é™¤åº•åœ–</button>
                </div>

                <hr style="border:0;border-top:1px solid var(--border);margin:15px 0">
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;display:flex;justify-content:space-between">
                    <span>å¯ç”¨æ¬„ä½ (æ‹–æ›³è‡³ç•«å¸ƒ)</span>
                    <span id="fieldCount">0 æ¬„</span>
                </div>
                <div id="fieldList" style="min-height:100px;"></div>
            </div>

            <div id="tab2" class="tab-content">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn" onclick="addEl('text','æ–‡å­—æ¨™ç±¤')"><span class="material-symbols-outlined">text_fields</span> æ–‡å­—</button>
                    <button class="btn" onclick="addEl('title','å¤§æ¨™é¡Œ',null,null,null,null,24,'bold')"><span class="material-symbols-outlined">title</span> æ¨™é¡Œ</button>
                    <button class="btn" onclick="addEl('text','',50,50,200,2,12,'normal','#333','none')"><span class="material-symbols-outlined">horizontal_rule</span> æ©«ç·š</button>
                    <button class="btn" onclick="addEl('text','',50,50,2,100,12,'normal','#333','none')"><span class="material-symbols-outlined">vertical_line_col</span> ç›´ç·š</button>
                    <button class="btn" onclick="addEl('text','',50,50,100,100,12,'normal','transparent','2px solid #333')"><span class="material-symbols-outlined">check_box_outline_blank</span> çŸ©å½¢æ¡†</button>
                    <button class="btn" onclick="addEl('qrcode','QR',50,50,60,60)"><span class="material-symbols-outlined">qr_code_2</span> QR Code</button>
                </div>
                <div style="margin-top:20px">
                    <button class="btn btn-primary btn-block" onclick="openTableModal()">
                        <span class="material-symbols-outlined">table_chart</span> æ’å…¥æ™ºèƒ½è¡¨æ ¼
                    </button>
                    <p style="font-size:11px;color:#999;margin-top:8px">æ™ºèƒ½è¡¨æ ¼å¯è‡ªå‹•å»¶ä¼¸åˆ†é ï¼Œé©åˆæ˜ç´°åˆ—è¡¨ã€‚</p>
                </div>
            </div>

            <div id="tab3" class="tab-content">
                <div style="margin-bottom:15px">
                    <div style="font-weight:700;color:var(--text);margin-bottom:8px">è¼‰å…¥ç¯„ä¾‹</div>
                    <button class="btn btn-block" style="text-align:left;margin-bottom:5px" onclick="loadDemo('invoice')">ğŸ§¾ ä¸‰è¯å¼ç™¼ç¥¨</button>
                    <button class="btn btn-block" style="text-align:left;margin-bottom:5px" onclick="loadDemo('label')">ğŸ·ï¸ ç”¢å“æ¨™ç±¤ (Grid)</button>
                    <button class="btn btn-block" style="text-align:left;margin-bottom:5px" onclick="loadDemo('shipping')">ğŸšš å‡ºè²¨å–® (Group)</button>
                </div>
                <hr style="border:0;border-top:1px solid var(--border);margin:15px 0">
                 <div class="form-group">
                    <div class="upload-area" onclick="el('layoutFile').click()" style="padding:15px;border-color:#8b5cf6">
                         <span class="material-symbols-outlined" style="color:#8b5cf6">dashboard_customize</span>
                        <div style="font-size:12px;margin-top:4px">åŒ¯å…¥è¡¨æ ¼çµæ§‹ (JSON)</div>
                        <input type="file" id="layoutFile" hidden accept=".json">
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Center Canvas -->
        <div class="center-panel" id="centerPanel">
            <div class="canvas-container" id="canvasContainer">
                <div class="canvas canvas-bg-grid" id="canvas">
                    <div id="splitLine"></div>
                    <!-- Guides -->
                    <div id="guideX" class="guide-line guide-x"></div>
                    <div id="guideY" class="guide-line guide-y"></div>
                </div>
            </div>
            <!-- Floating Toolbar (Contextual) -->
            <div class="floating-toolbar" id="floatBar">
                <button class="btn btn-sm" onclick="duplicateEl()" title="è¤‡è£½"><span class="material-symbols-outlined">content_copy</span></button>
                <button class="btn btn-sm" onclick="toFront()" title="ä¸Šç§»ä¸€å±¤"><span class="material-symbols-outlined">arrow_upward</span></button>
                <button class="btn btn-sm" onclick="toBack()" title="ä¸‹ç§»ä¸€å±¤"><span class="material-symbols-outlined">arrow_downward</span></button>
                <button class="btn btn-sm btn-danger" onclick="deleteEl()" title="åˆªé™¤"><span class="material-symbols-outlined">delete</span></button>
            </div>
        </div>

        <!-- 4. Right Properties -->
        <div class="right-panel">
            <div class="props-header">å±¬æ€§è¨­å®š</div>
            <div class="props-content" id="propsPanel">
                <div style="text-align:center;color:var(--text-secondary);margin-top:50px;">
                    <span class="material-symbols-outlined" style="font-size:48px;opacity:0.5">edit_square</span>
                    <p style="margin-top:10px">è«‹é¸æ“‡ç•«å¸ƒä¸Šçš„å…ƒä»¶</p>
                    <p style="font-size:12px;margin-top:5px">æˆ–é»æ“Šç©ºç™½è™•è¨­å®šç‰ˆé¢</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals & Print -->
    <div class="modal-overlay" id="tableModal">
        <div class="modal">
            <h3 style="margin-bottom:15px">æ’å…¥è¡¨æ ¼</h3>
            <div class="form-group"><label class="form-label">æ¬„ä½æ•¸</label><input type="number" id="tCols" class="form-control" value="4"></div>
            <div class="form-group"><label class="form-label">é è¨­åˆ—æ•¸</label><input type="number" id="tRows" class="form-control" value="2"></div>
            <div style="display:flex;gap:10px;margin-top:20px">
                <button class="btn btn-block" onclick="el('tableModal').style.display='none'">å–æ¶ˆ</button>
                <button class="btn btn-primary btn-block" onclick="insertTable()">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    <div id="print-container"></div>

    <script>
    // --- 1. Global State & History Management ---
    const state = {
        config: { size: 'a4', orient: 'portrait', w: 210, h: 297, mode: 'single', splitY: 150, offX:0, offY:0, gC:2, gR:4, gX:5, gY:5 },
        elements: [],
        data: [],
        fields: [],
        selectedId: null,
        bgPdf: null
    };
    
    // History Stack
    const historyStack = [];
    let historyIndex = -1;
    let isUndoing = false;

    function saveState() {
        if(isUndoing) return;
        if (historyIndex < historyStack.length - 1) {
            historyStack.splice(historyIndex + 1);
        }
        const snap = JSON.stringify({ elements: state.elements, config: state.config });
        historyStack.push(snap);
        historyIndex++;
        if(historyStack.length > 50) { historyStack.shift(); historyIndex--; }
        updateUndoUI();
    }

    function undo() {
        if(historyIndex > 0) {
            isUndoing = true;
            historyIndex--;
            restoreState(historyStack[historyIndex]);
            isUndoing = false;
            updateUndoUI();
        }
    }

    function redo() {
        if(historyIndex < historyStack.length - 1) {
            isUndoing = true;
            historyIndex++;
            restoreState(historyStack[historyIndex]);
            isUndoing = false;
            updateUndoUI();
        }
    }

    function restoreState(json) {
        const parsed = JSON.parse(json);
        state.elements = parsed.elements;
        state.config = parsed.config;
        state.selectedId = null;
        renderAll();
        renderPageProps();
        updateUndoUI();
    }

    function updateUndoUI() {
        el('undoBtn').disabled = historyIndex <= 0;
        el('redoBtn').disabled = historyIndex >= historyStack.length - 1;
    }

    // --- 2. Helper Functions ---
    const el = id => document.getElementById(id);
    
    // --- 3. Initialization ---
    window.onload = () => {
        initCanvas();
        renderPageProps();
        saveState();
        
        document.addEventListener('keydown', (e) => {
            if((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
            if((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
            if(e.key === 'Delete' && state.selectedId) { deleteEl(); }
            if(state.selectedId && ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
                e.preventDefault();
                const elem = state.elements.find(x => x.id === state.selectedId);
                if(elem) {
                    const step = e.shiftKey ? 10 : 1;
                    if(e.key==='ArrowUp') elem.y -= step;
                    if(e.key==='ArrowDown') elem.y += step;
                    if(e.key==='ArrowLeft') elem.x -= step;
                    if(e.key==='ArrowRight') elem.x += step;
                    renderAll();
                    renderProps(elem);
                }
            }
        });
        
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
                b.classList.add('active');
                el(b.dataset.tab).classList.add('active');
            }
        });
    };

    function initCanvas() {
        updateCanvasSize();
        el('canvasContainer').addEventListener('mousedown', (e) => {
            if(e.target.id === 'canvasContainer' || e.target.id === 'canvas') {
                state.selectedId = null;
                renderAll();
                renderPageProps();
                el('floatBar').classList.remove('show');
            }
        });
        
        const spl = el('splitLine');
        spl.onmousedown = (e) => {
            e.preventDefault();
            const startY = e.clientY;
            const startTop = state.config.splitY;
            const mv = (ev) => {
                state.config.splitY = Math.max(0, startTop + (ev.clientY - startY));
                spl.style.top = state.config.splitY + 'px';
            };
            const up = () => { document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up); saveState(); };
            document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
        };
    }

    function updateCanvasSize() {
        const { size, orient, w, h } = state.config;
        const dims = { 'a4': [210, 297], 'a5': [148, 210], 'receipt80': [80, 297] };
        let [cw, ch] = dims[size] || [w, h];
        if(orient === 'landscape' && size !== 'receipt80') [cw, ch] = [ch, cw];
        state.config.w = cw; state.config.h = ch;
        
        const c = el('canvas');
        c.style.width = cw + 'mm';
        c.style.height = (size === 'receipt80' ? 'auto' : ch + 'mm');
        c.style.minHeight = (size === 'receipt80' ? '150mm' : '0');
    }

    // --- 4. Element Management ---
    function addEl(type, content, x=20, y=20, w=120, h=30, fs=12, fw='normal', bg='transparent', br='none') {
        const id = 'el-' + Math.random().toString(36).substr(2, 9);
        const elData = { id, type, content, x, y, width:w, height:h, fontSize:fs, fontWeight:fw, backgroundColor:bg, border:br };
        if(type === 'field') elData.fieldName = content;
        state.elements.push(elData);
        state.selectedId = id;
        renderAll();
        saveState();
        return id;
    }

    function renderAll() {
        const c = el('canvas');
        c.innerHTML = '';
        el('guideX').style.display = 'none'; el('guideY').style.display = 'none';
        c.appendChild(el('guideX')); c.appendChild(el('guideY'));
        c.appendChild(el('splitLine'));
        el('splitLine').style.display = state.config.mode === 'group' ? 'block' : 'none';
        el('splitLine').style.top = state.config.splitY + 'px';

        state.elements.forEach(item => {
            if(item.type === 'table') renderTable(item);
            else renderSimpleEl(item);
        });
        
        const sel = state.elements.find(e => e.id === state.selectedId);
        if(sel) {
            updateFloatBar(sel);
            renderProps(sel);
        }
    }

    function renderSimpleEl(item) {
        const div = document.createElement('div');
        div.className = 'canvas-element';
        if(state.selectedId === item.id) div.classList.add('selected');
        
        div.style.left = (item.x + state.config.offX) + 'px';
        div.style.top = (item.y + state.config.offY) + 'px';
        div.style.width = item.width + 'px';
        div.style.height = item.height + 'px';
        div.style.fontSize = item.fontSize + 'px';
        div.style.fontWeight = item.fontWeight;
        div.style.background = item.backgroundColor;
        div.style.border = item.border === 'none' && state.selectedId === item.id ? '1px dashed #ccc' : item.border;
        div.style.zIndex = state.selectedId === item.id ? 100 : 1;

        const val = item.type === 'field' ? `[${item.content}]` : item.content;
        div.innerHTML = `<div class="canvas-element-value" style="text-align:${item.textAlign||'left'}">${val}</div>`;
        
        if(state.selectedId === item.id) {
            ['se', 'e', 's'].forEach(p => {
                const h = document.createElement('div');
                h.className = `resize-handle rh-${p}`;
                h.onmousedown = (e) => { e.stopPropagation(); startDrag(e, item, p); };
                div.appendChild(h);
            });
        }

        div.onmousedown = (e) => { 
            e.stopPropagation(); 
            state.selectedId = item.id; 
            renderAll(); 
            startDrag(e, item, 'move'); 
        };
        el('canvas').appendChild(div);
    }

    // --- 5. Drag & Snap Logic ---
    function startDrag(e, item, mode) {
        const startX = e.clientX;
        const startY = e.clientY;
        const origX = item.x;
        const origY = item.y;
        const origW = item.width;
        const origH = item.height;
        
        const guideX = el('guideX');
        const guideY = el('guideY');

        const mv = (ev) => {
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;
            
            let newX = origX, newY = origY, newW = origW, newH = origH;

            if (mode === 'move') {
                newX = origX + dx;
                newY = origY + dy;
                const snap = calculateSnap(item, newX, newY);
                newX = snap.x; newY = snap.y;
                
                if(snap.gx !== null) { guideY.style.display='block'; guideY.style.left=(snap.gx+state.config.offX)+'px'; } else guideY.style.display='none';
                if(snap.gy !== null) { guideX.style.display='block'; guideX.style.top=(snap.gy+state.config.offY)+'px'; } else guideX.style.display='none';

                item.x = newX; item.y = newY;
            } else {
                if(mode.includes('e')) newW = Math.max(10, origW + dx);
                if(mode.includes('s')) newH = Math.max(10, origH + dy);
                item.width = newW; item.height = newH;
            }
            renderAll();
        };

        const up = () => {
            document.removeEventListener('mousemove', mv);
            document.removeEventListener('mouseup', up);
            guideX.style.display = 'none';
            guideY.style.display = 'none';
            saveState();
        };
        document.addEventListener('mousemove', mv);
        document.addEventListener('mouseup', up);
    }

    function calculateSnap(item, x, y) {
        const threshold = 5;
        let resX = x, resY = y, gx = null, gy = null;
        const myCx = x + item.width/2;
        const myCy = y + item.height/2;

        state.elements.forEach(other => {
            if(other.id === item.id) return;
            const ox = other.x, oy = other.y, ow = other.width, oh = other.height;
            const ocx = ox + ow/2, ocy = oy + oh/2;

            if(Math.abs(x - ox) < threshold) { resX = ox; gx = ox; }
            else if(Math.abs(x - (ox+ow)) < threshold) { resX = ox+ow; gx = ox+ow; }
            else if(Math.abs(myCx - ocx) < threshold) { resX = ocx - item.width/2; gx = ocx; }

            if(Math.abs(y - oy) < threshold) { resY = oy; gy = oy; }
            else if(Math.abs(y - (oy+oh)) < threshold) { resY = oy+oh; gy = oy+oh; }
            else if(Math.abs(myCy - ocy) < threshold) { resY = ocy - item.height/2; gy = ocy; }
        });
        return { x: resX, y: resY, gx, gy };
    }

    // --- 6. Table Rendering ---
    function openTableModal() { el('tableModal').style.display='flex'; }
    function insertTable() {
        const cols = parseInt(el('tCols').value)||3;
        const rows = parseInt(el('tRows').value)||2;
        const colNames = Array(cols).fill('').map((_,i)=>`æ¨™é¡Œ${i+1}`);
        const t = {
            id: 'tbl-'+Math.random().toString(36).substr(2,9), type:'table', x:20, y:60,
            columns: colNames, fields: Array(cols).fill(''),
            columnWidths: Array(cols).fill(80), columnAligns: Array(cols).fill('left'),
            rowHeight: 30, headerHeight: 35, fontSize: 12, headerBg:'#f1f5f9',
            headerBorder:'1px solid #000', cellBorder:'1px solid #ccc'
        };
        state.elements.push(t);
        if(rows>1) { state.config.mode='group'; el('splitLine').style.display='block'; }
        el('tableModal').style.display='none';
        renderAll(); saveState();
    }

    function renderTable(t) {
        const totalW = t.columnWidths.reduce((a,b)=>a+b,0);
        const totalH = t.headerHeight + t.rowHeight;
        
        const div = document.createElement('div');
        div.className = 'canvas-element table-element';
        if(state.selectedId === t.id) div.classList.add('selected');
        
        div.style.left = (t.x + state.config.offX) + 'px';
        div.style.top = (t.y + state.config.offY) + 'px';
        div.style.width = totalW + 'px';
        div.style.height = totalH + 'px';

        let html = `<div style="width:100%;height:100%">`;
        html += `<div style="display:flex;height:${t.headerHeight}px;">`;
        t.columns.forEach((c, i) => {
            html += `<div style="width:${t.columnWidths[i]}px; background:${t.headerBg}; border:${t.headerBorder}; padding:4px; font-weight:bold; font-size:${t.fontSize}px; overflow:hidden; position:relative;">${c}<div class="col-resizer" onmousedown="resizeCol(event, '${t.id}', ${i})" style="position:absolute;right:0;top:0;width:5px;height:100%;cursor:col-resize;opacity:0"></div></div>`;
        });
        html += `</div>`;
        html += `<div style="display:flex;height:${t.rowHeight}px;">`;
        t.fields.forEach((f, i) => {
             html += `<div class="drop-zone" data-tid="${t.id}" data-idx="${i}" style="width:${t.columnWidths[i]}px; border:${t.cellBorder}; padding:4px; font-size:${t.fontSize}px; color:#666; overflow:hidden;">[${f||'æ‹–æ›³æ¬„ä½'}]</div>`;
        });
        html += `</div></div>`;
        
        div.innerHTML = html;
        div.onmousedown = (e) => { 
            if(e.target.className.includes('resizer')) return;
            e.stopPropagation(); state.selectedId = t.id; renderAll(); startDrag(e, t, 'move'); 
        };
        
        div.querySelectorAll('.drop-zone').forEach(zone => {
            zone.ondragover = e => { e.preventDefault(); zone.style.background = '#e0e7ff'; };
            zone.ondragleave = e => { zone.style.background = 'transparent'; };
            zone.ondrop = e => {
                e.preventDefault(); e.stopPropagation();
                const field = e.dataTransfer.getData('field');
                if(field) {
                    t.fields[parseInt(zone.dataset.idx)] = field;
                    renderAll(); renderProps(t); saveState();
                }
            };
        });
        el('canvas').appendChild(div);
    }

    window.resizeCol = (e, tid, cIdx) => {
        e.stopPropagation();
        const t = state.elements.find(x=>x.id===tid);
        const startX = e.clientX;
        const startW = t.columnWidths[cIdx];
        const mv = (ev) => {
            t.columnWidths[cIdx] = Math.max(20, startW + (ev.clientX - startX));
            renderAll();
        };
        const up = () => { document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up); renderProps(t); saveState(); };
        document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
    };

    // --- 7. Properties Panel ---
    function renderPageProps() {
        el('propsPanel').innerHTML = `
            <div class="form-group"><label class="form-label">ç´™å¼µå°ºå¯¸</label>
                <select class="form-control" onchange="state.config.size=this.value; updateCanvasSize(); saveState();">
                    <option value="a4" ${state.config.size==='a4'?'selected':''}>A4</option>
                    <option value="a5" ${state.config.size==='a5'?'selected':''}>A5</option>
                    <option value="receipt80" ${state.config.size==='receipt80'?'selected':''}>80mm æ”¶æ“š</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">æ–¹å‘</label>
                <select class="form-control" onchange="state.config.orient=this.value; updateCanvasSize(); saveState();">
                    <option value="portrait" ${state.config.orient==='portrait'?'selected':''}>ç›´å‘</option>
                    <option value="landscape" ${state.config.orient==='landscape'?'selected':''}>æ©«å‘</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">è¼¸å‡ºæ¨¡å¼</label>
                <select class="form-control" onchange="state.config.mode=this.value; renderAll(); saveState();">
                    <option value="single" ${state.config.mode==='single'?'selected':''}>å–®é /å¥—æ‰“ (Single)</option>
                    <option value="group" ${state.config.mode==='group'?'selected':''}>æ¸…å–®/æ˜ç´° (Group)</option>
                    <option value="grid" ${state.config.mode==='grid'?'selected':''}>æ¨™ç±¤/å¤šæ¬„ (Grid)</option>
                </select>
            </div>
            ${state.config.mode === 'grid' ? `
            <div style="padding:10px;background:rgba(99,102,241,0.1);border-radius:6px;">
                 <div class="form-label">Grid è¨­å®š (æ¬„xåˆ—)</div>
                 <div style="display:flex;gap:5px;margin-bottom:5px">
                     <input type="number" class="form-control" placeholder="æ¬„" value="${state.config.gC}" onchange="state.config.gC=+this.value;saveState()">
                     <input type="number" class="form-control" placeholder="åˆ—" value="${state.config.gR}" onchange="state.config.gR=+this.value;saveState()">
                 </div>
            </div>` : ''}
            <div class="form-group" style="margin-top:10px"><label class="form-label">å…¨åŸŸåç§» (X, Y)</label>
                <div style="display:flex;gap:5px">
                    <input type="number" class="form-control" value="${state.config.offX}" onchange="state.config.offX=+this.value;renderAll();saveState()">
                    <input type="number" class="form-control" value="${state.config.offY}" onchange="state.config.offY=+this.value;renderAll();saveState()">
                </div>
            </div>
        `;
    }

    function renderProps(item) {
        let html = `<div style="margin-bottom:10px;font-weight:bold;color:var(--primary-light)">${item.type==='table'?'è¡¨æ ¼è¨­å®š':'å…ƒä»¶è¨­å®š'}</div>`;
        
        if(item.type !== 'table') {
            html += `
            <div class="form-group"><label class="form-label">å…§å®¹ (æˆ–æ¬„ä½å)</label>
                <input class="form-control" value="${item.content}" oninput="updateProp('${item.id}','content',this.value)">
            </div>
            <div class="form-group"><label class="form-label">å­—é«”å¤§å°</label>
                <input type="number" class="form-control" value="${item.fontSize}" oninput="updateProp('${item.id}','fontSize',+this.value)">
            </div>
            <div class="form-group"><label class="form-label">å°é½Š</label>
                <select class="form-control" onchange="updateProp('${item.id}','textAlign',this.value)">
                    <option value="left">é å·¦</option><option value="center">ç½®ä¸­</option><option value="right">é å³</option>
                </select>
            </div>
            <div style="display:flex;gap:5px">
                <div class="form-group"><label class="form-label">X</label><input type="number" class="form-control" value="${item.x}" onchange="updateProp('${item.id}','x',+this.value)"></div>
                <div class="form-group"><label class="form-label">Y</label><input type="number" class="form-control" value="${item.y}" onchange="updateProp('${item.id}','y',+this.value)"></div>
            </div>
            <div style="display:flex;gap:5px">
                <div class="form-group"><label class="form-label">å¯¬</label><input type="number" class="form-control" value="${item.width}" onchange="updateProp('${item.id}','width',+this.value)"></div>
                <div class="form-group"><label class="form-label">é«˜</label><input type="number" class="form-control" value="${item.height}" onchange="updateProp('${item.id}','height',+this.value)"></div>
            </div>
            `;
        } else {
            html += `
            <div class="form-group"><label class="form-label">åˆ—é«˜</label><input type="number" class="form-control" value="${item.rowHeight}" onchange="updateProp('${item.id}','rowHeight',+this.value)"></div>
            <div class="form-group"><label class="form-label">è¡¨é ­é«˜</label><input type="number" class="form-control" value="${item.headerHeight}" onchange="updateProp('${item.id}','headerHeight',+this.value)"></div>
            <div style="margin-top:10px;font-size:12px;color:#aaa">æ¬„ä½è¨­å®š</div>
            ${item.columns.map((c,i) => `
                <div style="background:rgba(255,255,255,0.05);padding:5px;margin-bottom:4px;border-radius:4px;">
                    <input class="form-control" style="font-size:11px;padding:2px;height:24px;margin-bottom:2px" value="${c}" onchange="updateTblCol('${item.id}',${i},this.value)">
                    <div style="font-size:11px;color:var(--primary)">ğŸ”— ${item.fields[i]||'æœªç¶å®š'}</div>
                </div>
            `).join('')}
            `;
        }
        el('propsPanel').innerHTML = html;
    }

    window.updateProp = (id, k, v) => {
        const el = state.elements.find(x => x.id === id);
        if(el) { el[k] = v; renderAll(); saveState(); }
    };
    window.updateTblCol = (id, idx, val) => {
        const el = state.elements.find(x => x.id === id);
        if(el) { el.columns[idx] = val; renderAll(); saveState(); }
    };

    function updateFloatBar(sel) {
        const bar = el('floatBar');
        const rect = { top: sel.y + state.config.offY, left: sel.x + state.config.offX + sel.width/2 };
        bar.style.top = (rect.top - 50) + 'px';
        bar.style.left = (rect.left + 40) + 'px';
        bar.classList.add('show');
    }

    window.duplicateEl = () => {
        const orig = state.elements.find(x => x.id === state.selectedId);
        if(orig) {
            const clone = JSON.parse(JSON.stringify(orig));
            clone.id = 'el-' + Math.random().toString(36).substr(2,9);
            clone.x += 20; clone.y += 20;
            state.elements.push(clone);
            state.selectedId = clone.id;
            renderAll(); saveState();
        }
    };
    window.deleteEl = () => {
        if(state.selectedId) {
            state.elements = state.elements.filter(x => x.id !== state.selectedId);
            state.selectedId = null;
            renderAll(); renderPageProps(); el('floatBar').classList.remove('show');
            saveState();
        }
    };
    window.toFront = () => { reorder(1); };
    window.toBack = () => { reorder(-1); };
    function reorder(dir) {
        const idx = state.elements.findIndex(x => x.id === state.selectedId);
        if(idx === -1) return;
        const item = state.elements.splice(idx, 1)[0];
        if(dir === 1) state.elements.push(item);
        else state.elements.unshift(item);
        renderAll(); saveState();
    }

    // --- 8. File & Data ---
    el('dataFile').onchange = (e) => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
            try {
                const txt = ev.target.result;
                state.data = f.name.endsWith('.json') ? JSON.parse(txt) : parseCSV(txt);
                state.fields = Object.keys(state.data[0]||{});
                renderFieldList();
                el('fileInfo').innerText = `âœ… å·²è¼‰å…¥ ${state.data.length} ç­†è³‡æ–™`;
            } catch(err) { alert('æ ¼å¼éŒ¯èª¤'); }
        };
        r.readAsText(f);
    };

    function parseCSV(csv) {
        const lines = csv.trim().split('\n');
        const headers = lines[0].split(',').map(x=>x.trim());
        return lines.slice(1).map(line => {
            const vals = line.split(',');
            return headers.reduce((acc, h, i) => ({...acc, [h]:vals[i]?.trim()}), {});
        });
    }

    function renderFieldList() {
        const c = el('fieldList'); c.innerHTML = '';
        el('fieldCount').innerText = `${state.fields.length} æ¬„`;
        state.fields.forEach(f => {
            const d = document.createElement('div');
            d.className = 'field-item';
            d.draggable = true;
            d.innerHTML = `<span class="material-symbols-outlined">data_object</span> ${f}`;
            d.ondragstart = (e) => {
                e.dataTransfer.setData('type', 'field');
                e.dataTransfer.setData('content', f);
                e.dataTransfer.setData('field', f);
            };
            c.appendChild(d);
        });
    }

    el('canvas').ondragover = e => e.preventDefault();
    el('canvas').ondrop = e => {
        e.preventDefault();
        const type = e.dataTransfer.getData('type');
        const content = e.dataTransfer.getData('content');
        if(type === 'field') {
            const rect = el('canvas').getBoundingClientRect();
            addEl('field', content, e.clientX - rect.left - state.config.offX, e.clientY - rect.top - state.config.offY);
        }
    };

    window.saveProject = () => {
        const json = JSON.stringify({ version: '8.0', config: state.config, elements: state.elements, dataSample: state.data.slice(0, 5), fields: state.fields }, null, 2);
        const blob = new Blob([json], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `project-${Date.now()}.prs`; a.click();
    };

    window.loadProject = () => el('projectFile').click();
    el('projectFile').onchange = e => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = ev => {
            try {
                const p = JSON.parse(ev.target.result);
                state.config = p.config; state.elements = p.elements; state.fields = p.fields || [];
                if(p.dataSample) state.data = p.dataSample;
                renderFieldList(); renderAll(); renderPageProps(); saveState();
                alert('å°ˆæ¡ˆè¼‰å…¥æˆåŠŸï¼');
            } catch(err) { alert('æª”æ¡ˆææ¯€'); }
        };
        r.readAsText(f);
    };

    // --- 9. Load Demo (Fixed & Complete) ---
    window.loadDemo = (type) => {
        if(!confirm('é€™å°‡è¦†è“‹ç•¶å‰ç•«å¸ƒï¼Œç¢ºå®šè¦è¼‰å…¥ç¯„ä¾‹å—ï¼Ÿ')) return;
        state.elements = [];
        
        if(type === 'invoice') {
            // ç™¼ç¥¨ (Group Mode)
            state.config = { size: 'a4', orient: 'portrait', w: 210, h: 297, mode: 'group', splitY: 160, offX:0, offY:0, gC:2, gR:4 };
            addEl('title', 'é›»å­è¨ˆç®—æ©Ÿçµ±ä¸€ç™¼ç¥¨', 200, 40, 300, 30, 24, 'bold', 'transparent');
            addEl('text', 'ç™¼ç¥¨è™Ÿç¢¼ï¼šAA-12345678', 40, 90, 200, 20);
            addEl('text', 'æ—¥æœŸï¼š2025-01-01', 500, 90, 200, 20);
            addEl('text', 'è²·å—äººï¼š', 40, 120, 60, 20, 12, 'bold');
            addEl('field', 'å®¢æˆ¶åç¨±', 100, 120, 200, 20, 12, 'normal', '#eee');
            
            // Insert Table for Invoice
            const t = {
                id: 'tbl-invoice', type:'table', x: 40, y: 170,
                columns: ['å“å','è¦æ ¼','æ•¸é‡','å–®åƒ¹','é‡‘é¡'], 
                fields: ['å“å','è¦æ ¼','æ•¸é‡','å–®åƒ¹','é‡‘é¡'],
                columnWidths: [200, 100, 60, 80, 80], columnAligns: ['left','left','center','right','right'],
                rowHeight: 30, headerHeight: 30, fontSize: 12, headerBg:'#eee', headerBorder:'2px solid #333', cellBorder:'1px solid #999'
            };
            state.elements.push(t);
            
            // Demo Data
            state.data = [
                {å®¢æˆ¶åç¨±:'ç¯„ä¾‹ç§‘æŠ€', å“å:'åŸå­ç­†', è¦æ ¼:'è—è‰²', æ•¸é‡:'10', å–®åƒ¹:'15', é‡‘é¡:'150'},
                {å®¢æˆ¶åç¨±:'ç¯„ä¾‹ç§‘æŠ€', å“å:'A4å½±å°ç´™', è¦æ ¼:'80ç£…', æ•¸é‡:'2', å–®åƒ¹:'450', é‡‘é¡:'900'}
            ];
        } 
        else if (type === 'label') {
            // æ¨™ç±¤ (Grid Mode)
            state.config = { size: 'a4', orient: 'portrait', w: 210, h: 297, mode: 'grid', splitY: 150, offX:0, offY:0, gC:2, gR:4, gX:10, gY:10 };
            addEl('text', '', 0, 0, 300, 200, 12, 'normal', 'transparent', '2px solid #ccc');
            addEl('title', 'ç”¢å“æ¨™ç±¤', 20, 20, 150, 30, 18, 'bold');
            addEl('text', 'å“å:', 20, 60, 50, 25, 12, 'bold');
            addEl('field', 'å“å', 70, 60, 200, 25, 14, 'bold', '#eee');
            addEl('text', 'åƒ¹æ ¼: $', 20, 100, 60, 25, 12, 'bold');
            addEl('field', 'åƒ¹æ ¼', 80, 100, 100, 25, 16, 'bold', 'transparent');
            addEl('qrcode', 'æ¢ç¢¼', 20, 140, 50, 50); // Using QR type as placeholder
            
            state.data = [
                {å“å:'ç„¡ç·šæ»‘é¼ ', åƒ¹æ ¼:'599', æ¢ç¢¼:'123456'}, {å“å:'æ©Ÿæ¢°éµç›¤', åƒ¹æ ¼:'2400', æ¢ç¢¼:'123457'},
                {å“å:'USB Hub', åƒ¹æ ¼:'350', æ¢ç¢¼:'123458'}, {å“å:'è¢å¹•æ”¯æ¶', åƒ¹æ ¼:'1200', æ¢ç¢¼:'123459'}
            ];
        } 
        else if (type === 'shipping') {
            // å‡ºè²¨å–® (Group Mode)
            state.config = { size: 'a4', orient: 'portrait', w: 210, h: 297, mode: 'group', splitY: 140, offX:0, offY:0, gC:2, gR:4 };
            addEl('title', 'å‡ºè²¨å–®', 20, 20, 200, 40, 24, 'bold');
            addEl('text', 'å®¢æˆ¶:', 20, 80, 50, 20);
            addEl('field', 'å®¢æˆ¶', 70, 80, 200, 20, 12, 'bold', '#eee');
            addEl('text', 'åœ°å€:', 20, 110, 50, 20);
            addEl('field', 'åœ°å€', 70, 110, 300, 20, 12, 'normal', '#eee');

            const t = {
                id: 'tbl-ship', type:'table', x: 20, y: 150,
                columns: ['å•†å“ç·¨è™Ÿ','å“å','æ•¸é‡'], 
                fields: ['ç·¨è™Ÿ','å“å','æ•¸é‡'],
                columnWidths: [100, 250, 80], columnAligns: ['left','left','center'],
                rowHeight: 30, headerHeight: 30, fontSize: 12, headerBg:'#e0e7ff', headerBorder:'1px solid #6366f1', cellBorder:'1px solid #ccc'
            };
            state.elements.push(t);
            
            state.data = [
                {å®¢æˆ¶:'å¼µä¸‰', åœ°å€:'å°åŒ—å¸‚ä¿¡ç¾©å€', ç·¨è™Ÿ:'P001', å“å:'ç­†è¨˜å‹é›»è…¦', æ•¸é‡:'1'},
                {å®¢æˆ¶:'å¼µä¸‰', åœ°å€:'å°åŒ—å¸‚ä¿¡ç¾©å€', ç·¨è™Ÿ:'A002', å“å:'æ»‘é¼ ', æ•¸é‡:'1'},
                {å®¢æˆ¶:'æå››', åœ°å€:'é«˜é›„å¸‚å‰é‡‘å€', ç·¨è™Ÿ:'B001', å“å:'éµç›¤', æ•¸é‡:'2'}
            ];
        }

        // Common Updates
        state.fields = Object.keys(state.data[0]||{});
        renderFieldList();
        renderAll();
        renderPageProps();
        saveState();
        
        // Auto switch to Data tab to show fields
        document.querySelector('[data-tab="tab1"]').click();
    };

    // --- 10. Print Logic ---
    el('printBtn').onclick = () => {
        const c = el('print-container'); c.innerHTML = '';
        const printData = state.data.length ? state.data : [state.fields.reduce((a,k)=>({...a,[k]:`(${k})`}),{})];
        
        const style = document.createElement('style');
        style.innerHTML = `@media print { @page { size: ${state.config.size==='custom'?'auto':state.config.size} ${state.config.orient}; } }`;
        c.appendChild(style);

        if(state.config.mode === 'group') {
            // Group Mode Logic
            const groupField = state.fields.find(f => f.includes('å®¢æˆ¶') || f.includes('å–®è™Ÿ')) || state.fields[0];
            const grouped = {};
            printData.forEach(r => { const k = r[groupField]||'ALL'; if(!grouped[k]) grouped[k]=[]; grouped[k].push(r); });
            
            Object.values(grouped).forEach(rows => {
                let page = createPage(); c.appendChild(page);
                // Header (Above Split)
                state.elements.filter(e => e.y < state.config.splitY).forEach(e => page.appendChild(createPrintEl(e, rows[0])));
                
                // Body (Below Split)
                let cy = state.config.splitY;
                const tbl = state.elements.find(e => e.type === 'table');
                
                if(tbl) {
                    // Print Table Header
                    const thead = createPrintRow(tbl, null, true);
                    thead.style.top = cy + 'px'; thead.style.left = (tbl.x + state.config.offX) + 'px';
                    page.appendChild(thead);
                    cy += tbl.headerHeight;
                    
                    rows.forEach(r => {
                        const rowEl = createPrintRow(tbl, r, false);
                        rowEl.style.top = cy + 'px'; rowEl.style.left = (tbl.x + state.config.offX) + 'px';
                        page.appendChild(rowEl);
                        cy += tbl.rowHeight;
                        
                        if(cy > (state.config.h*3.78) - 50) { // Page Break
                             page = createPage(); c.appendChild(page);
                             state.elements.filter(e => e.y < state.config.splitY).forEach(e => page.appendChild(createPrintEl(e, rows[0])));
                             cy = state.config.splitY;
                             const th = createPrintRow(tbl, null, true);
                             th.style.top = cy + 'px'; th.style.left = (tbl.x + state.config.offX) + 'px';
                             page.appendChild(th);
                             cy += tbl.headerHeight;
                        }
                    });
                }
            });
        } else if (state.config.mode === 'grid') {
            // Grid Mode Logic
            const { gC, gR, gX, gY } = state.config;
            let page = createPage(); let idx = 0;
            const itemW = state.elements.reduce((m,e)=>Math.max(m,e.x+e.width),0);
            const itemH = state.elements.reduce((m,e)=>Math.max(m,e.y+e.height),0);
            
            printData.forEach(r => {
                if(idx >= gC * gR) { page = createPage(); c.appendChild(page); idx = 0; }
                const col = idx % gC; const row = Math.floor(idx / gC);
                const offX = col * (itemW + gX) + 20; // 20 padding
                const offY = row * (itemH + gY) + 20;
                
                state.elements.forEach(e => {
                    const el = createPrintEl(e, r);
                    el.style.left = (e.x + offX + state.config.offX) + 'px';
                    el.style.top = (e.y + offY + state.config.offY) + 'px';
                    page.appendChild(el);
                });
                idx++;
            });
            c.appendChild(page);
        } else {
            // Single Mode
            printData.forEach(r => {
                const p = createPage();
                state.elements.forEach(e => p.appendChild(createPrintEl(e, r)));
                c.appendChild(p);
            });
        }
        setTimeout(() => window.print(), 500);
    };

    function createPage() {
        const d = document.createElement('div'); d.className = 'print-page';
        d.style.width = state.config.w + 'mm';
        d.style.height = state.config.size === 'receipt80' ? 'auto' : (state.config.h + 'mm');
        return d;
    }

    function createPrintEl(item, row) {
        if(item.type === 'table') return document.createElement('div'); // Handled separately
        const d = document.createElement('div'); d.className = 'print-element';
        d.style.left = (item.x + state.config.offX) + 'px'; d.style.top = (item.y + state.config.offY) + 'px';
        d.style.width = item.width + 'px'; d.style.height = item.height + 'px';
        d.style.fontSize = item.fontSize + 'px'; d.style.fontWeight = item.fontWeight;
        d.style.border = item.border; d.style.textAlign = item.textAlign || 'left';
        
        if(item.type === 'qrcode') {
             d.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${row[item.content]||'TEST'}" style="width:100%;height:100%">`;
        } else {
            d.innerText = item.type === 'field' ? (row[item.content]||'') : item.content;
        }
        return d;
    }

    function createPrintRow(t, row, isHeader) {
        const r = document.createElement('div');
        r.style.position = 'absolute'; r.style.display = 'flex';
        r.style.width = t.columnWidths.reduce((a,b)=>a+b,0) + 'px';
        
        t.columns.forEach((c, i) => {
            const d = document.createElement('div');
            d.style.width = t.columnWidths[i] + 'px';
            d.style.border = isHeader ? t.headerBorder : t.cellBorder;
            d.style.background = isHeader ? t.headerBg : 'transparent';
            d.style.fontSize = t.fontSize + 'px';
            d.style.padding = '4px'; d.style.boxSizing = 'border-box';
            d.style.textAlign = t.columnAligns[i] || 'left';
            d.style.height = (isHeader ? t.headerHeight : t.rowHeight) + 'px';
            d.innerText = isHeader ? c : (row[t.fields[i]] || '');
            r.appendChild(d);
        });
        return r;
    }

    // --- Legacy Support ---
    el('pdfFile').onchange = async (e) => {
        const f = e.target.files[0]; if(!f)return;
        const ab = await f.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(ab).promise;
        const page = await pdf.getPage(1);
        const vp = page.getViewport({scale:2.0});
        const cvs = document.createElement('canvas'); 
        cvs.width = vp.width; cvs.height = vp.height;
        await page.render({canvasContext:cvs.getContext('2d'), viewport:vp}).promise;
        el('canvas').style.backgroundImage = `url(${cvs.toDataURL()})`;
        el('canvas').style.backgroundSize = '100% 100%';
        el('clearBgBtn').style.display = 'block';
        el('clearBgBtn').onclick = () => { el('canvas').style.backgroundImage='none'; el('clearBgBtn').style.display='none'; }
    };
    el('layoutFile').onchange = e => {
        const f = e.target.files[0]; if(!f)return;
        const r = new FileReader();
        r.onload = ev => {
            const j = JSON.parse(ev.target.result);
            if(j.columns) {
                const scale = 3.78;
                const t = {
                    id: 'tbl-imp-'+Math.random(), type:'table', x: 20, y: 100,
                    columns: j.columns.map(c=>c.name||'C'), fields: j.columns.map(c=>c.name||''),
                    columnWidths: j.columns.map(c=>Math.max(20, (c.width||20)*scale)),
                    rowHeight:30, headerHeight:30, fontSize:12, headerBg:'#eee', columnAligns:j.columns.map(()=>'left'),
                    headerBorder:'1px solid #000', cellBorder:'1px solid #ccc'
                };
                state.elements.push(t);
                renderAll(); saveState();
                alert('çµæ§‹åŒ¯å…¥æˆåŠŸ');
            }
        };
        r.readAsText(f);
    };
</script>
</body>
</html>
