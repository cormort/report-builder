<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±è¡¨è¨­è¨ˆå™¨ - Report Designer Studio</title>
    <style>
        :root {
            --primary: #2186c4;
            --primary-hover: #1a6a9e;
            --bg: #f5f5f5;
            --surface: #ffffff;
            --text: #333333;
            --border: #e0e0e0;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            font-size: 14px;
        }
        .main-layout {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
        }
        .panel {
            background: var(--surface);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }
        /* å·¦å´é¢æ¿ - æ•¸æ“šä¸Šå‚³ */
        .left-panel {
            display: flex;
            flex-direction: column;
        }
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(33, 150, 243, 0.05);
        }
        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(33, 150, 243, 0.1);
        }
        .upload-area input {
            display: none;
        }
        .upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .field-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
        }
        .field-item {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: var(--bg);
            border-radius: 4px;
            cursor: move;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            user-select: none;
        }
        .field-item:hover {
            background: var(--primary);
            color: white;
        }
        .field-item.dragging {
            opacity: 0.5;
        }
        .field-icon {
            font-size: 14px;
        }
        /* ä¸­å¤®é¢æ¿ - ç•«å¸ƒ */
        .canvas-panel {
            grid-column: 2;
        }
        .canvas-wrapper {
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            overflow: auto;
            height: 600px;
            position: relative;
        }
        .canvas {
            width: 210mm;
            height: 297mm;
            margin: 20px auto;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            padding: 0;
            overflow: hidden;
        }
        .canvas-label {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            color: #999;
        }
        .canvas-element {
            position: absolute;
            cursor: move;
            padding: 10px;
            background: rgba(33, 150, 243, 0.1);
            border: 2px solid var(--primary);
            border-radius: 4px;
            min-width: 60px;
            min-height: 20px;
            transition: all 0.2s;
            resize: both;
            overflow: hidden;
            user-select: none;
            display: flex;
            align-items: center;
        }
        .canvas-element:hover {
            box-shadow: 0 0 8px rgba(33, 150, 243, 0.3);
        }
        .canvas-element.selected {
            border-color: var(--danger);
            box-shadow: 0 0 12px rgba(244, 67, 54, 0.4);
        }
        .canvas-element-value {
            font-size: inherit;
            color: inherit;
            font-weight: inherit;
            width: 100%;
            pointer-events: none;
        }
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: var(--primary);
            cursor: nwse-resize;
            border-radius: 2px;
        }
        /* å³å´é¢æ¿ - å±¬æ€§è¨­å®š */
        .right-panel {
            max-height: 600px;
            overflow-y: auto;
        }
        .property-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .property-group:last-child {
            border-bottom: none;
        }
        .property-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
        }
        .property-input, .property-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            margin-bottom: 8px;
        }
        .property-input:focus, .property-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 4px rgba(33, 150, 243, 0.2);
        }
        .color-picker {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .color-input {
            width: 50px;
            height: 36px;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
        }
        /* æŒ‰éˆ• */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--primary-hover);
        }
        .btn-secondary {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn-secondary:hover {
            background: #f0f0f0;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background: #d32f2f;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover {
            background: #388e3c;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        .btn-block {
            width: 100%;
        }
        /* åº•éƒ¨æŒ‰éˆ•æ¬„ */
        .footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        /* é è¦½æ¨¡å¼ */
        .preview-mode .canvas-element {
            cursor: auto;
            resize: none;
            background: transparent;
            border: 1px solid #e0e0e0;
        }
        .preview-mode .canvas-element:hover {
            box-shadow: none;
        }
        /* ä¿¡æ¯æç¤º */
        .message {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 13px;
        }
        .message.info {
            background: rgba(33, 150, 243, 0.1);
            color: #1565c0;
            border-left: 3px solid #1565c0;
        }
        .message.success {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            border-left: 3px solid #2e7d32;
        }
        .message.error {
            background: rgba(244, 67, 54, 0.1);
            color: #c62828;
            border-left: 3px solid #c62828;
        }
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .canvas-panel, .right-panel, .left-panel {
                grid-column: 1;
            }
        }

        /* ========== åˆ—å°å°ˆç”¨æ¨£å¼ (ä¿®æ­£å¾Œ) ========== */
        @media print {
            body {
                visibility: hidden;
                background: white;
            }
            .canvas, .canvas * {
                visibility: visible;
            }
            .canvas {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
                background: white;
                z-index: 9999;
            }
            .canvas-element {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                resize: none;
            }
            .canvas-label, .resize-handle {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š å ±è¡¨è¨­è¨ˆå™¨ - Report Designer Studio</h1>
            <p>ä¸Šå‚³ CSV/JSON æ•¸æ“šï¼Œæ‹–æ‹½æ¬„ä½åˆ°ç•«å¸ƒï¼Œè¨­å®šå±¬æ€§ï¼Œå³æ™‚é è¦½å’Œåˆ—å°</p>
        </div>

        <div class="main-layout">
            <div class="panel left-panel">
                <div class="panel-title">ğŸ“ æ•¸æ“šæº</div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“¤</div>
                    <p style="font-weight: 500; margin-bottom: 5px;">é»æ“Šæˆ–æ‹–æ”¾</p>
                    <p style="font-size: 12px; color: #999;">CSV æˆ– JSON æª”æ¡ˆ</p>
                    <input type="file" id="fileInput" accept=".csv,.json">
                </div>

                <div id="message" style="margin-bottom: 10px;"></div>

                <div class="panel-title" style="margin-top: 20px;">ğŸ·ï¸ å¯ç”¨æ¬„ä½</div>
                <div class="field-list" id="fieldList">
                    <div style="color: #999; text-align: center; padding: 20px; font-size: 13px;">
                        ä¸Šå‚³æª”æ¡ˆä»¥æŸ¥çœ‹æ¬„ä½
                    </div>
                </div>
            </div>

            <div class="panel canvas-panel">
                <div class="panel-title">ğŸ¨ è¨­è¨ˆç•«å¸ƒ</div>
                
                <div id="dataControls" style="display: none; margin-bottom: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; align-items: center; gap: 10px;">
                    <span style="font-weight: bold; color: #1565c0; font-size: 13px;">ğŸ“Š è³‡æ–™é è¦½ï¼š</span>
                    <button class="btn btn-secondary" id="prevDataBtn" style="padding: 4px 8px; font-size: 12px;">â—€ ä¸Šä¸€ç­†</button>
                    <span id="dataIndicator" style="font-size: 13px; min-width: 80px; text-align: center;">ç¬¬ 0 / 0 ç­†</span>
                    <button class="btn btn-secondary" id="nextDataBtn" style="padding: 4px 8px; font-size: 12px;">ä¸‹ä¸€ç­† â–¶</button>
                </div>

                <div style="margin-bottom: 15px; display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="addTextBtn">â• æ–‡å­—</button>
                    <button class="btn btn-secondary" id="addFieldBtn">ğŸ”— æ¬„ä½</button>
                    <button class="btn btn-secondary" id="addTitleBtn">ğŸ“Œ æ¨™é¡Œ</button>
                    <button class="btn btn-secondary" id="previewBtn">ğŸ‘ï¸ é è¦½</button>
                    <button class="btn btn-success" id="printBtn">ğŸ–¨ï¸ åˆ—å°</button>
                </div>

                <div class="canvas-wrapper">
                    <div class="canvas" id="canvas">
                        <div class="canvas-label">A4 (210Ã—297mm)</div>
                    </div>
                </div>
            </div>

            <div class="panel right-panel">
                <div class="panel-title">âš™ï¸ å±¬æ€§è¨­å®š</div>
                <div id="propertyPanel" style="text-align: center; color: #999; padding: 30px 0;">
                    é¸æ“‡ç•«å¸ƒä¸­çš„å…ƒç´ é€²è¡Œç·¨è¼¯
                </div>
            </div>
        </div>

        <div class="footer">
            <button class="btn btn-primary" id="saveBtn">ğŸ’¾ ä¿å­˜å ±è¡¨é…ç½®</button>
            <button class="btn btn-secondary" id="loadBtn">ğŸ“‚ è¼‰å…¥é…ç½®</button>
            <button class="btn btn-danger" id="clearBtn">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button>
        </div>
    </div>

    <script>
        // ============ å…¨å±€ç‹€æ…‹ ============
        const state = {
            fields: [],
            elements: [],
            selectedElement: null,
            previewMode: false,
            data: null,
            currentDataIndex: 0
        };

        // ============ DOM å…ƒç´  ============
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fieldList = document.getElementById('fieldList');
        const canvas = document.getElementById('canvas');
        const propertyPanel = document.getElementById('propertyPanel');
        const messageDiv = document.getElementById('message');
        
        // è³‡æ–™æ§åˆ¶å…ƒç´ 
        const dataControls = document.getElementById('dataControls');
        const prevDataBtn = document.getElementById('prevDataBtn');
        const nextDataBtn = document.getElementById('nextDataBtn');
        const dataIndicator = document.getElementById('dataIndicator');

        // ============ æ–‡ä»¶ä¸Šå‚³ ============
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFileUpload(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            handleFileUpload(e.target.files[0]);
        });

        function handleFileUpload(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let data = null;
                    const content = e.target.result;
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(content);
                    } else if (file.name.endsWith('.csv')) {
                        data = parseCSV(content);
                    } else {
                        throw new Error('ä¸æ”¯æŒçš„æª”æ¡ˆæ ¼å¼');
                    }
                    state.data = data;
                    state.currentDataIndex = 0;
                    extractFields(data);
                    
                    // é¡¯ç¤ºè³‡æ–™æ§åˆ¶åˆ—
                    if (state.data && state.data.length > 0) {
                        dataControls.style.display = 'flex';
                        updateDataIndicator();
                    }
                    
                    showMessage(`âœ… æˆåŠŸä¸Šå‚³ï¼å…± ${state.data.length} ç­†æ•¸æ“š`, 'success');
                } catch (error) {
                    showMessage(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const row = {};
                const values = lines[i].split(',');
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim() : '';
                });
                data.push(row);
            }
            return data;
        }

        function extractFields(data) {
            state.fields = [];
            if (Array.isArray(data) && data.length > 0) {
                state.fields = Object.keys(data[0]);
            } else if (typeof data === 'object') {
                state.fields = Object.keys(data);
            }
            renderFieldList();
        }

        function renderFieldList() {
            fieldList.innerHTML = state.fields.length === 0 
                ? '<div style="color: #999; text-align: center; padding: 20px; font-size: 13px;">æ²’æœ‰å¯ç”¨æ¬„ä½</div>'
                : state.fields.map(field => `
                    <div class="field-item" draggable="true" data-field="${field}">
                        <span class="field-icon">ğŸ“Š</span>
                        <span>${field}</span>
                    </div>
                `).join('');

            document.querySelectorAll('.field-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('text/plain', item.dataset.field);
                    item.classList.add('dragging');
                });
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
            });
        }

        // ============ è³‡æ–™åˆ‡æ›é‚è¼¯ ============
        function updateDataIndicator() {
            if (!state.data || state.data.length === 0) return;
            dataIndicator.textContent = `ç¬¬ ${state.currentDataIndex + 1} / ${state.data.length} ç­†`;
            if (state.previewMode) {
                applyDataToCanvas();
            }
        }

        prevDataBtn.addEventListener('click', () => {
            if (state.data && state.currentDataIndex > 0) {
                state.currentDataIndex--;
                updateDataIndicator();
            }
        });

        nextDataBtn.addEventListener('click', () => {
            if (state.data && state.currentDataIndex < state.data.length - 1) {
                state.currentDataIndex++;
                updateDataIndicator();
            }
        });

        // ============ ç•«å¸ƒæ“ä½œèˆ‡è³‡æ–™åˆä½µ ============
        let elementCounter = 0;

        function createCanvasElement(type, fieldName = null) {
            const id = `elem-${elementCounter++}`;
            const element = {
                id,
                type,
                fieldName,
                x: 20,
                y: 20 + state.elements.length * 30,
                width: 150,
                height: 30,
                fontSize: 14,
                fontWeight: 'normal',
                color: '#333333',
                backgroundColor: 'transparent',
                border: '1px solid #2186c4',
                content: type === 'text' ? 'æ–‡å­—å…§å®¹' : (type === 'title' ? 'å ±è¡¨æ¨™é¡Œ' : `[${fieldName || 'æ¬„ä½'}]`)
            };
            
            state.elements.push(element);
            renderElement(element);
            return element;
        }

        function renderElement(element) {
            const existing = document.getElementById(element.id);
            if (existing) existing.remove();

            const div = document.createElement('div');
            div.id = element.id;
            div.className = 'canvas-element';
            div.style.left = element.x + 'px';
            div.style.top = element.y + 'px';
            div.style.width = element.width + 'px';
            div.style.height = element.height + 'px';
            div.style.fontSize = element.fontSize + 'px';
            div.style.fontWeight = element.fontWeight;
            div.style.color = element.color;
            div.style.backgroundColor = element.backgroundColor;
            div.style.border = element.border;
            
            // å¦‚æœåœ¨é è¦½æ¨¡å¼ä¸”æ˜¯æ¬„ä½ï¼Œå˜—è©¦é¡¯ç¤ºçœŸå¯¦æ•¸æ“š
            let displayText = element.content;
            if (state.previewMode && element.type === 'field' && state.data && state.data.length > 0) {
                const currentRow = state.data[state.currentDataIndex];
                if (currentRow[element.fieldName] !== undefined) {
                    displayText = currentRow[element.fieldName];
                }
            }

            const content = document.createElement('div');
            content.className = 'canvas-element-value';
            content.textContent = displayText;
            div.appendChild(content);

            div.addEventListener('click', (e) => {
                e.stopPropagation();
                selectElement(element, div);
            });

            if (!state.previewMode) {
                makeDraggable(div, element);
                makeResizable(div, element);
            } else {
                div.classList.add('preview');
            }

            canvas.appendChild(div);
        }

        function applyDataToCanvas() {
            if (!state.data || state.data.length === 0) return;
            const currentRow = state.data[state.currentDataIndex];
            
            state.elements.forEach(el => {
                const domEl = document.getElementById(el.id);
                const textDiv = domEl.querySelector('.canvas-element-value');
                
                if (el.type === 'field' && el.fieldName) {
                    textDiv.textContent = currentRow[el.fieldName] !== undefined ? currentRow[el.fieldName] : '';
                } else {
                    textDiv.textContent = el.content;
                }
            });
        }

        function revertCanvasToDesign() {
            state.elements.forEach(el => {
                const domEl = document.getElementById(el.id);
                const textDiv = domEl.querySelector('.canvas-element-value');
                textDiv.textContent = el.content;
            });
        }

        function makeDraggable(element, dataElement) {
            let isDragging = false;
            let offsetX = 0, offsetY = 0;

            element.addEventListener('mousedown', (e) => {
                if (state.previewMode) return;
                if (e.target.classList.contains('resize-handle')) return;
                isDragging = true;
                offsetX = e.clientX - element.offsetLeft;
                offsetY = e.clientY - element.offsetTop;
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                dataElement.x = e.clientX - offsetX;
                dataElement.y = e.clientY - offsetY;
                element.style.left = dataElement.x + 'px';
                element.style.top = dataElement.y + 'px';
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        function makeResizable(element, dataElement) {
            const handle = document.createElement('div');
            handle.className = 'resize-handle';
            element.appendChild(handle);

            let isResizing = false;

            handle.addEventListener('mousedown', (e) => {
                if (state.previewMode) return;
                e.stopPropagation();
                isResizing = true;
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = element.offsetWidth;
                const startHeight = element.offsetHeight;

                const handleMove = (e) => {
                    if (!isResizing) return;
                    dataElement.width = Math.max(60, startWidth + (e.clientX - startX));
                    dataElement.height = Math.max(20, startHeight + (e.clientY - startY));
                    element.style.width = dataElement.width + 'px';
                    element.style.height = dataElement.height + 'px';
                };

                const handleUp = () => {
                    isResizing = false;
                    document.removeEventListener('mousemove', handleMove);
                    document.removeEventListener('mouseup', handleUp);
                };

                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', handleUp);
            });
        }

        function selectElement(element, domElement) {
            if (state.previewMode) return;
            document.querySelectorAll('.canvas-element.selected').forEach(el => {
                el.classList.remove('selected');
            });
            state.selectedElement = element;
            domElement.classList.add('selected');
            renderPropertyPanel(element);
        }

        canvas.addEventListener('click', () => {
            document.querySelectorAll('.canvas-element.selected').forEach(el => {
                el.classList.remove('selected');
            });
            state.selectedElement = null;
            propertyPanel.innerHTML = '<div style="text-align: center; color: #999; padding: 30px 0;">é¸æ“‡ç•«å¸ƒä¸­çš„å…ƒç´ é€²è¡Œç·¨è¼¯</div>';
        });

        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const fieldName = e.dataTransfer.getData('text/plain');
            
            if (fieldName && state.fields.includes(fieldName)) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const element = createCanvasElement('field', fieldName);
                element.x = x;
                element.y = y;
                
                const domElement = document.getElementById(element.id);
                domElement.style.left = element.x + 'px';
                domElement.style.top = element.y + 'px';
            }
        });

        // ============ æŒ‰éˆ•äº‹ä»¶ ============
        document.getElementById('addTextBtn').addEventListener('click', () => {
            createCanvasElement('text');
        });

        document.getElementById('addFieldBtn').addEventListener('click', () => {
            if (state.fields.length === 0) {
                showMessage('âŒ è«‹å…ˆä¸Šå‚³æ•¸æ“šæª”æ¡ˆ', 'error');
                return;
            }
            createCanvasElement('field', state.fields[0]);
        });

        document.getElementById('addTitleBtn').addEventListener('click', () => {
            createCanvasElement('title');
        });

        document.getElementById('previewBtn').addEventListener('click', () => {
            state.previewMode = !state.previewMode;
            const canvas = document.getElementById('canvas');
            const btn = document.getElementById('previewBtn');

            canvas.classList.toggle('preview-mode');
            
            if (state.previewMode) {
                btn.textContent = 'âœï¸ ç·¨è¼¯';
                // æ¸…é™¤é¸å–ç‹€æ…‹
                document.querySelectorAll('.canvas-element.selected').forEach(el => el.classList.remove('selected'));
                state.selectedElement = null;
                propertyPanel.innerHTML = '<div style="text-align: center; color: #999; padding: 30px 0;">é è¦½æ¨¡å¼ä¸å¯ç·¨è¼¯</div>';

                if (state.data) {
                    applyDataToCanvas();
                    showMessage('ğŸ‘ï¸ é è¦½æ¨¡å¼ï¼šé¡¯ç¤ºçœŸå¯¦è³‡æ–™', 'info');
                } else {
                    showMessage('âš ï¸ ç„¡æ•¸æ“šå¯é è¦½ï¼Œè«‹å…ˆä¸Šå‚³æª”æ¡ˆ', 'warning');
                }
            } else {
                btn.textContent = 'ğŸ‘ï¸ é è¦½';
                revertCanvasToDesign();
                // é‡æ–°æ¸²æŸ“ä»¥æ¢å¾©æ‹–æ›³åŠŸèƒ½
                state.elements.forEach(renderElement);
            }
        });

        document.getElementById('printBtn').addEventListener('click', () => {
            // åˆ—å°å‰å¼·åˆ¶åˆ‡æ›åˆ°ã€Œé è¦½æ¨¡å¼ã€
            if (!state.previewMode) {
                document.getElementById('previewBtn').click(); 
            }
            setTimeout(() => {
                window.print();
            }, 100);
        });

        document.getElementById('saveBtn').addEventListener('click', () => {
            const config = {
                fields: state.fields,
                elements: state.elements,
                timestamp: new Date().toISOString()
            };
            const json = JSON.stringify(config, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report-config-${Date.now()}.json`;
            a.click();
            showMessage('âœ… é…ç½®å·²ä¿å­˜', 'success');
        });

        document.getElementById('loadBtn').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const config = JSON.parse(e.target.result);
                            state.fields = config.fields;
                            state.elements = config.elements;
                            renderFieldList();
                            state.elements.forEach(renderElement);
                            showMessage('âœ… é…ç½®å·²è¼‰å…¥', 'success');
                        } catch (error) {
                            showMessage('âŒ è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm('ç¢ºèªæ¸…é™¤æ‰€æœ‰å…ƒç´ ï¼Ÿ')) {
                state.elements = [];
                state.selectedElement = null;
                document.querySelectorAll('.canvas-element').forEach(el => el.remove());
                propertyPanel.innerHTML = '<div style="text-align: center; color: #999; padding: 30px 0;">é¸æ“‡ç•«å¸ƒä¸­çš„å…ƒç´ é€²è¡Œç·¨è¼¯</div>';
                showMessage('âœ… å·²æ¸…é™¤', 'success');
            }
        });

        // ============ å±¬æ€§é¢æ¿ (å«é€æ˜åº¦ä¿®å¾©) ============
        function renderPropertyPanel(element) {
            const isTransparent = element.backgroundColor === 'transparent' || !element.backgroundColor;
            const safeBgColor = isTransparent ? '#ffffff' : element.backgroundColor;

            const html = `
                <div class="property-group">
                    <label class="property-label">å…ƒç´ é¡å‹</label>
                    <input type="text" readonly class="property-input" value="${element.type}">
                </div>
                ${element.type === 'field' ? `
                    <div class="property-group">
                        <label class="property-label">æ¬„ä½</label>
                        <select class="property-select" id="fieldSelect">
                            ${state.fields.map(f => `<option value="${f}" ${f === element.fieldName ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                    </div>
                ` : ''}
                <div class="property-group">
                    <label class="property-label">å…§å®¹</label>
                    <input type="text" class="property-input" id="contentInput" value="${element.content}">
                </div>
                <div class="property-group">
                    <label class="property-label">å­—é«”å¤§å° (px)</label>
                    <input type="number" class="property-input" id="fontSizeInput" value="${element.fontSize}" min="8" max="72">
                </div>
                <div class="property-group">
                    <label class="property-label">å­—é«”ç²—ç´°</label>
                    <select class="property-select" id="fontWeightSelect">
                        <option value="normal" ${element.fontWeight === 'normal' ? 'selected' : ''}>æ™®é€š</option>
                        <option value="bold" ${element.fontWeight === 'bold' ? 'selected' : ''}>ç²—é«”</option>
                    </select>
                </div>
                <div class="property-group">
                    <label class="property-label">æ–‡å­—é¡è‰²</label>
                    <div class="color-picker">
                        <input type="color" class="color-input" id="colorInput" value="${element.color}">
                        <span style="font-size: 12px; color: #999;">${element.color}</span>
                    </div>
                </div>
                <div class="property-group">
                    <label class="property-label">èƒŒæ™¯é¡è‰²</label>
                    <div class="color-picker">
                        <input type="color" class="color-input" id="bgColorInput" value="${safeBgColor}" ${isTransparent ? 'disabled' : ''}>
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                            <input type="checkbox" id="bgTransparentCheck" ${isTransparent ? 'checked' : ''}>
                            é€æ˜
                        </label>
                    </div>
                </div>
                <div class="property-group">
                    <button class="btn btn-danger btn-block" id="deleteBtn">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            `;
            
            propertyPanel.innerHTML = html;

            if (element.type === 'field') {
                document.getElementById('fieldSelect').addEventListener('change', (e) => {
                    element.fieldName = e.target.value;
                    element.content = `[${e.target.value}]`;
                    updateElement();
                });
            }

            document.getElementById('contentInput').addEventListener('change', (e) => {
                element.content = e.target.value;
                updateElement();
            });

            document.getElementById('fontSizeInput').addEventListener('change', (e) => {
                element.fontSize = parseInt(e.target.value);
                updateElement();
            });

            document.getElementById('fontWeightSelect').addEventListener('change', (e) => {
                element.fontWeight = e.target.value;
                updateElement();
            });

            document.getElementById('colorInput').addEventListener('input', (e) => {
                element.color = e.target.value;
                e.target.nextElementSibling.textContent = e.target.value;
                updateElement();
            });

            const bgColorInput = document.getElementById('bgColorInput');
            const bgTransparentCheck = document.getElementById('bgTransparentCheck');

            bgColorInput.addEventListener('input', (e) => {
                element.backgroundColor = e.target.value;
                bgTransparentCheck.checked = false;
                updateElement();
            });

            bgTransparentCheck.addEventListener('change', (e) => {
                if (e.target.checked) {
                    element.backgroundColor = 'transparent';
                    bgColorInput.disabled = true;
                } else {
                    element.backgroundColor = bgColorInput.value;
                    bgColorInput.disabled = false;
                }
                updateElement();
            });

            document.getElementById('deleteBtn').addEventListener('click', () => {
                state.elements = state.elements.filter(el => el.id !== element.id);
                document.getElementById(element.id).remove();
                state.selectedElement = null;
                propertyPanel.innerHTML = '<div style="text-align: center; color: #999; padding: 30px 0;">é¸æ“‡ç•«å¸ƒä¸­çš„å…ƒç´ é€²è¡Œç·¨è¼¯</div>';
                showMessage('âœ… å·²åˆªé™¤', 'success');
            });

            function updateElement() {
                renderElement(element);
                selectElement(element, document.getElementById(element.id));
            }
        }

        function showMessage(text, type = 'info') {
            messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        }
    </script>
</body>
</html>
