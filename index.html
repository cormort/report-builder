<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Report Studio v4.4 - PDF æ™ºæ…§åµæ¸¬ç‰ˆ</title>
    <!-- å¼•å…¥ PDF.js åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // è¨­å®š PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        :root {
            --primary: #2186c4; --primary-hover: #1a6a9e;
            --bg: #f0f2f5; --surface: #ffffff;
            --text: #333; --border: #dcdfe6;
            --success: #67c23a; --danger: #f56c6c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout */
        .header { background: #2b3a42; color: white; padding: 0 20px; height: 60px; display: flex; justify-content: space-between; align-items: center; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .panel { background: var(--surface); display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .left-panel { width: 280px; padding: 15px; overflow-y: auto; }
        .center-panel { flex: 1; background: #525659; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow: auto; }
        .right-panel { width: 320px; padding: 15px; overflow-y: auto; border-left: 1px solid var(--border); }
        .panel-title { font-size: 14px; font-weight: 700; color: #606266; margin-bottom: 12px; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        
        /* Upload & List */
        .upload-area { border: 2px dashed var(--border); padding: 15px; text-align: center; cursor: pointer; color: #909399; font-size: 13px; margin-bottom: 10px; transition:0.2s; }
        .upload-area:hover { border-color: var(--primary); background: #ecf5ff; }
        .field-item { padding: 6px 10px; background: #f4f4f5; border: 1px solid #e9e9eb; margin-bottom: 5px; cursor: grab; font-size: 12px; }
        
        .tpl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .btn-tpl { padding: 8px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 12px; text-align: center; border-radius: 4px; transition: 0.2s; }
        .btn-tpl:hover { border-color: var(--primary); color: var(--primary); background: #f0f9eb; font-weight: bold; }

        /* Canvas */
        .canvas-wrapper { box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: 0.3s; margin: auto; }
        .canvas {
            background: white; position: relative; overflow: hidden;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            /* é è¨­ç¶²æ ¼èƒŒæ™¯ï¼Œå¦‚æœæœ‰ PDF èƒŒæ™¯æœƒè¢«è¦†è“‹ */
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px; 
            transform-origin: top center;
        }
        .canvas-element {
            position: absolute; cursor: move; display: flex; align-items: center; overflow: hidden;
            border: 1px dashed #ccc; box-sizing: border-box;
        }
        .canvas-element.selected { border: 2px solid var(--primary); z-index: 100; background: rgba(33, 150, 243, 0.1); }
        .canvas-element-value { pointer-events: none; width: 100%; padding: 2px; }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: var(--primary); cursor: nwse-resize; display: none; }
        .canvas-element.selected .resize-handle { display: block; }
        
        #splitLine { position: absolute; left: 0; width: 100%; height: 0; border-top: 2px dashed #f56c6c; z-index: 90; cursor: ns-resize; display: none; }

        /* Controls */
        .form-group { margin-bottom: 10px; }
        .form-label { font-size: 12px; color: #666; display: block; margin-bottom: 3px; }
        .form-control { width: 100%; padding: 5px; border: 1px solid var(--border); font-size: 13px; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; color: white; background: #666; display: inline-flex; align-items: center; gap: 5px; justify-content: center; }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--success); } .btn-danger { background: var(--danger); }
        .btn-block { width: 100%; }

        #print-container { display: none; }
        @media print {
            @page { margin: 0; }
            body * { visibility: hidden; }
            #print-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; visibility: visible; z-index: 9999; }
            #print-container * { visibility: visible; }
            .print-page { position: relative; margin: 0 auto; background: white; page-break-after: always; break-after: page; overflow: hidden; }
            .print-element { position: absolute; display: flex; align-items: center; padding: 2px; }
            /* åˆ—å°æ™‚ç§»é™¤èƒŒæ™¯åœ–ï¼Œé™¤éä½ æƒ³å°å‡ºä¾† */
            .print-page { background-image: none !important; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="font-weight: bold;">ğŸ“Š Pro Report Studio v4.4 (PDF åµæ¸¬ç‰ˆ)</div>
        <div><button class="btn btn-success" id="printBtn">ğŸ–¨ï¸ åˆ—å° / åŒ¯å‡º PDF</button></div>
    </div>

    <div class="main-layout">
        <!-- LEFT PANEL -->
        <div class="panel left-panel">
            <div class="panel-title">1. åŒ¯å…¥èˆ‡åº•åœ–</div>
            <div class="upload-area" id="dataUploadBtn">ğŸ“‚ ä¸Šå‚³ CSV æ•¸æ“š<input type="file" id="dataFile" hidden accept=".csv,.json"></div>
            <div id="fileInfo" style="font-size:12px; color:#67c23a; margin-bottom:10px;"></div>
            
            <div class="upload-area" id="pdfUploadBtn" style="border-color:#2186c4; color:#2186c4;">
                ğŸ“„ åŒ¯å…¥ PDF åº•åœ–èˆ‡åµæ¸¬
                <input type="file" id="pdfFile" hidden accept=".pdf">
            </div>

            <div class="panel-title">2. å¿«é€Ÿæ¨¡ç‰ˆ</div>
            <div class="tpl-grid">
                <div class="btn-tpl" onclick="tpl('labels')">ğŸ·ï¸ æ¨™ç±¤è²¼ç´™</div>
                <div class="btn-tpl" onclick="tpl('tw_b2b')">ğŸ‡¹ğŸ‡¼ ä¸‰è¯å¼ç™¼ç¥¨</div>
                <div class="btn-tpl" onclick="tpl('tw_einvoice')">ğŸ§¾ é›»å­ç™¼ç¥¨</div>
                <div class="btn-tpl" onclick="tpl('table')">ğŸ“‘ é€šç”¨å ±è¡¨</div>
            </div>

            <div class="panel-title">3. å¯ç”¨æ¬„ä½</div>
            <div id="fieldList" style="min-height: 100px;"></div>
        </div>

        <!-- CENTER CANVAS -->
        <div class="panel center-panel">
            <div style="margin-bottom:10px; display:flex; gap:10px;">
                <button class="btn" style="background:white; color:#333" id="addTextBtn">â• æ–‡å­—</button>
                <button class="btn" style="background:white; color:#333" id="addTitleBtn">ğŸ“Œ æ¨™é¡Œ</button>
                <button class="btn" style="background:white; color:#333" id="addBoxBtn">â¬œ ç©ºæ¡†</button>
                <button class="btn btn-danger" id="clearBgBtn" style="display:none">ğŸ—‘ï¸ æ¸…é™¤èƒŒæ™¯</button>
            </div>
            <div class="canvas-wrapper">
                <div class="canvas" id="canvas" style="width:210mm; height:297mm;">
                    <div id="splitLine" style="top: 150px;"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT SETTINGS -->
        <div class="panel right-panel">
            <div class="panel-title">ğŸ“„ ç‰ˆé¢è¨­å®š</div>
            <div class="form-group">
                <label class="form-label">ç´™å¼µå¤§å°</label>
                <select class="form-control" id="pageSizeSelect">
                    <option value="a4">A4 (210 x 297 mm)</option>
                    <option value="a5">A5 (148 x 210 mm)</option>
                    <option value="letter">Letter</option>
                    <option value="receipt80">80mm æ”¶æ“š</option>
                    <option value="custom">è‡ªè¨‚ / PDF åŸå°ºå¯¸</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">æ–¹å‘</label>
                <select class="form-control" id="orientationSelect">
                    <option value="portrait">ç›´å‘</option>
                    <option value="landscape">æ©«å‘</option>
                </select>
            </div>

            <div class="panel-title" style="margin-top:10px">ğŸ–¨ï¸ åˆ—å°æ¨¡å¼</div>
            <div class="form-group">
                <select class="form-control" id="reportMode">
                    <option value="single">å–®é å–®ç­†</option>
                    <option value="group">åˆ†çµ„åˆ—è¡¨</option>
                    <option value="grid">ä¸€é å¤šå¼µ (æµ·å ±)</option>
                </select>
            </div>

            <!-- Settings: Grid Mode -->
            <div id="gridSettings" style="display:none; background:#ecf5ff; padding:8px; border-radius:4px;">
                <button class="btn btn-primary btn-block" style="margin-bottom:10px;" onclick="autoCalcGrid()">âœ¨ è‡ªå‹•è¨ˆç®—å¼µæ•¸</button>
                <div class="form-group"><label class="form-label">æ¬„ (Cols)</label><input type="number" class="form-control" id="gridCols" value="2"></div>
                <div class="form-group"><label class="form-label">åˆ— (Rows)</label><input type="number" class="form-control" id="gridRows" value="4"></div>
                <div class="form-group"><label class="form-label">é–“è· X/Y</label>
                    <div style="display:flex; gap:5px"><input type="number" class="form-control" id="gridGapX" value="10"><input type="number" class="form-control" id="gridGapY" value="10"></div>
                </div>
            </div>

            <!-- Settings: Group Mode -->
            <div id="groupSettings" style="display:none; background:#f0f9eb; padding:8px; border-radius:4px;">
                <div class="form-group"><label class="form-label">åˆ†çµ„æ¬„ä½</label><select class="form-control" id="groupFieldSelect"></select></div>
                <div class="form-group"><label class="form-label">åˆ†éš”ç·š Y</label><input type="number" class="form-control" id="splitYInput" value="150"></div>
                <div class="form-group"><label class="form-label">è¡Œé«˜</label><input type="number" class="form-control" id="rowHeightInput" value="30"></div>
            </div>

            <div class="panel-title" style="margin-top:20px">âœ¨ å…ƒç´ å±¬æ€§</div>
            <div id="propPanel" style="font-size:12px; color:#999; text-align:center; padding:10px;">é¸æ“‡å…ƒç´ ä»¥ç·¨è¼¯</div>
        </div>
    </div>

    <div id="print-container"></div>

        <script>
        // ==========================================
        // 1. å…¨å±€ç‹€æ…‹ (State)
        // ==========================================
        const state = {
            fields: [], elements: [], data: [], selectedElement: null,
            config: {
                pageSize: 'a4', orientation: 'portrait',
                widthMm: 210, heightMm: 297,
                mode: 'single', // single, group, grid
                groupField: '', splitY: 150, rowHeight: 30,
                gridCols: 2, gridRows: 4, gridGapX: 10, gridGapY: 10
            }
        };
    
        const els = {
            canvas: document.getElementById('canvas'),
            fieldList: document.getElementById('fieldList'),
            propPanel: document.getElementById('propPanel'),
            splitLine: document.getElementById('splitLine'),
            modeSelect: document.getElementById('reportMode'),
            sizeSelect: document.getElementById('pageSizeSelect'),
            orientSelect: document.getElementById('orientationSelect')
        };
    
        // åˆå§‹åŒ–åŸ·è¡Œ
        initCanvas();
        initDrag(); // ä¿®æ­£ï¼šç¾åœ¨ä¸‹æ–¹æœ‰å®šç¾©é€™å€‹å‡½å¼äº†ï¼Œä¸æœƒå†å ±éŒ¯
    
        // ==========================================
        // 2. ç•«å¸ƒèˆ‡ç´™å¼µè¨­å®š
        // ==========================================
        function initCanvas() {
            updateCanvasSize();
            els.sizeSelect.onchange = (e) => { state.config.pageSize = e.target.value; updateCanvasSize(); };
            els.orientSelect.onchange = (e) => { state.config.orientation = e.target.value; updateCanvasSize(); };
        }
    
        function updateCanvasSize() {
            const sizeMap = {
                'a4': [210, 297], 'a5': [148, 210], 'letter': [216, 279], 'receipt80': [80, 297]
            };
            let [w, h] = sizeMap[state.config.pageSize] || [state.config.widthMm, state.config.heightMm];
            
            // æ©«å‘è™•ç† (æ”¶æ“šèˆ‡è‡ªè¨‚é™¤å¤–)
            if (state.config.orientation === 'landscape' && state.config.pageSize !== 'receipt80' && state.config.pageSize !== 'custom') {
                [w, h] = [h, w];
            }
    
            state.config.widthMm = w;
            state.config.heightMm = h;
            
            els.canvas.style.width = w + 'mm';
            els.canvas.style.height = h + 'mm';
    
            if(state.config.pageSize === 'receipt80') {
                els.canvas.style.height = 'auto';
                els.canvas.style.minHeight = '150mm';
                els.canvas.style.borderBottom = '3px jagged #ccc';
            } else {
                els.canvas.style.borderBottom = 'none';
            }
        }
    
        // ==========================================
        // 3. PDF åŒ¯å…¥èˆ‡åµæ¸¬é‚è¼¯
        // ==========================================
        document.getElementById('pdfUploadBtn').onclick = () => document.getElementById('pdfFile').click();
        document.getElementById('pdfFile').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
    
            if(!confirm('æ˜¯å¦åŒ¯å…¥ PDFï¼Ÿ\n1. å°‡æ¸…é™¤ç•¶å‰ç•«å¸ƒ\n2. ç¬¬ä¸€é å°‡è¨­ç‚ºèƒŒæ™¯\n3. è‡ªå‹•åµæ¸¬æ–‡å­—æ¡†ç·š')) return;
    
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const page = await pdf.getPage(1);
                
                // 1. è¨­å®šèƒŒæ™¯ (è§£æåº¦ 1.5 å€ä»¥æ±‚æ¸…æ™°)
                const viewport = page.getViewport({ scale: 1.5 }); 
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                const bgDataUrl = canvas.toDataURL();
                
                // è½‰æ› PDF é»æ•¸ (pt) åˆ° æ¯«ç±³ (mm)
                // 1 pt = 0.352778 mm
                // Viewport width å·²ç¶“æ˜¯ scale éçš„ï¼Œæˆ‘å€‘è¦ç”¨åŸå§‹å°ºå¯¸ç®— mm
                const rawViewport = page.getViewport({ scale: 1.0 });
                const pdfW_mm = rawViewport.width * 0.352778; 
                const pdfH_mm = rawViewport.height * 0.352778;
                
                // è¨­å®šç•«å¸ƒå°ºå¯¸
                state.config.pageSize = 'custom';
                state.config.widthMm = pdfW_mm;
                state.config.heightMm = pdfH_mm;
                
                els.canvas.style.width = pdfW_mm + 'mm';
                els.canvas.style.height = pdfH_mm + 'mm';
                els.canvas.style.backgroundImage = `url(${bgDataUrl})`;
                els.canvas.style.backgroundSize = '100% 100%';
                
                document.getElementById('pageSizeSelect').value = 'custom';
                document.getElementById('clearBgBtn').style.display = 'inline-block';
    
                // æ¸…ç©ºèˆŠå…ƒç´ 
                state.elements = [];
                els.canvas.innerHTML = '<div id="splitLine"></div>';
    
                // 2. åµæ¸¬æ–‡å­—æ¡† (OCR-like)
                const textContent = await page.getTextContent();
                const pxToMm = 0.352778; 
    
                textContent.items.forEach(item => {
                    if (item.str.trim().length === 0) return;
    
                    // PDF åº§æ¨™è½‰æ›: åŸé»åœ¨å·¦ä¸‹ -> è½‰ç‚ºå·¦ä¸Š
                    const tx = item.transform[4];
                    const ty = item.transform[5];
                    
                    const x = tx * pxToMm;
                    const y = (rawViewport.height - ty - item.height) * pxToMm; 
                    const w = item.width * pxToMm;
                    const h = Math.max(item.height * pxToMm, 5);
    
                    // ç”¢ç”Ÿè—è‰²è™›ç·šæ¡†
                    addElement('text', '', x - 1, y - 1, w + 2, h + 2, 10, 'normal', 'transparent', '1px dashed #2186c4');
                });
    
                alert('âœ… PDF åŒ¯å…¥æˆåŠŸï¼è—è‰²è™›ç·šæ¡†ç‚ºåµæ¸¬åˆ°çš„æ–‡å­—å€åŸŸã€‚');
    
            } catch (err) {
                console.error(err);
                alert('âŒ PDF è§£æå¤±æ•—ï¼š' + err.message);
            }
        };
    
        document.getElementById('clearBgBtn').onclick = () => {
            els.canvas.style.backgroundImage = 'linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px)';
            els.canvas.style.backgroundSize = '20px 20px';
            document.getElementById('clearBgBtn').style.display = 'none';
        };
    
        // ==========================================
        // 4. è‡ªå‹•è¨ˆç®—ç‰ˆé¢ (Auto Grid)
        // ==========================================
        window.autoCalcGrid = () => {
            if(state.elements.length===0) return alert('ç•«å¸ƒæ˜¯ç©ºçš„');
            let mx=0,my=0; state.elements.forEach(e=>{mx=Math.max(mx,e.x+e.width);my=Math.max(my,e.y+e.height);});
            
            // 1mm = 3.78px
            const MM = 3.78;
            const pW = state.config.widthMm * MM;
            const pH = state.config.heightMm * MM;
            const margin = 5 * MM; // 5mm å®‰å…¨é‚Šè·
    
            const uW = pW - margin*2;
            const uH = pH - margin*2;
            const gX = state.config.gridGapX;
            const gY = state.config.gridGapY;
    
            const c = Math.floor((uW + gX) / (mx + gX));
            const r = Math.floor((uH + gY) / (my + gY));
    
            if(c < 1 || r < 1) return alert('å…§å®¹å¤ªå¤§ï¼Œç„¡æ³•æ”¾å…¥ç•¶å‰ç´™å¼µ');
    
            state.config.gridCols = c;
            state.config.gridRows = r;
            document.getElementById('gridCols').value = c;
            document.getElementById('gridRows').value = r;
            
            alert(`è¨ˆç®—å®Œæˆ: ${c}æ¬„ x ${r}åˆ— = ${c*r} å¼µ (å·²æ‰£é™¤å®‰å…¨é‚Šè·)`);
        };
    
        // ==========================================
        // 5. å¿«é€Ÿæ¨¡ç‰ˆ (Templates)
        // ==========================================
        window.tpl = (type) => {
            if(!confirm('æ¸…é™¤ç•«å¸ƒï¼Ÿ')) return;
            state.elements=[]; els.canvas.innerHTML='<div id="splitLine"></div>';
            
            if(type==='labels'){
                setPage('a4','portrait','grid');
                addElement('text','',0,0,300,180,12,'normal','transparent','2px solid #ccc');
                addElement('text','å“å:',10,50,50,25,12,'bold');
            }
            else if(type==='tw_b2b'){
                setPage('a4','portrait','group');
                addElement('title','çµ±ä¸€ç™¼ç¥¨',250,30,200,30,22,'bold');
                state.config.splitY=140;
                ['å“å','å–®åƒ¹'].forEach((h,i)=>addElement('text',h,40+i*100,115,100,25));
                updateSplitLine();
            }
            else if(type==='tw_einvoice'){
                setPage('receipt80','portrait','group');
                addElement('title','é›»å­ç™¼ç¥¨',30,20,150,30,18,'bold');
                state.config.splitY=100;
                updateSplitLine();
            }
            else if(type==='table'){
                setPage('a4','portrait','group');
                addElement('title','å ±è¡¨',20,20,200,40,24,'bold');
                state.config.splitY=80;
                updateSplitLine();
            }
        };
    
        function setPage(s,o,m){
            els.sizeSelect.value = state.config.pageSize = s;
            els.orientSelect.value = state.config.orientation = o;
            els.modeSelect.value = state.config.mode = m;
            updateCanvasSize();
            updateSettingsUI();
        }
    
        // ==========================================
        // 6. è¨­å®šé¢æ¿èˆ‡å…ƒç´  CRUD
        // ==========================================
        els.modeSelect.onchange=(e)=>{state.config.mode=e.target.value; updateSettingsUI();};
        
        function updateSettingsUI(){
            const m=state.config.mode;
            document.getElementById('groupSettings').style.display=m==='group'?'block':'none';
            document.getElementById('gridSettings').style.display=m==='grid'?'block':'none';
            els.splitLine.style.display=m==='group'?'block':'none';
        }
    
        ['gridCols','gridRows','gridGapX','gridGapY'].forEach(id=>document.getElementById(id).onchange=(e)=>state.config[id]=+e.target.value);
        document.getElementById('splitYInput').onchange=(e)=>{state.config.splitY=+e.target.value; updateSplitLine();};
        document.getElementById('rowHeightInput').onchange=(e)=>state.config.rowHeight=+e.target.value;
    
        document.getElementById('addTextBtn').onclick=()=>addElement('text','æ–‡å­—',20,20);
        document.getElementById('addTitleBtn').onclick=()=>addElement('title','æ¨™é¡Œ',20,20,150,40,20,'bold');
        document.getElementById('addBoxBtn').onclick=()=>addElement('text','',50,50,100,100,12,'normal','transparent','2px solid #333');
    
        function addElement(type,c,x,y,w=120,h=30,fs=14,fw='normal',bg='transparent',br='1px dashed #ccc'){
            const el={id:'el-'+Math.random().toString(36).substr(2,9),type,content:c,x,y,width:w,height:h,fontSize:fs,fontWeight:fw,backgroundColor:bg,border:br,fieldName:type==='field'?c:null};
            state.elements.push(el); renderEl(el); return el;
        }
    
        function renderEl(el){
            const d=document.createElement('div'); d.id=el.id; d.className='canvas-element'; updateElStyle(d,el);
            d.innerHTML=`<div class="canvas-element-value">${el.type==='field'?`[${el.content}]`:el.content}</div><div class="resize-handle"></div>`;
            
            d.onmousedown=(e)=>{
                if(e.target.classList.contains('resize-handle'))return;
                e.stopPropagation(); selectEl(el);
                const sx=e.clientX,sy=e.clientY,ox=el.x,oy=el.y;
                const mv=(ev)=>{el.x=ox+(ev.clientX-sx);el.y=oy+(ev.clientY-sy);updateElStyle(d,el);};
                const up=()=>{document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
                document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
            };
    
            d.querySelector('.resize-handle').onmousedown=(e)=>{
                e.stopPropagation();
                const sx=e.clientX,sy=e.clientY,ow=el.width,oh=el.height;
                const rz=(ev)=>{el.width=Math.max(10,ow+(ev.clientX-sx));el.height=Math.max(10,oh+(ev.clientY-sy));updateElStyle(d,el);renderProps(el);};
                const st=()=>{document.removeEventListener('mousemove',rz);document.removeEventListener('mouseup',st);};
                document.addEventListener('mousemove',rz);document.addEventListener('mouseup',st);
            };
            els.canvas.appendChild(d);
        }
    
        function updateElStyle(d,el){
            d.style.left=el.x+'px'; d.style.top=el.y+'px'; d.style.width=el.width+'px'; d.style.height=el.height+'px';
            d.style.fontSize=el.fontSize+'px'; d.style.fontWeight=el.fontWeight; d.style.background=el.backgroundColor; d.style.border=el.border;
        }
    
        function selectEl(el){
            state.selectedElement=el;
            document.querySelectorAll('.canvas-element').forEach(d=>d.classList.remove('selected'));
            document.getElementById(el.id).classList.add('selected');
            renderProps(el);
        }
    
        function renderProps(el){
            els.propPanel.innerHTML=`
                <div class="form-group"><label class="form-label">å…§å®¹</label><input class="form-control" value="${el.content}" oninput="setProp('${el.id}','content',this.value)"></div>
                <div class="form-group"><label class="form-label">å­—é«”å¤§å°</label><input type="number" class="form-control" value="${el.fontSize}" oninput="setProp('${el.id}','fontSize',this.value)"></div>
                <div class="form-group"><label class="form-label">èƒŒæ™¯è‰²</label><input type="color" style="width:100%" value="${el.backgroundColor==='transparent'?'#ffffff':el.backgroundColor}" oninput="setProp('${el.id}','backgroundColor',this.value)"></div>
                <div class="form-group"><label class="form-label">é‚Šæ¡†</label><select class="form-control" onchange="setProp('${el.id}','border',this.value)"><option value="none">ç„¡</option><option value="1px solid #000">å¯¦ç·š</option><option value="1px dashed #2186c4">è—è™›ç·š</option></select></div>
                <button class="btn btn-danger btn-block" onclick="delEl('${el.id}')">åˆªé™¤</button>`;
        }
    
        window.setProp=(id,k,v)=>{
            const el=state.elements.find(e=>e.id===id);
            if(el){el[k]=v; updateElStyle(document.getElementById(id),el); if(k==='content')document.getElementById(id).querySelector('.canvas-element-value').innerText=el.type==='field'?`[${v}]`:v;}
        };
        window.delEl=(id)=>{state.elements=state.elements.filter(e=>e.id!==id); document.getElementById(id).remove(); els.propPanel.innerHTML='';};
    
        // ==========================================
        // 7. æª”æ¡ˆèˆ‡æ‹–æ›³é‚è¼¯ (é€™å°±æ˜¯ä¹‹å‰å ±éŒ¯çš„éƒ¨åˆ†ï¼Œç¾åœ¨ä¿®å¾©äº†)
        // ==========================================
        document.getElementById('dataUploadBtn').onclick=()=>document.getElementById('dataFile').click();
        document.getElementById('dataFile').onchange=(e)=>{
            const f=e.target.files[0]; if(!f)return;
            const r=new FileReader();
            r.onload=(ev)=>{
                state.data=f.name.endsWith('.json')?JSON.parse(ev.target.result):parseCSV(ev.target.result);
                state.fields=Object.keys(state.data[0]||{});
                renderFields();
                document.getElementById('fileInfo').innerText=`âœ… ${state.data.length} ç­†æ•¸æ“š`;
            };
            r.readAsText(f);
        };
    
        function parseCSV(t){const [h,...r]=t.trim().split('\n'); const ks=h.split(',').map(s=>s.trim()); return r.map(l=>l.split(',').reduce((a,v,i)=>({...a,[ks[i]]:v.trim()}),{}));}
        function renderFields(){
            els.fieldList.innerHTML=state.fields.map(f=>`<div class="field-item" draggable="true" data-f="${f}">ğŸ“„ ${f}</div>`).join('');
            const sel=document.getElementById('groupFieldSelect');
            sel.innerHTML=`<option value="">--</option>`+state.fields.map(f=>`<option value="${f}">${f}</option>`).join('');
        }
    
        // â˜…â˜…â˜… ä¿®æ­£é»ï¼šè£œå› initDrag å‡½å¼å®šç¾© â˜…â˜…â˜…
        function initDrag() {
            els.fieldList.addEventListener('dragstart',e=>{
                e.dataTransfer.setData('type','field');
                e.dataTransfer.setData('val',e.target.dataset.f);
            });
            els.canvas.addEventListener('dragover',e=>e.preventDefault());
            els.canvas.addEventListener('drop',e=>{
                e.preventDefault();
                const t=e.dataTransfer.getData('type');
                if(t) addElement(t, e.dataTransfer.getData('val'), e.clientX-els.canvas.getBoundingClientRect().left, e.clientY-els.canvas.getBoundingClientRect().top);
            });
    
            let spd=false;
            els.splitLine.onmousedown=()=>spd=true;
            document.addEventListener('mousemove', (e)=>{
                if(spd){
                    state.config.splitY=Math.max(0, e.clientY-els.canvas.getBoundingClientRect().top);
                    updateSplitLine();
                    document.getElementById('splitYInput').value=Math.round(state.config.splitY);
                }
            });
            document.addEventListener('mouseup', ()=>spd=false);
        }
    
        function updateSplitLine(){els.splitLine.style.top=state.config.splitY+'px';}
    
        // ==========================================
        // 8. åˆ—å°æ ¸å¿ƒ
        // ==========================================
        document.getElementById('printBtn').onclick=()=>{
            const ctr=document.getElementById('print-container'); ctr.innerHTML='';
            // é è¦½åŠŸèƒ½ï¼šç„¡æ•¸æ“šæ™‚ç”¨å‡è³‡æ–™
            if(!state.data.length && state.elements.length){ 
                const dummy={}; state.fields.forEach(f=>dummy[f]=`(é è¦½${f})`); 
                var oldD=state.data; state.data=[dummy]; 
                runP(ctr); 
                state.data=oldD; return; 
            }
            if(!state.data.length)return alert('ç„¡æ•¸æ“š');
            runP(ctr);
        };
    
        function runP(ctr){
            const s=document.createElement('style');
            s.innerHTML=`@media print{@page{size:${state.config.pageSize==='custom'?'auto':state.config.pageSize} ${state.config.orientation};margin:0;}}`;
            ctr.appendChild(s);
            
            const m=state.config.mode;
            if(m==='single') pS(ctr);
            else if(m==='group') pG(ctr);
            else if(m==='grid') pGd(ctr);
            
            setTimeout(()=>{
                window.print();
                ctr.innerHTML='';
            },500);
        }
    
        function cP(){
            const d=document.createElement('div');
            d.className='print-page';
            d.style.width=state.config.widthMm+'mm';
            d.style.height=state.config.pageSize==='receipt80'?'auto':state.config.heightMm+'mm';
            return d;
        }
    
        function cE(el,r,dx=0,dy=0){
            const d=document.createElement('div'); d.className='print-element';
            const finalX = el.x+dx;
            const finalY = el.y+dy;
            d.style.left=finalX+'px'; d.style.top=finalY+'px';
            d.style.width=el.width+'px'; d.style.height=el.height+'px';
            d.style.fontSize=el.fontSize+'px'; d.style.fontWeight=el.fontWeight;
            d.style.background=el.backgroundColor; d.style.border=el.border;
            d.innerText=el.type==='field'&&r?(r[el.fieldName]||''):el.content;
            d.dataset.b = finalY + el.height;
            return d;
        }
    
        function pS(ctr){
            state.data.forEach(r=>{
                const p=cP();
                let mb=0;
                state.elements.forEach(e=>{
                    const el=cE(e,r); p.appendChild(el);
                    mb=Math.max(mb, +el.dataset.b);
                });
                if(state.config.pageSize==='receipt80') p.style.height=(mb+20)+'px';
                ctr.appendChild(p);
            });
        }
    
        function pG(ctr){
            const grp={}; const kf=state.config.groupField;
            state.data.forEach(r=>{const k=kf?r[kf]:'A';if(!grp[k])grp[k]=[];grp[k].push(r);});
            
            const hE=state.elements.filter(e=>e.y<state.config.splitY);
            const dE=state.elements.filter(e=>e.y>=state.config.splitY);
            dE.forEach(e=>e._oy=e.y-state.config.splitY);
            
            const pH=state.config.pageSize==='receipt80'?99999:1050;
            
            Object.values(grp).forEach(rs=>{
                let p=cP(); ctr.appendChild(p);
                let cm=0;
                const rh=()=>hE.forEach(e=>{
                    const el=cE(e,rs[0]); p.appendChild(el);
                    cm=Math.max(cm, +el.dataset.b);
                });
                rh();
                let y=state.config.splitY;
                rs.forEach(r=>{
                    if(y+state.config.rowHeight>pH){
                        p=cP(); ctr.appendChild(p); rh(); y=state.config.splitY; cm=y;
                    }
                    dE.forEach(e=>{
                        // æ‰‹å‹•è¨ˆç®—çµ•å°åº§æ¨™ä»¥é¿å…é«˜åº¦å¡Œé™·
                        const absY = y + (e.y - state.config.splitY);
                        const el=cE(e,r,0,0); // dx,dy è¨­0ï¼Œæ‰‹å‹•æŒ‡å®š top
                        el.style.top = absY + 'px';
                        p.appendChild(el);
                        cm=Math.max(cm, absY + e.height);
                    });
                    y+=state.config.rowHeight;
                });
                if(state.config.pageSize==='receipt80') p.style.height=(cm+50)+'px';
            });
        }
    
        function pGd(ctr){
            const {gridCols:gc, gridRows:gr, gridGapX:gx, gridGapY:gy}=state.config;
            let mx=0, my=0;
            state.elements.forEach(e=>{mx=Math.max(mx,e.x+e.width); my=Math.max(my,e.y+e.height);});
            
            const cellW=mx+gx, cellH=my+gy;
            // ä¿®æ­£ï¼šè‡ªå‹•ç½®ä¸­è¨ˆç®—
            const MM_TO_PX = 3.78;
            const pagePixelW = state.config.widthMm * MM_TO_PX;
            const pagePixelH = state.config.heightMm * MM_TO_PX;
            const totalContentW = (cellW * gc) - gx;
            const totalContentH = (cellH * gr) - gy;
            
            const startX = Math.max(20, (pagePixelW - totalContentW) / 2);
            const startY = Math.max(20, (pagePixelH - totalContentH) / 2);
    
            let p=cP(); ctr.appendChild(p); let i=0;
            state.data.forEach(r=>{
                if(i>=gc*gr){p=cP();ctr.appendChild(p);i=0;}
                const c=i%gc, rw=Math.floor(i/gc);
                const offsetX = startX + (c * cellW);
                const offsetY = startY + (rw * cellH);
                
                state.elements.forEach(el=>p.appendChild(cE(el,r,offsetX,offsetY)));
                i++;
            });
        }
    </script>
</body>
</html>
